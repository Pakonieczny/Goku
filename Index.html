<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Etsy Listing Generator & Shop Listings</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <!-- Import Google Material Icons and Materialize CSS -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Include PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <!-- Include piexifjs for EXIF manipulation -->
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.4/piexif.min.js"></script>
  <!-- Include SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
  <!-- Include CropperJS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      font-family: Arial, sans-serif;
      position: relative; /* anchor absolute children to the page */
    }
    .container {
      width: 100vw;
      padding: 10px;
      box-sizing: border-box;
      text-align: left;
    }
    h5, label, p {
      text-align: left;
    }
    input, textarea {
      width: 100%;
      box-sizing: border-box;
    }
    #descriptionAndFileUploadContainer {
      display: flex;
      align-items: center;
    }
    .listing-desc-container {
      position: relative;
      display: inline-block;
      width: 500px;
    }
    .listing-desc-container h5 {
      margin: 0 0 10px 0;
      font-size: 1.2rem;
      font-weight: 500;
    }
    .listing-desc-container label.section-heading {
      font-size: 1.2rem;
      font-weight: 500;
    }
    .listing-desc-container input {
      width: 500px;
      height: 30px;
      border: 1px solid #000;
      padding: 5px;
    }
    #searchKeyPhrases {
      resize: none;
      box-sizing: border-box;
      border: 1px solid grey;
    }
    #searchKeyPhrases[rows="14"] {
      height: auto;
    }
    /* Ensure the CSV textarea can receive drop events */
    #uploadedFilesList {
      pointer-events: auto;
    }
    .flex-container {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }
    .textbox-container {
      flex: 1;
    }
    .textbox-container textarea {
      width: 100%;
      padding: 0.8rem;
      font-size: 1rem;
      line-height: 1.2;
      resize: none;
      overflow: visible;
      box-sizing: border-box;
    }

    /* Config mode: show outlines and smooth movement */
    body.config-mode .configurable {
      outline: 2px dashed rgba(0,0,0,.45);
      transition: left .08s linear, top .08s linear, width .08s linear, height .08s linear;
    }
    .modal-overlay { transition: opacity .2s ease; }

    /* Config mode: lighten the sheet and let clicks pass through so previews are visible */
    body.config-mode .modal-overlay {
      opacity: 0.08 !important;
      pointer-events: none !important;
    }

    /* Ensure buttery movement while editing */
    body.config-mode .layout-abs,
    body.config-mode .configurable {
      will-change: left, top, width, height;
    }

    .button-container {
      width: 200px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-self: flex-start;
    }
    #listingTitle {
      min-height: 45px;
    }
    #listingDescInput {
      width: 500px;
      height: 30px;
      border: 1px solid #000;
      padding: 5px;
    }
    #listingDescription {
      min-height: 150px;
      width: 500px;
    }
    .section-heading {
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 5px;
      display: inline-block;
    }
    .count-text {
      font-style: italic;
      font-size: 0.9em;
      margin-top: 5px;
    }
    #dropZone {
      width: 712px;
      height: 120px;
      border: 2px dashed #ccc;
      border-radius: 3px;
      display: inline-block;
      vertical-align: middle;
      text-align: center;
      line-height: 120px;
      position: relative;
    }
    /* Hide any unused drop zones */
    #fileDropZonesContainer {
      display: none;
    }
    #uploadedFilesList {
      width: 225px;
      height: 125px;
      resize: none;
      box-sizing: border-box;
      border: 1px solid grey;
      margin-left: 85px;
      position: relative;
      font-size: 0.875rem;
      z-index: 10;
    }
    .modal {
      z-index: 9999 !important;
    }
    .modal-overlay {
      z-index: 9998 !important;
    }
    #previewGridContainer {
      position: relative;
      margin: 20px auto;
      width: auto;
      max-width: 720px;
      text-align: center;
      z-index: 2000;
    }
    #previewGridStatic {
      display: grid;
      grid-template-columns: repeat(5, 120px);
      grid-column-gap: 28px;
      grid-row-gap: 22px;
      margin: 0 auto;
    }
    .preview-cell {
      position: relative;
      width: 120px;
      height: 158px;
      border: 2px solid #ccc;
      border-radius: 3px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #666;
    }
    .preview-cell.reserved {
      z-index: 2500;
    }
    .preview-box {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .preview-box img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 3px;
      display: block;
    }
    .remove-btn {
      position: absolute;
      top: -5px;
      left: -5px;
      width: 15px;
      height: 15px;
      background-color: black;
      color: white;
      font-size: 10px;
      text-align: center;
      cursor: pointer;
      z-index: 999;
      border-radius: 50%;
    }
    .number-overlay {
      position: absolute;
      top: 0;
      right: 0;
      width: 16px;
      height: 16px;
      background-color: rgba(0,0,0,0.7);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      z-index: 999;
      border-radius: 3px;
    }
    .metadata-status {
      margin-top: 5px;
      text-align: center;
      font-size: 14px;
      min-height: 20px;
    }
    .metadata-progress {
      width: 90%;
    }
    /* Let JS absolute positioning take over; remove relative/negative offsets */
    #container13 {
      position: static;
      width: 250px;
      top: auto;
    }
    #belowSearch {
      margin-top: 0;
      margin-left: 0;
    }
    .title-container {
      margin-top: 0;
    }
    #etsyListingTitleContainer {
      position: static;
      width: 1000px;
    }
    #etsyListingTitleContainer textarea {
      width: 1000px;
    }
    .description-container {
      margin-top: 0px;
    }
    #etsyListingDescriptionContainer {
      position: static;
      width: 1000px;
    }
    #etsyListingDescriptionContainer textarea {
      width: 1000px;
    }
    #userProvidedKeyPhrasesContainer {
      position: static;
      top: auto;
      left: auto;
    }
    #topButtons {
      margin: 10px 0;
    }
    #listingQueueCount {
      width: 25px;
      height: 25px;
      border: 1px solid #000;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-left: 5px;
    }
    .regen-btn, .copy-btn {
      width: 125px;
    }
    .update-btn {
      background-color: #FFA500 !important;
      color: white !important;
    }
    .drag-over {
      border: 2px dashed #2196f3 !important;
    }
    /* Floating button style */
    #floatingViewFileBtn {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
    }
    /* Added to enable repositioning via the Configure Buttons modal */
    #etsyShopListingsContainer {
      position: relative;
    }

    /* Force the new absolute layout system to win over legacy/author CSS */
    .layout-abs { position: absolute !important; }

    /* Absolute layout stage: all configurable components live here */
    #layoutRoot {
      position: relative;
      width: 100vw;
      min-height: 200vh;
      z-index: 2500;
    }

    /* Neutralize wrapper layouts so children don't fight absolute placement */
    .neutralize-wrapper,
    #descriptionAndFileUploadContainer,
    #topButtons,
    #belowSearch,
    #etsyShopListingsContainer,
    #previewGridContainer,
    #previewGridStatic,
    .listing-desc-container,
    .flex-container,
    .title-container,
    .description-container {
      position: static !important;
      display: contents !important;
    }

  </style>
</head>
<body>
  <!-- Absolute layout stage (every component will be reparented here) -->
  <div id="layoutRoot"></div>
  <!-- Legacy uiPositions removed: new layout system is source of truth -->

  <button id="openConfigBtn" class="btn waves-effect waves-light configurable" style="margin-left:10px;">Open Config</button>
  
  <div id="descriptionAndFileUploadContainer">
    <div class="listing-desc-container" id="listingDescContainer">
      <h5>Listing Description</h5>
      <input id="listingDescInput" type="text" placeholder="Enter your question here">
    </div>
    <textarea id="uploadedFilesList" class="materialize-textarea" rows="2" placeholder="Drop CSV files here"></textarea>
  </div>
  
  <div id="topButtons">
    <button id="connectEtsyBtn" class="btn waves-effect waves-light configurable">Connect to Etsy</button>
    <button id="photoUploadNewBtn" class="btn waves-effect waves-light configurable update-btn" style="margin-left: 10px;">Update Photos</button>
    <button id="uploadToEtsyBtn" class="btn waves-effect waves-light configurable update-btn" style="margin-left: 10px;">Update Info</button>
    <div id="etsyShopListingsContainer">
      <div id="etsyShopListingsHeading" class="section-heading configurable">
        Etsy Shop Listings
        <span id="listingQueueCount">0</span>
      </div>
      <div class="textbox-container configurable">
        <textarea id="shopListings" class="materialize-textarea" rows="2" placeholder="Enter up to 250 comma-separated 10-digit listing IDs" style="width:500px;"></textarea>
      </div>
    </div>
  </div>
  
  <div class="phrases-header configurable" id="userProvidedKeyPhrasesContainer">
    <span id="searchKeyPhrasesHeading" class="section-heading configurable">Search Key Phrases</span>
    <!-- Clear button deletes files from the vector store -->
    <button id="clearKeyPhrasesBtn" class="btn-small waves-effect waves-light configurable">Clear CSV Files</button>
    <div id="dropZone" class="configurable">Image Drop</div>
    <button id="analyzeMetadataBtn" class="btn waves-effect waves-light configurable">Analyze Photos</button>
  </div>

  <div id="container13" class="flex-container configurable">
    <div class="textbox-container configurable">
      <textarea id="searchKeyPhrases" class="materialize-textarea" rows="14"></textarea>
    </div>
  </div>
  
  <div id="belowSearch">
    <button id="generateBtn" class="btn waves-effect waves-light configurable">Generate</button>
    <div class="title-container" id="etsyListingTitleContainer" style="margin-top: 0;">
      <div id="listingTitleHeading" class="section-heading configurable">Etsy Listing TITLE</div>
      <div class="flex-container configurable">
        <div class="textbox-container configurable">
          <textarea id="listingTitle" class="materialize-textarea" rows="2"></textarea>
        </div>
        <div class="button-container configurable">
          <button id="regenTitleBtn" class="btn-small waves-effect waves-light configurable regen-btn">Re-Gen</button>
          <button id="copyTitleBtn" class="btn-small waves-effect waves-light configurable copy-btn">
            <i class="material-icons">content_copy</i>
          </button>
        </div>
        <button id="showTitleRulesBtn" class="btn waves-effect waves-light rules-button configurable" data-target="titleRulesModal" style="display:none;">Title Rules</button>
      </div>
      <p id="titleCount" class="count-text configurable">Count: 0</p>
    </div>
    
    <div class="description-container" id="etsyListingDescriptionContainer" style="margin-top: 0px;">
      <div id="listingDescriptionHeading" class="section-heading configurable">Etsy Listing DESCRIPTION</div>
      <div class="flex-container configurable">
        <div class="textbox-container configurable">
          <textarea id="listingDescription" class="materialize-textarea"></textarea>
        </div>
        <div class="button-container configurable">
          <button id="regenDescriptionBtn" class="btn-small waves-effect waves-light configurable regen-btn">Re-Gen</button>
          <button id="copyDescriptionBtn" class="btn-small waves-effect waves-light configurable copy-btn">
            <i class="material-icons">content_copy</i>
          </button>
        </div>
        <button id="showDescriptionRulesBtn" class="btn waves-effect waves-light rules-button configurable" data-target="descriptionRulesModal" style="display:none;">Description Rules</button>
      </div>
    </div>
  </div>
  
  <div id="previewGridContainer">
    <div id="previewGridStatic">
      <div class="preview-cell" id="previewCell0">Empty</div>
      <div class="preview-cell" id="previewCell1">Empty</div>
      <div class="preview-cell" id="previewCell2">Empty</div>
      <div class="preview-cell" id="previewCell3">Empty</div>
      <div class="preview-cell" id="previewCell4">Empty</div>
      <div class="preview-cell" id="previewCell5">Empty</div>
      <div class="preview-cell" id="previewCell6">Empty</div>
      <div class="preview-cell reserved" id="previewCell7">Empty</div>
      <div class="preview-cell reserved" id="previewCell8">Empty</div>
      <div class="preview-cell reserved" id="previewCell9">Empty</div>
    </div>
  </div>
  
  <!-- Metadata Modal -->
  <div id="metadataModal" class="modal">
    <div class="modal-content">
      <h4>Photo Metadata</h4>
      <textarea id="metadataTextarea" readonly style="width:100%; height:300px;"></textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="closeMetadataBtn" class="modal-close waves-effect waves-green btn">Close</a>
    </div>
  </div>
  
  <!-- Analyze Rules Modal -->
  <div id="analyzeRulesModal" class="modal">
    <div class="modal-content">
      <h4>Photo Analysis Rules</h4>
      <textarea id="analyzeRulesTextarea" style="width:100%; height:300px;">
Default Photo Analysis Rules:
1. Use SEO-friendly descriptive long-tail key phrases without special characters, focus on describing the jewelry and charm pendant, also focus and tailor Key Phrases and description to appropriate client based on the type of jewelry.
2. Emphasize charm details, focus image description on the type of jewelry and pendant description (what it is, occasion, metal, size, style).
3. Never estimate or post any sizes or dimensions in the metadata 
3. Focus solely on the jewelry details especially the charm description.
4. Ignore environment, model, and clothing.
5. Organize into a short paragraph.
6. Limit the description to 200 characters.
7. Do not mention earrings unless explicitly identified.
8. Do not mix necklace and earring descriptions.
9. Be more to the point with  much less filler words and more jewelry and best fit client focused descriptions
10. Less narrative and story building with more focus on facts and details about the jewelry and charm to appeal to potential clients.        
      Descriptions of good fit between client needs and our offerings:  
      Example a. Soccer mom would have an appeal for a soccer ball necklace, or a team jersey.         
      Example b. A nurse would have an appeal for a stethoscope earrings, or syringe.        
      Example c. A bride with an upcoming wedding would also interested in birth flowers charm necklaces for her brides maids group present.  
      Example d. A university grad or sorority group would be interested in a pair of graduation cap earrings or necklace sets. 

      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateAnalyzeRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Title Rules Modal -->
  <div id="titleRulesModal" class="modal">
    <div class="modal-content">
      <h4>Title Rules</h4>
      <textarea id="titleRulesTextarea" style="width:100%; height:300px;">
Title Structure & Formatting:
- Titles MUST begin with the SAME TWO WORDS as in the Listing Description user input text box.
- Never begin any Listing Title with these words "Charm", "Necklace", "Earrings", "Studs", "Hoops"
- The second word in every Listing Title must be one of the following "Necklace", "Earrings", "Charm", "Studs", "Hoops". Look for the correct word in the user provided Listing Description text box. 
- If non of the following words "Necklace", "Earrings","Earring", "Necklaces" are in the "Listing Description" text box then refrain from using these words in the generated Listing Title
- Generate the Title Listing from 5-7 SEO Etsy optimized long-tail key phrases (2-5 words each) that flow dramatically as proper sentence.
- Product Type words (Examples: "Fish", "Tree", "Angel", "Volleyball", "Dolphin", "Penguin") must always come first.
- Ensure grammatical flow and no punctuation.

Word Usage & Frequency:
- No word may appear more than three times.
- "earrings" must be plural and follow a noun.
- The word" stud" can only be used if the word "earring" or "earrings" is present in the "Listing Description" text box.

Use of "For":
- "for" must appear at least twice in a grammatically correct manner as part of the Listing Title.

Title Length & Word Order:
- Titles must be between 125 and 140 characters.
- Adjectives must follow nouns.
- Avoid plurals for "stud" and "animal"; use plurals for "hoops" and "earrings" correctly.

SEO Optimization:
- The Listing Title should be comprised of at least seven optimized SEO Key Phrases that dramatically flow well together.

Prohibited Words:
- Exclude: "accessories", "unique", "simple", "minimalist", "whimsical", "cute", "filled", "gold filled", "silver", "solid gold", "gold vermeil", "rosegold", "14k", "handmade", "quirky", "delicate", "accessory", "for", "dangle", "gold plated", "jewelry", "custom", "celestial", "design", "lightweight".
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateTitleRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Description Rules Modal -->
  <div id="descriptionRulesModal" class="modal">
    <div class="modal-content">
      <h4>Description Rules</h4>
      <textarea id="descriptionRulesTextarea" style="width:100%; height:300px;">
Rules for Description:
- Merge the key phrases with your output.
- Modify the description to match the jewelry type.
- Keep the output paragraph to 80 words.

Option 1:
"This stunning gold Playing Card Charm is the perfect gift for her, featuring an intricately designed Ace of Spades charm. Ideal for jewelry lovers, this pendant is perfect for personalized pieces."

Option 2:
"This playful Allosaurus charm is the perfect add-on for charm necklaces or huggie hoops. It adds a whimsical touch to any collection, making it a delightful gift."

Option 3:
"This charming gold Alligator Necklace is a delightful gift for animal lovers. Featuring a beautifully designed crocodile pendant, it adds a unique touch to any collection."
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateDescriptionRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Keyword Rules Modal -->
  <div id="keywordRulesModal" class="modal">
    <div class="modal-content">
      <h4>Keyword Rules</h4>
      <textarea id="keywordRulesTextarea" style="width:100%; height:300px;">
Key Phrase Generation Using the .csv Sales Reports and .csv Product List Files:
- Generate exactly 13 tag phrases. 
- Each one of the 13 individual Key Phrases CAN NOT exceed a MAXIMUM of 20 characters including spaces, this must be STRICTLY adhered to above all other requirements.
- It's very important that you DO NOT GENERATE Key Phrases that are too similar to one another. Prioritize using unique key words to offer a wider gamut of possibilities, don't overuse the same word too many time in all 13 Key Phrases.
- The Key Phrases must be SEO friendly multi word phrases tailored for Etsy listing advertising.
- Using the attached Vector Store Etsy sales report files extrapolate the best tag phrases based on sales performance of individual listings.
- Correlate the Vector Store Etsy sales report of the top performing listings (Inclusive of Key Words and Key Phrases) with the user query from the Listing Description user input text box to generate statistically the most successful Key Phrases.
- Maximize the word count in every Key Phrase to capture more audiences as long as they do not exceed 20 characters long including spaces. 
- If the following words "Necklace", "Earrings","Earring", "Necklaces" are not present in the Listing Description user input text box then refrain from using these words in the generated Key Phrases
- Look for the following words in the Listing Description text box "Charm", "Necklace", "Earrings", "Studs", "Hoops".
- "Charm" must appear at least once in the generated Key Phrases.
- "Gift for Her" must appear at least once in the generated Key Phrases.
-Good examples of Listing Titles, focus on hey they flow and the Title structure, use these as templates for what a good Listing Title looks like:
    a. Trex Pendant Dinosaur Jewelry Mini Dino Necklace Gift for Her T-Rex Necklace Dainty Dinosaur Necklace Lover Gift Dinosaur Pendant
    b. Tennis Earrings Sports Earring Tennis Player Earrings Handmade Jewelry Sports Gifts Game Day Outfit Tennis Player Gift Custom Earring
    c. Megaphone Necklace Cheerleader Jewelry Gift for Her Cheer Team Charm Cheer Squad Gifts Cheer Coach Gift Cheerleader Necklace Senior Gifts
    d. Sea Turtle Necklace Cute Turtle Necklace Friend Gift Mother's Day Birthday Gift Turtle Gifts Cute Jewelry Quirky Jewelry
    e. Baseball Earrings Sports Fan Team Earrings College Gifts Baseball Mom Fun Earring Sports Team Gift Game Day Outfit Small Hoops
    f. Volleyball Necklace Sports Team Pendant Gift for Her Volleyball Jewelry Personalized Volleyball Mom Charm Sports Necklace Volleyball Coach
    g. Basketball Charm Necklace Gold Basketball Sports Jewelry Coach Gift Basketball Player Sports Pendant Basketball Gift for Her Basketball Mom
    h. Hummingbird Earrings Gold Bird Jewelry Gift for Her Mockingjay Stud Earrings Bird Lover Hummingbird Charm Jewelry Hunger Games Bird Earrings
 
- Exclude: "Gift for Him", "Statement Piece", "Unique", "Spiritual Gift", "Outdoor Style", "accessories", "simple", "minimalist", "whimsical", "cute", "filled", "gold filled", "silver", "Vibes", "solid gold", "gold vermeil", "rosegold", "14k", "handmade", "quirky", "delicate", "accessory", "for", "dangle", "gold plated", "jewelry", "custom", "celestial", "design", "lightweight", "Fine Chain Necklace", "Small", "Large", "Nice", "Long", "Dark", "Short", "and", "but", "light", "heavy", "Wanderlust", "Theme", "Minimal Chain Gift", "Tiny Pendant Chain", "Charm Look", "Charm Wear", "Chain Necklace", "Small Pendant Chain", "Everyday"
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateKeywordRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Crop Modal -->
  <div id="photoCropModal" class="modal" style="width:650px; height:650px;">
    <div class="crop-container" style="position: relative; width:100%; height:100%;">
      <h4 style="text-align:center; margin:0 0 10px 0;">Crop Photo</h4>
      <div class="img-preview-container" style="width:400px; height:400px; margin:0 auto; overflow:hidden;">
        <img id="cropImage" src="" alt="Crop Image" style="display:block; margin:auto; max-width:none;">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <button id="saveCropBtn" class="btn waves-effect waves-light" style="margin-right:10px;">Save</button>
        <button id="cancelCropBtn" class="btn waves-effect waves-light" style="background-color:#f44336;">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- New File Content Modal (to view CSV file content) -->
  <div id="fileContentModal" class="modal">
    <div class="modal-content">
      <h4>File Content</h4>
      <textarea id="fileContentModalText" style="width:100%; height:300px;" readonly></textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-green btn">Close</a>
    </div>
  </div>

  <!-- Layout Config Modal (mirrors shipping-1 flow) -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <h5>Configure Component Positions</h5>
      <table class="striped" id="configTable">
        <thead>
          <tr>
            <th>Component</th><th>Left</th><th>Top</th><th>Width</th><th>Height</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="modal-footer">
      <a id="resetLayoutBtn" class="waves-effect waves-red btn-flat">Reset</a>
      <a id="saveConfigBtn" class="modal-close waves-effect waves-green btn">Save</a>
    </div>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!-- Fallback: inline metadataHandler to avoid 404 while keeping the same API -->
  <script>
    window.metadataHandler = window.metadataHandler || (function(){
      /**
       * analyzeAndEmbedMetadata(i)
       * Minimal implementation:
       * - Generates a short alt/metadata string from the Listing Description or filename
       * - Stores it in window.photoMeta[i] so your upload calls use it as alt_text
       * - Updates the little status text under each preview cell
       */
      async function analyzeAndEmbedMetadata(i){
        try {
          const imgData = (window.previewImages && window.previewImages[i]) || null;
          if (!imgData) {
            if (window.M && M.toast) M.toast({ html: "No image in slot " + (i+1) });
            return;
          }
          const desc = (document.getElementById("listingDescInput")?.value || "").trim();
          const name = (window.photoNames?.[i] || "").replace(/\.[a-z0-9]+$/i, "");
          // Build a concise, SEO-ish line (max ~200 chars)
          const base = (desc || name || "Jewelry photo").replace(/\s+/g, " ").trim();
          const tag  = base.slice(0, 200);
          // Persist for your upload paths (used as alt_text later)
          window.photoMeta[i] = tag;
          // UI status tick
          const s = document.getElementById("metadataStatus" + i);
          if (s) s.textContent = "✓ tagged";
        } catch (e) {
          console.error("metadataHandler.analyzeAndEmbedMetadata error:", e);
          if (window.M && M.toast) M.toast({ html: "Metadata error: " + e.message });
        }
      }
      return { analyzeAndEmbedMetadata };
    })();
  </script>
  <script>
    // The temporary debug toast notifications have been removed.

    window.ETSY_SHOP_URL = "https://www.etsy.com/shop/custombrites";
    window.CLIENT_ID = "k75zdspz4r99txpqdji7i2em";
    window.REDIRECT_URI = "https://delicate-tanuki-616ac0.netlify.app/";
    window.modelName = "gpt-5";
    window.accessToken;
    window.soldOrdersCSV = [];
    window.listingsCSV = [];
    window.uploadedCSVFileIds = [];
    window.photoNames = [];
    window.previewImages = [];
    window.photoMeta = [];
    window.draggedIndex = null;
    window.photoIds = [];
    window.currentCropIndex = null;
    window.cropper = null;
    window.reservedPhotos = [];
    window.listingQueue = [];
    window.photoUpdateComplete = false;
    window.infoUpdateComplete = false;

    // ====== POSITION CONFIG (global, dynamic) ======
    window.configComponentIDs = [];

    /** Every interactive/visible control we want independently positionable */
    const AUTO_SELECTORS = [
      "button",        // all <button>
      "a.btn",         // Materialize anchors acting as buttons
      "input", "textarea", "select",
      "#dropZone",
      ".preview-cell", // each photo cell
      ".section-heading",
      "#listingQueueCount"
    ];

    function isExcluded(el){
      // do NOT move overlays or any modal internals (including the config modal itself)
      return el.closest("#configModal") || el.closest(".modal") || el.classList.contains("modal") || el.classList.contains("modal-overlay");
    }

    function ensureId(el){
      if (el.id) return el.id;
      const id = el.tagName.toLowerCase() + "-" + Math.random().toString(36).slice(2,7);
      el.id = id;
      return id;
    }

    function collectMovables(){
      const nodes = new Set();
      AUTO_SELECTORS.forEach(sel => {
        document.querySelectorAll(sel).forEach(n => { if (!isExcluded(n)) nodes.add(n); });
      });
      return Array.from(nodes);
    }

    // 3.2 Hard defaults — FULLY SPECIFIED per user map (all keys get a concrete value)
    const defaultPositions = {
      // Top controls
      openConfigBtn:           { left: 190,  top: 10,  width: 140, height: 35 },
      connectEtsyBtn:          { left: 10,   top: 10,  width: 160, height: 35 },
      photoUploadNewBtn:       { left: 600,  top: 10,  width: 160, height: 35 },
      uploadToEtsyBtn:         { left: 800,  top: 10,  width: 160, height: 35 },
      clearKeyPhrasesBtn:      { left: 1030, top: 10,  width: 120, height: 35 },
      analyzeMetadataBtn:      { left: 600,  top: 100, width: 160, height: 35 },

      // Generation controls
      generateBtn:             { left: 10,   top: 455, width: 125, height: 35 },
      regenTitleBtn:           { left: 285,  top: 492, width: 100, height: 35 },
      copyTitleBtn:            { left: 410,  top: 492, width: 100, height: 35 },
      showTitleRulesBtn:       { left: 150,  top: 0,   width: 0,   height: 0  },
      regenDescriptionBtn:     { left: 285,  top: 603, width: 100, height: 35 },
      copyDescriptionBtn:      { left: 410,  top: 603, width: 100, height: 35 },
      showDescriptionRulesBtn: { left: 150,  top: 0,   width: 0,   height: 0  },

      // Text inputs / areas
      listingDescInput:        { left: 10,   top: 220, width: 490, height: 35 },
      uploadedFilesList:       { left: 1083, top: 3,   width: 150, height: 35 },
      shopListings:            { left: 10,   top: 110, width: 500, height: 45 },
      searchKeyPhrases:        { left: 10,   top: 325, width: 500, height: 107 },
      listingTitle:            { left: 10,   top: 535, width: 1000,height: 45 },
      listingDescription:      { left: 10,   top: 540, width: 1400,height: 150 },

      // Drop zone
      dropZone:                { left: 1340, top: 150, width: 155, height: 350 },

      // Preview cells
      previewCell0:            { left: 600,  top: 150, width: 120, height: 158 },
      previewCell1:            { left: 750,  top: 150, width: 120, height: 158 },
      previewCell2:            { left: 900,  top: 150, width: 120, height: 158 },
      previewCell3:            { left: 1050, top: 150, width: 120, height: 158 },
      previewCell4:            { left: 1200, top: 150, width: 120, height: 158 },
      previewCell5:            { left: 600,  top: 340, width: 120, height: 158 },
      previewCell6:            { left: 750,  top: 340, width: 120, height: 158 },
      previewCell7:            { left: 900,  top: 340, width: 120, height: 158 },
      previewCell8:            { left: 1050, top: 340, width: 120, height: 158 },
      previewCell9:            { left: 1200, top: 340, width: 120, height: 158 },

      // Auto-assigned heading IDs (current session)
      etsyShopListingsHeading:   { left: 10,   top: 75,  width: 180, height: 27 },
      searchKeyPhrasesHeading:   { left: 10,   top: 290, width: 180, height: 27 },
      listingTitleHeading:       { left: 10,   top: 505, width: 180, height: 27 },
      listingDescriptionHeading: { left: 10,   top: 610, width: 250, height: 27 },

      // Counter chip
      listingQueueCount:       { left: 190,  top: 75,  width: 25,  height: 27 }
    };

    // (Shipping-1 stores to LS as pos-<id>-left|top|width|height and applies absolute layout.  [oai_citation:6‡shipping-1.html](file-service://file-UyzPx2tdaLoZi5ZZoE5Zq8))

    function adoptIntoLayoutRoot(el){
    const stage = document.getElementById("layoutRoot");
    if (!stage || !el || el.parentElement === stage) return;

    // Compute absolute document coordinates BEFORE moving
    const r = el.getBoundingClientRect();
    const L = Math.round(r.left + window.scrollX);
    const T = Math.round(r.top  + window.scrollY);
    const W = Math.round(r.width  || el.offsetWidth  || 0);
    const H = Math.round(r.height || el.offsetHeight || 0);

    stage.appendChild(el); // reparent to stage

    el.classList.add("layout-abs");
    el.classList.add("configurable"); // dashed outline in config-mode
    el.style.setProperty("position","absolute","important");
    el.style.setProperty("left",  L + "px","important");
    el.style.setProperty("top",   T + "px","important");
    el.style.setProperty("width", W + "px","important");
    el.style.setProperty("height",H + "px","important");
    el.style.setProperty("z-index","3000","important");
    // strip conflicting layout styles
    el.style.removeProperty("margin");
    el.style.removeProperty("margin-left");
    el.style.removeProperty("margin-top");
    el.style.removeProperty("right");
    el.style.removeProperty("bottom");
  }

  function initAbsoluteLayout(){
    const stage = document.getElementById("layoutRoot");
    if (!stage) return;

    const movables = collectMovables();
    window.configComponentIDs = [];
    movables.forEach(el => {
      const id = ensureId(el);
      window.configComponentIDs.push(id);
      adoptIntoLayoutRoot(el);
    });
    // de-dupe
    window.configComponentIDs = Array.from(new Set(window.configComponentIDs));
  }

    // Utility to get a safe numeric value
    function _num(v, fallback){ v = (v==null? "" : String(v)); var n = parseInt(v,10); return isFinite(n) ? n : fallback; }

    // Remove old wrapper positions/styles we no longer control
    function cleanupNestedConflicts(){
      ["descriptionAndFileUploadContainer","topButtons","belowSearch"].forEach(function(id){
        var el = document.getElementById(id);
        if (el){
          el.classList.remove("layout-abs");
          el.style.removeProperty("position");
          el.style.removeProperty("left");
          el.style.removeProperty("top");
          el.style.removeProperty("width");
          el.style.removeProperty("height");
        }
        ["left","top","width","height"].forEach(function(k){
          localStorage.removeItem("pos-"+id+"-"+k);
        });
      });
    }

    // ---- ID migration: preserve saved positions after renaming ephemeral IDs ----
    const ID_MIGRATIONS = {
      "div-0g0nl": "etsyShopListingsHeading",
      "span-yr8zb": "searchKeyPhrasesHeading",
      "div-89qwd": "listingTitleHeading",
      "div-0cwxn": "listingDescriptionHeading"
    };
    function migrateLocalStoragePositions(){
      Object.entries(ID_MIGRATIONS).forEach(([oldId, newId]) => {
        ["left","top","width","height"].forEach(k => {
          const oldKey = "pos-" + oldId + "-" + k;
          const newKey = "pos-" + newId + "-" + k;
          const val = localStorage.getItem(oldKey);
          if (val != null && localStorage.getItem(newKey) == null) {
            localStorage.setItem(newKey, val);
          }
          // Always clear the old keys so they won't clutter storage
          localStorage.removeItem(oldKey);
        });
      });
    }

    // 3.3 Apply saved (or default) positions — same storage keys as shipping-1
    function loadPositions(){
      const ids = window.configComponentIDs || [];
      for (var i=0; i<ids.length; i++){
        var id = ids[i];
        var el = document.getElementById(id);
        if(!el) continue;

        // If no hard default provided, seed from the live DOM so first-run layout is preserved.
        var rect = el.getBoundingClientRect();
        var seed = {
          left:  Math.round(rect.left + window.scrollX),
          top:   Math.round(rect.top  + window.scrollY),
          width: Math.round(rect.width  || el.offsetWidth  || 0),
          height:Math.round(rect.height || el.offsetHeight || 0)
        };
        var def = Object.assign(seed, defaultPositions[id] || {});

        var left = localStorage.getItem("pos-"+id+"-left");
        var top  = localStorage.getItem("pos-"+id+"-top");
        var w    = localStorage.getItem("pos-"+id+"-width");
        var h    = localStorage.getItem("pos-"+id+"-height");

        left = _num(left, def.left);
        top  = _num(top,  def.top);
        w    = _num(w,    def.width);
        h    = _num(h,    def.height);

        el.classList.add("layout-abs");
        el.classList.add("configurable"); // show dashed outline + transition in config-mode
        // Use !important to beat author styles and grid/flex side-effects
        el.style.setProperty("position", "absolute", "important");
        el.style.setProperty("left",    left + "px", "important");
        el.style.setProperty("top",     top  + "px", "important");
        el.style.setProperty("width",   ((w>0 ? w : def.width)) + "px", "important");
        el.style.setProperty("height",  ((h>0 ? h : def.height)) + "px", "important");
        // NEW: ensure absolute layout isn't visually offset/hidden
        el.style.removeProperty("margin");
        el.style.removeProperty("margin-left");
        el.style.removeProperty("margin-top");
        el.style.removeProperty("right");
        el.style.removeProperty("bottom");
        el.style.setProperty("z-index", "3000", "important");
      }
    }

    function populateConfigTable(){
      var tbody = document.getElementById("configTable").querySelector("tbody");
      tbody.innerHTML = "";
      const ids = window.configComponentIDs || [];
      for (var i=0; i<ids.length; i++){
        var id = ids[i];
        var el = document.getElementById(id);
        if(!el) continue;

        // Seed exactly like loadPositions(): DOM rect → merged with hard defaults
        var rect = el.getBoundingClientRect();
        var seed = {
          left:  Math.round(rect.left + window.scrollX),
          top:   Math.round(rect.top  + window.scrollY),
          width: Math.round(rect.width  || el.offsetWidth  || 0),
          height:Math.round(rect.height || el.offsetHeight || 0)
        };
        var def = Object.assign(seed, defaultPositions[id] || {});

        // Prefer saved values if present
        var left = _num(localStorage.getItem("pos-"+id+"-left"),   def.left);
        var top  = _num(localStorage.getItem("pos-"+id+"-top"),    def.top);
        var w    = _num(localStorage.getItem("pos-"+id+"-width"),  def.width);
        var h    = _num(localStorage.getItem("pos-"+id+"-height"), def.height);

        var tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td><input id="left_${id}"   type="number" value="${left}"  style="width:90px"></td>
          <td><input id="top_${id}"    type="number" value="${top}"   style="width:90px"></td>
          <td><input id="width_${id}"  type="number" value="${w}"     style="width:90px"></td>
          <td><input id="height_${id}" type="number" value="${h}"     style="width:90px"></td>
        `;
        tbody.appendChild(tr);
        // Live preview while editing numbers (input/change/keyup/mousewheel)
        ["left","top","width","height"].forEach(function(k){
          var inp = document.getElementById(k + "_" + id);
          if (inp) {
            const handler = function(){ previewFromInputs(id); };
            ["input","change","keyup","mousewheel"].forEach(evt => inp.addEventListener(evt, handler));
          }
        });
      }
    }

    /* --- absolute layout helpers --- */
    function applySinglePosition(id, left, top, width, height) {
      const el = document.getElementById(id);
      if (!el) return;

      const cs = window.getComputedStyle(el);
      const curL = parseInt(cs.left, 10)    || el.offsetLeft  || 0;
      const curT = parseInt(cs.top, 10)     || el.offsetTop   || 0;
      const curW = parseInt(cs.width, 10)   || el.offsetWidth || 0;
      const curH = parseInt(cs.height, 10)  || el.offsetHeight|| 0;

      const L = Number.isFinite(+left)  ? +left  : curL;
      const T = Number.isFinite(+top)   ? +top   : curT;
      const W = Number.isFinite(+width) ? +width : curW;
      const H = Number.isFinite(+height)? +height: curH;

      el.classList.add("layout-abs");
      el.style.setProperty("position", "absolute", "important");
      el.style.setProperty("left",  L + "px", "important");
      el.style.setProperty("top",   T + "px", "important");
      el.style.setProperty("width", W + "px", "important");
      el.style.setProperty("height",H + "px", "important");
      el.style.setProperty("z-index","3000","important");

      // Ensure nothing "fights" absolute placement
      el.style.removeProperty("margin");
      el.style.removeProperty("margin-left");
      el.style.removeProperty("margin-top");
      el.style.removeProperty("right");
      el.style.removeProperty("bottom");
    }

    function previewFromInputs(id) {
      const l = document.getElementById("left_"   + id)?.value;
      const t = document.getElementById("top_"    + id)?.value;
      const w = document.getElementById("width_"  + id)?.value;
      const h = document.getElementById("height_" + id)?.value;
      applySinglePosition(id, parseInt(l,10), parseInt(t,10), parseInt(w,10), parseInt(h,10));
    }

    function forceApplyPositions() {
      // Apply now, after modal close animation, and once more after paint
      requestAnimationFrame(() => {
        if (typeof loadPositions === "function") loadPositions();
        setTimeout(() => { if (typeof loadPositions === "function") loadPositions(); }, 180);
      });
    }

    // 3.5 Wire up modal + save handler (same ids as shipping-1)
    document.addEventListener("DOMContentLoaded", function(){
      localStorage.removeItem("buttonPositions"); // purge legacy store once
      // Cleanup old wrapper keys, adopt EVERY control into the absolute stage, then apply layout
      cleanupNestedConflicts();
      initAbsoluteLayout();      // discover, assign IDs, reparent to #layoutRoot
      migrateLocalStoragePositions(); // move saved positions from old random IDs to new stable IDs
      loadPositions();           // apply saved/default positions to all

        var configModal = M.Modal.init(document.getElementById("configModal"), {
        onOpenStart() {
          document.body.classList.add("config-mode");
          // So you can see layout changes behind the modal
          setTimeout(() => {
            const ov = document.querySelector(".modal-overlay");
            if (ov) ov.style.opacity = "0.15";
          }, 0);
        },
        onCloseEnd() {
          document.body.classList.remove("config-mode");
          const ov = document.querySelector(".modal-overlay");
          if (ov) ov.style.opacity = "";
        }
      });
      var openBtn = document.getElementById("openConfigBtn");
      if (openBtn){
        openBtn.addEventListener("click", function(){
          populateConfigTable(); // shipping-1 builds table on open.  [oai_citation:8‡shipping-1.html](file-service://file-UyzPx2tdaLoZi5ZZoE5Zq8)
          configModal.open();
        });
      }

      var resetBtn = document.getElementById("resetLayoutBtn");
      if (resetBtn){
        resetBtn.addEventListener("click", function(){
          const ids = window.configComponentIDs || [];
          ids.forEach(id => ["left","top","width","height"].forEach(k => localStorage.removeItem("pos-"+id+"-"+k)));
          if (window.M && M.toast) M.toast({ html: "All positions reset." });
          requestAnimationFrame(() => { if (typeof loadPositions === "function") loadPositions(); });
        });
      }

      var saveBtn = document.getElementById("saveConfigBtn");
      if (saveBtn){
        saveBtn.addEventListener("click", function(){
          const ids = window.configComponentIDs || [];
          for (var i=0; i<ids.length; i++){
            var id = ids[i];
            var el = document.getElementById(id);
            if(!el) continue;

            var cs = window.getComputedStyle(el);
            var left = _num(document.getElementById("left_"+id)?.value,
                            _num(localStorage.getItem("pos-"+id+"-left"),  parseInt(cs.left)||el.offsetLeft||0));
            var top  = _num(document.getElementById("top_"+id)?.value,
                            _num(localStorage.getItem("pos-"+id+"-top"),   parseInt(cs.top)||el.offsetTop||0));
            var w    = _num(document.getElementById("width_"+id)?.value,
                            _num(localStorage.getItem("pos-"+id+"-width"), parseInt(cs.width)||el.offsetWidth||0));
            var h    = _num(document.getElementById("height_"+id)?.value,
                            _num(localStorage.getItem("pos-"+id+"-height"),parseInt(cs.height)||el.offsetHeight||0));

            if (left!=null) localStorage.setItem("pos-"+id+"-left",  left);
            if (top!=null)  localStorage.setItem("pos-"+id+"-top",   top);
            if (w!=null)    localStorage.setItem("pos-"+id+"-width", w);
            if (h!=null)    localStorage.setItem("pos-"+id+"-height",h);

            // Live preview (with margin strip + high z-index)
            if (typeof applySinglePosition === "function") {
              applySinglePosition(id, left, top, w, h);
            } else {
              // Fallback if applySinglePosition() isn't present
              el.classList.add("layout-abs");
              el.classList.add("configurable"); // ensure outline/transition are active
              el.style.setProperty("position", "absolute", "important");
              el.style.setProperty("left",  L + "px", "important");
              el.style.setProperty("top",   T + "px", "important");
              el.style.setProperty("width", W + "px", "important");
              el.style.setProperty("height",H + "px", "important");

              // show above page content while configuring, but still under the modal content
              const z = document.body.classList.contains("config-mode") ? 10050 : 3000;
              el.style.setProperty("z-index", String(z), "important");
              el.style.removeProperty("margin");
              el.style.removeProperty("margin-left");
              el.style.removeProperty("margin-top");
              el.style.removeProperty("right");
              el.style.removeProperty("bottom");
            }
          }

          // Apply everything once after persisting
          if (typeof forceApplyPositions === "function") forceApplyPositions();

          if (window.M && M.toast) M.toast({ html: "Layout saved and applied." });

          // Re-assert once more after modal animates closed
          requestAnimationFrame(loadPositions);
        });
      }
    });

    window.appendedDescriptionText = `

----------------------------------

D E T A I L S 
Materials: 
 •  Sterling Silver
 •  14k Gold Filled
 •  14K Rose Gold Filled 
 •  14K Solid Gold

• We use the Highest Quality materials from the US and Italy.
• Your purchase will come packaged in a lovely Jewelry Box

-----------------------------------

P A C K A G I N G
• Your purchase will come beautifully packaged. If you are ordering for a gift and would like each piece to be packaged separately please let me know. 

• If this purchase is a gift, and you would like us to include a handwritten message, leave a note in the "gift message" box at checkout.

------------------------------------

E X P E D I T E D • S H I P P I N G
You will be able to choose faster shipping options in the drop down menu when you check out. Ship times do NOT include production times (1-3 business days). However, if you select expedited shipping, we will try to get your order done faster.

------------------------------------

E X P L O R E • O U R • S H O P
Don't forget to check out the rest of our shop! We specialize in making handmade custom jewelry for every occasion. We take pride in making sure each order is made exactly to the customers specifications. We love collaborating with our customers to create  special and unique pieces for themselves and their loved ones. Please don't hesitate to contact us with any questions you have.  

http://custombrites.etsy.com

-----------------------------------

C H E C K • U S • O U T
Make sure you follow us on all our social media platforms to get a behind the scenes look, special promo codes, and some daily inspiration :) 

Instagram: https://www.instagram.com/britesjewelry
Facebook: https://www.facebook.com/britesjewelry
Pinterest Page : https://www.pinterest.com/britesjewelry

------------------------------------

S H O P  • P O L I C I E S
Check out our shop polices page for more details about all our polices and please don't hesitate to contact us with any questions you have! Happy Shopping :)

https://www.etsy.com/shop/CustomBrites/policy"

https://www.etsy.com/your/shops/me/listing-editor/edit/1822973998
`;

    // On persistDataBeforeRedirect, store current queue to local storage.
    function persistDataBeforeRedirect() {
      try {
        localStorage.setItem("soldOrdersCSV", JSON.stringify(window.soldOrdersCSV));
        localStorage.setItem("listingsCSV", JSON.stringify(window.listingsCSV));
        const listingsInputValue = document.getElementById("shopListings").value || "";
        localStorage.setItem("shopListingsText", listingsInputValue);
        localStorage.setItem("listingQueue", JSON.stringify(window.listingQueue));
      } catch (err) {
        console.error("Error persisting data before redirect:", err);
      }
    }

    // Show metadata in modal
    function showMetadata(index) {
      const metadata = (window.photoMeta && window.photoMeta[index]) 
                         ? window.photoMeta[index] 
                         : "No metadata available.";
      document.getElementById("metadataTextarea").value = metadata;
      let modalElem = document.getElementById("metadataModal");
      let modalInstance = M.Modal.getInstance(modalElem) || M.Modal.init(modalElem);
      modalInstance.open();
    }

    // CSV Drop Listener for uploadedFilesList element
    const csvDropZone = document.getElementById("uploadedFilesList");
    csvDropZone.addEventListener("dragover", e => {
      e.preventDefault();
      e.stopPropagation();
      csvDropZone.style.borderColor = "#000";
    });
    csvDropZone.addEventListener("dragleave", e => {
      e.preventDefault();
      e.stopPropagation();
      csvDropZone.style.borderColor = "#ccc";
    });
    csvDropZone.addEventListener("drop", async e => {
      e.preventDefault();
      e.stopPropagation();
      csvDropZone.style.borderColor = "#ccc";
      const files = e.dataTransfer.files;
      for (let file of files) {
        if (/\.csv$/i.test(file.name)) {
          try {
            const fileData = await uploadDocFile(file);
            M.toast({ html: "CSV file uploaded with ID: " + (fileData.id || "N/A") });
            window.uploadedCSVFileIds.push(fileData.id);
            csvDropZone.value = window.uploadedCSVFileIds.join("\n");
            await updateVectorStore();
          } catch (err) {
            console.error(err);
            M.toast({ html: "Error uploading CSV: " + err.message });
          }
        }
      }
    });

    // Helper function: parseListingNumbers using regex to split by comma with optional whitespace
    function parseListingNumbers(rawInput) {
      const parts = rawInput.split(/\s*,\s*/);
      const cleaned = parts.filter(p => /^\d{10}$/.test(p));
      return Array.from(new Set(cleaned)).slice(0, 250);
    }

    // Attach event listeners to shopListings:
    // - "paste": parse pasted text and update queue (but do not save immediately)
    // - "change": update queue on manual change
    // - "keydown": on Enter (without Shift) update local storage (overwrite saved numbers)
    // When the user pastes into the shopListings textarea.
  document.getElementById("shopListings").addEventListener("paste", (e) => {
    e.preventDefault();
    let pasteData = (e.clipboardData || window.clipboardData).getData("text");
    window.listingQueue = parseListingNumbers(pasteData);
    loadNextListingInQueue();
  });

    // When the user changes the shopListings textarea manually.
  document.getElementById("shopListings").addEventListener("change", () => {
    let rawInput = document.getElementById("shopListings").value;
    window.listingQueue = parseListingNumbers(rawInput);
    loadNextListingInQueue();
  });

// When the user presses "Enter" (without Shift) in the shopListings textarea,
// update the listingQueue, save it to local storage, and display only the first number.
document.getElementById("shopListings").addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    let rawInput = document.getElementById("shopListings").value;
    window.listingQueue = parseListingNumbers(rawInput);
    localStorage.setItem("listingQueue", JSON.stringify(window.listingQueue));
    loadNextListingInQueue();
  }
});

    // loadNextListingInQueue displays only the first number from the queue and updates local storage.
    function loadNextListingInQueue() {
      window.photoUpdateComplete = false;
      window.infoUpdateComplete = false;
      if (window.listingQueue.length > 0) {
        document.getElementById("shopListings").value = window.listingQueue[0];
      } else {
        document.getElementById("shopListings").value = "";
      }
      updateListingQueueCount();
      localStorage.setItem("listingQueue", JSON.stringify(window.listingQueue));
    }

    // updateListingQueueCount updates the counter element.
    function updateListingQueueCount() {
      document.getElementById("listingQueueCount").textContent = window.listingQueue.length;
    }

    // On page load, restore the listing queue from local storage (if available)
    function restoreDataAfterRedirect() {
      try {
        let soCSV = localStorage.getItem("soldOrdersCSV");
        if (soCSV) { window.soldOrdersCSV = JSON.parse(soCSV); }
        let liCSV = localStorage.getItem("listingsCSV");
        if (liCSV) { window.listingsCSV = JSON.parse(liCSV); }
        // Load listingQueue from local storage if it exists.
        let storedQueue = localStorage.getItem("listingQueue");
        if (storedQueue) {
          window.listingQueue = JSON.parse(storedQueue);
          // Display only the first number from the restored queue.
          if (window.listingQueue.length > 0) {
            document.getElementById("shopListings").value = window.listingQueue[0];
          }
        }
      } catch (err) {
        console.error("Error restoring data after redirect:", err);
      }
    }

    window.addEventListener("load", () => {
      let container13 = document.getElementById("container13");
      container13.style.height = (container13.offsetHeight * 2.5) + "px";
    });

    function openCropModal(index) {
      window.currentCropIndex = index;
      let cropModal = document.getElementById("photoCropModal");
      let cropImage = document.getElementById("cropImage");
      cropImage.src = window.previewImages[index];
      cropImage.onload = function() {
        window.cropper = new Cropper(cropImage, {
          viewMode: 1,
          autoCropArea: 1,
          movable: true,
          zoomable: true,
          scalable: false,
          rotatable: false,
          responsive: true,
          background: false,
          modal: true,
          guides: true,
          center: true,
          highlight: true,
          cropBoxMovable: true,
          cropBoxResizable: true,
          dragMode: 'move',
          ready: function() {
            let containerData = window.cropper.getContainerData();
            let cropBoxData = window.cropper.getCropBoxData();
            window.cropper.setCropBoxData({
              left: (containerData.width - cropBoxData.width) / 2,
              top: (containerData.height - cropBoxData.height) / 2
            });
          }
        });
      };
      let instance = M.Modal.getInstance(cropModal) || M.Modal.init(cropModal, {});
      instance.open();
    }

    document.getElementById("saveCropBtn").addEventListener("click", () => {
      if (window.cropper && window.currentCropIndex !== null) {
        let croppedCanvas = window.cropper.getCroppedCanvas({ width: 3000, height: 3000 });
        window.previewImages[window.currentCropIndex] = croppedCanvas.toDataURL("image/jpeg", 0.85);
        updateStaticPreviewGrid();
        window.cropper.destroy();
        window.cropper = null;
        window.currentCropIndex = null;
        M.Modal.getInstance(document.getElementById("photoCropModal")).close();
      }
    });

    document.getElementById("cancelCropBtn").addEventListener("click", () => {
      if (window.cropper) {
        window.cropper.destroy();
        window.cropper = null;
      }
      window.currentCropIndex = null;
      M.Modal.getInstance(document.getElementById("photoCropModal")).close();
    });

    async function uploadPhotos() {
      let listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) {
        M.toast({ html: "Please provide a listing URL or ID in 'Etsy Shop Listings'." });
        return;
      }
      if (!window.previewImages.length) {
        M.toast({ html: "No images to upload. Please drag and drop images first." });
        return;
      }
      let listingId = /^\d+$/.test(listingInput)
        ? listingInput
        : (listingInput.match(/\/listing\/(\d+)/) || [])[1];
      if (!listingId) {
        M.toast({ html: "Invalid listing URL or ID." });
        return;
      }
      for (let i = 0; i < window.previewImages.length; i++) {
        let dataURL = window.previewImages[i];
        let altText = window.photoMeta[i] || "";
        let rankNumber = i + 1;
        try {
          let res = await fetch(dataURL);
          let blob = await res.blob();
          let formData = new FormData();
          formData.append("listingId", listingId);
          formData.append("token", window.accessToken);
          formData.append("fileName", window.photoNames[i] || `uploaded_photo_${i}.jpg`);
          formData.append("rank", rankNumber);
          formData.append("alt_text", altText);
          formData.append("file", blob, window.photoNames[i] || `uploaded_photo_${i}.jpg`);
          let uploadUrl = `/.netlify/functions/imageUpload`;
          let response = await fetch(uploadUrl, { method: "POST", body: formData });
          if (!response.ok) {
            M.toast({ html: `Error uploading photo #${rankNumber}: ` + response.status });
          } else {
            M.toast({ html: `Photo #${rankNumber} uploaded with alt_text!` });
          }
        } catch (e) {
          console.error(e);
          M.toast({ html: `Exception uploading photo #${rankNumber}: ${e.message}` });
        }
      }
    }
    window.uploadPhotos = uploadPhotos;

    async function uploadReservedPhotos() {
      let listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) {
        M.toast({ html: "Please provide a listing URL or ID in 'Etsy Shop Listings'." });
        return;
      }
      if (!window.reservedPhotos.length) {
        M.toast({ html: "No reserved photos to upload." });
        return;
      }
      let listingId = /^\d+$/.test(listingInput)
        ? listingInput
        : (listingInput.match(/\/listing\/(\d+)/) || [])[1];
      if (!listingId) {
        M.toast({ html: "Invalid listing URL or ID." });
        return;
      }
      for (let i = 0; i < window.reservedPhotos.length; i++) {
        let dataURL = window.reservedPhotos[i].src;
        let altText = window.reservedPhotos[i].meta || "";
        let rankNumber = i + 8;
        try {
          let res = await fetch(dataURL);
          let blob = await res.blob();
          let formData = new FormData();
          formData.append("listingId", listingId);
          formData.append("token", window.accessToken);
          formData.append("fileName", window.reservedPhotos[i].name || `reserved_photo_${i}.jpg`);
          formData.append("rank", rankNumber);
          formData.append("alt_text", altText);
          formData.append("file", blob, window.reservedPhotos[i].name || `reserved_photo_${i}.jpg`);
          let uploadUrl = `/.netlify/functions/imageUpload`;
          let response = await fetch(uploadUrl, { method: "POST", body: formData });
          if (!response.ok) {
            M.toast({ html: `Error uploading reserved photo #${rankNumber}: ` + response.status });
          } else {
            M.toast({ html: `Reserved photo #${rankNumber} uploaded successfully!` });
          }
        } catch (e) {
          console.error(e);
          M.toast({ html: `Exception uploading reserved photo #${rankNumber}: ${e.message}` });
        }
      }
    }

    document.getElementById("analyzeMetadataBtn").addEventListener("click", async () => {
      const count = Math.min(7, window.previewImages.length);
      for (let i = 0; i < count; i++) {
        await metadataHandler.analyzeAndEmbedMetadata(i);
      }
    });

    async function generateTagPhrases() {
      let question = document.getElementById("listingDescInput").value.trim();
      if (!question) {
        M.toast({ html: "Please enter a question in the Listing Description." });
        return;
      }
      try {
        let phrasesArray = await getInitialPhrases(question, document.getElementById("keywordRulesTextarea").value);
        for (let i = 0; i < phrasesArray.length; i++) {
          if (phrasesArray[i].length > 20) {
            let otherValid = phrasesArray.filter((_, idx) => idx !== i && phrasesArray[idx].length <= 20);
            let newPhrase = await regenerateSinglePhrase(question, document.getElementById("keywordRulesTextarea").value, otherValid);
            phrasesArray[i] = newPhrase;
          }
        }
        if (phrasesArray.some(p => p.length > 20)) {
          throw new Error("Could not fix some phrases under 20 chars. Please try again.");
        }
        document.getElementById("searchKeyPhrases").value = phrasesArray.join("\n");
        M.toast({ html: "Tag Phrases generated successfully!" });
      } catch (err) {
        console.error(err);
        M.toast({ html: "Error generating valid tag phrases: " + err.message });
      }
    }

    async function getInitialPhrases(question, keywordRules) {
      let store_id = localStorage.getItem("vectorStoreId");
      let retrievedContext = "";
      if (store_id) {
        try {
          let resp = await fetch("/.netlify/functions/vectorStore", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "query",
              store_id,
              query: question,
              topK: 5
            })
          });
          if (resp.ok) {
            let data = await resp.json();
            retrievedContext = data?.data || "";
          } else {
            M.toast({ html: "Could not retrieve context from store. HTTP " + resp.status });
          }
        } catch (err) {
          console.error("Error retrieving CSV context:", err);
          M.toast({ html: "Error retrieving context: " + err.message });
        }
      } else {
        M.toast({ html: "Warning: no vector store ID in localStorage. Possibly no CSV context loaded." });
      }
      let prompt = `
Here is some relevant data from our CSV files:
${retrievedContext}

Listing Description (for emphasis): "${question}"
Emphasis on SEO and generating effective Etsy tag phrases.

Keyword Rules:
${keywordRules}

Generate exactly 13 SEO key phrases (each ≤ 20 characters). Return as plain text.
      `;
      let payload = {
        model: window.modelName,
        messages: [
          { role: "system", content: "Use the CSV context above to generate more accurate key phrases." },
          { role: "user", content: prompt }
        ],
        temperature: 0.7,
        max_tokens: 500
      };
      let data = await callOpenAI(payload);
      let answer = data.choices[0].message.content || "";
      let phrasesArray = answer
        .split(/[\n,]+/)
        .map(s => s.replace(/^\d+\.\s*/, "").trim())
        .filter(p => p);
      return phrasesArray;
    }

    async function regenerateSinglePhrase(question, keywordRules, currentValid, maxAttempts = 5) {
      for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        let store_id = localStorage.getItem("vectorStoreId");
        let retrievedContext = "";
        if (store_id) {
          try {
            let resp = await fetch("/.netlify/functions/vectorStore", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "query",
                store_id,
                query: question,
                topK: 5
              })
            });
            if (resp.ok) {
              let data = await resp.json();
              retrievedContext = data?.data || "";
            }
          } catch (err) {
            console.warn("Could not retrieve CSV context for single phrase regeneration:", err);
          }
        }
        let prompt = `
We have 12 valid phrases:
${currentValid.join(", ")}

Now produce ONE new phrase (≤20 chars) that satisfies the same rules:

Here is some relevant data from our CSV:
${retrievedContext}

Keyword Rules:
${keywordRules}
Return only one phrase in plain text.
        `;
        let payload = {
          model: window.modelName,
          messages: [
            { role: "system", content: "Generate a single phrase, up to 20 characters." },
            { role: "user", content: prompt }
          ],
          temperature: 0.7,
          max_tokens: 150
        };
        let data = await callOpenAI(payload);
        let answerText = data.choices[0].message.content || "";
        let candidate = answerText.trim()
          .replace(/^\d+\.\s*/, "")
          .split("\n")[0]
          .trim();
        if (candidate.length <= 20) {
          return candidate;
        }
        console.warn(`Attempt ${attempt}: Single phrase too long => "${candidate}"`);
      }
      throw new Error("Failed to generate a single phrase under 20 chars after multiple attempts.");
    }

    async function callOpenAI(payload) {
      let response = await fetch("/.netlify/functions/openaiProxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        let errorData = await response.json();
        throw new Error("API Error: " + (errorData.error ? errorData.error.message : response.statusText));
      }
      let jsonData = await response.json();
      return jsonData;
    }

    function updateTitleCount(text) {
      document.getElementById("titleCount").textContent = "Count: " + text.length;
    }

    document.getElementById("copyTitleBtn").addEventListener("click", () => {
      let text = document.getElementById("listingTitle").value;
      navigator.clipboard.writeText(text).catch(err => console.error("Copy error:", err));
    });
    document.getElementById("copyDescriptionBtn").addEventListener("click", () => {
      let text = document.getElementById("listingDescription").value;
      navigator.clipboard.writeText(text).catch(err => console.error("Copy error:", err));
    });
    
    async function clearStoreCSVFiles() {
      let storeId = localStorage.getItem("vectorStoreId");
      if (!storeId) {
        M.toast({ html: "No vector store ID found. Nothing to clear." });
        return;
      }
      let payload = {
        action: "clear_csv_files",
        store_id: storeId
      };
      try {
        let resp = await fetch("/.netlify/functions/vectorStore", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          M.toast({ html: "Error clearing CSV files, status " + resp.status });
          return;
        }
        let data = await resp.json();
        M.toast({ html: "Cleared CSV files from the store: " + JSON.stringify(data) });
        window.uploadedCSVFileIds = [];
        localStorage.removeItem("uploadedCSVFileIds");
        document.getElementById("uploadedFilesList").value = "";
        await listVectorStoreFiles();
      } catch (err) {
        console.error(err);
        M.toast({ html: "clearStoreCSVFiles error: " + err.message });
      }
    }
    document.getElementById("clearKeyPhrasesBtn").addEventListener("click", clearStoreCSVFiles);

    async function listVectorStoreFiles() {
      let storeId = localStorage.getItem("vectorStoreId");
      if (!storeId) {
        M.toast({ html: "No vector store ID found in localStorage. Not listing files." });
        return;
      }
      let payload = {
        action: "list_files",
        store_id: storeId
      };
      try {
        let resp = await fetch("/.netlify/functions/vectorStore", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          M.toast({ html: "listVectorStoreFiles: error " + resp.status });
          return;
        }
        let data = await resp.json();
        if (!data.data || !Array.isArray(data.data)) {
          M.toast({ html: "No files found in the store." });
          return;
        }
        let displayNames = data.data.map(f => {
          let fname = f.filename || "";
          fname = fname.replace(/(\.csv|\.txt)$/i, "");
          return fname;
        });
        document.getElementById("uploadedFilesList").value = displayNames.join("\n");
      } catch (err) {
        console.error(err);
        M.toast({ html: "Error listing store files: " + err.message });
      }
    }

    function loadReservedPhotos() {
      const stored = localStorage.getItem("reservedPhotos");
      window.reservedPhotos = stored ? JSON.parse(stored) : [];
    }
    function saveReservedPhotos() {
      localStorage.setItem("reservedPhotos", JSON.stringify(window.reservedPhotos));
    }

    async function resizeImage(dataURL, width, height) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL("image/jpeg", 0.85));
        };
        img.onerror = reject;
        img.src = dataURL;
      });
    }

    async function uploadDocFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const dataURL = event.target.result;
            let base64Content;
            let newFileName = file.name;
            let contentType = "text/csv";
            if (/\.csv$/i.test(file.name)) {
              const csvBase64 = dataURL.split(",")[1];
              const csvText = csvBase64 ? atob(csvBase64) : "";
              const parsed = Papa.parse(csvText, { header: false });
              const plainText = parsed.data.map(row => row.join(" ")).join("\n");
              base64Content = btoa(plainText);
              newFileName = file.name.replace(/\.csv$/i, ".txt");
              contentType = "text/plain";
            } else {
              base64Content = dataURL.split(",")[1];
              if (file.name.toLowerCase().endsWith(".docx")) {
                contentType = "application/vnd.openxmlformats-officedocument.wordprocessingml.document";
              } else if (file.name.toLowerCase().endsWith(".doc")) {
                contentType = "application/msword";
              }
            }
            if (!base64Content) throw new Error("File content is empty.");
            const payload = { 
              file: base64Content, 
              fileName: newFileName, 
              purpose: "user_data" 
            };
            const response = await fetch("/.netlify/functions/uploadFile", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            if (!response.ok) {
              throw new Error("Upload failed with status " + response.status);
            }
            const fileData = await response.json();
            fileData.name = fileData.name || newFileName;
            fileData.id = fileData.id || newFileName || ('file-' + Date.now());
            resolve(fileData);
          } catch (err) { 
            reject(err); 
          }
        };
        reader.onerror = (err) => {
          reject(err);
        };
        reader.readAsDataURL(file);
      });
    }

    async function updateVectorStore() {
      const fileIds = window.uploadedCSVFileIds || [];
      if (fileIds.length === 0) {
        M.toast({ html: "No CSV files uploaded yet, skipping vector store update." });
        return;
      }
      try {
        const vectorStorePayload = { 
          name: "CSV Vector Store", 
          file_ids: fileIds,
          model: "text-embedding-ada-002"
        };
        const response = await fetch("/.netlify/functions/vectorStore", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(vectorStorePayload)
        });
        if (!response.ok) {
          throw new Error("Error creating vector store, status " + response.status);
        }
        const data = await response.json();
        M.toast({ html: "Vector store created/updated. Store ID: " + data.id });
        if (data && data.id) {
          localStorage.setItem("vectorStoreId", data.id);
          M.toast({ html: "Saved store_id in localStorage: " + data.id });
        }
      } catch (err) {
        M.toast({ html: "updateVectorStore error: " + err.message });
        console.error(err);
      }
    }

    const dropZone = document.getElementById("dropZone");
    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.style.borderColor = "#000";
    });
    dropZone.addEventListener("dragleave", e => {
      e.preventDefault();
      dropZone.style.borderColor = "#ccc";
    });
    dropZone.addEventListener("drop", async e => {
      e.preventDefault();
      dropZone.style.borderColor = "#ccc";
      const files = e.dataTransfer.files;
      const maxRemaining = 10 - window.previewImages.length;
      for (let i = 0; i < Math.min(files.length, maxRemaining); i++) {
        let file = files[i];
        if (/image\/(jpeg|png)/.test(file.type)) {
          try {
            const dataURL = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = event => resolve(event.target.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            const resizedDataURL = await resizeImage(dataURL, 3000, 3000);
            window.previewImages.push(resizedDataURL);
            window.photoNames.push(file.name);
            window.photoIds.push('img-' + Date.now() + '-' + i);
          } catch (err) {
            console.error(err);
            M.toast({ html: "Error dropping image: " + err.message });
          }
        } else {
          M.toast({ html: "Only JPEG/PNG images supported." });
        }
      }
      updateStaticPreviewGrid();
      document.getElementById("uploadedFilesList").value = window.uploadedCSVFileIds.join("\n");
    });

    function updateStaticPreviewGrid() {
      for (let i = 0; i < 10; i++) {
        let cell = document.getElementById("previewCell" + i);
        if (!cell) continue;
        cell.innerHTML = "Empty";
        if (i < 7) {
          if (i < window.previewImages.length && window.previewImages[i]) {
            cell.innerHTML = "";
            let previewBox = document.createElement("div");
            previewBox.className = "preview-box";
            previewBox.setAttribute("data-id", window.photoIds[i] || "");
            previewBox.setAttribute("draggable", "true");
            previewBox.addEventListener("dragstart", e => { window.draggedIndex = i; });
            let img = document.createElement("img");
            img.src = window.previewImages[i];
            previewBox.appendChild(img);
            let removeBtn = document.createElement("div");
            removeBtn.className = "remove-btn";
            removeBtn.textContent = "X";
            removeBtn.addEventListener("click", ev => {
              ev.stopPropagation();
              window.previewImages.splice(i, 1);
              window.photoNames.splice(i, 1);
              window.photoMeta.splice(i, 1);
              window.photoIds.splice(i, 1);
              updateStaticPreviewGrid();
            });
            previewBox.appendChild(removeBtn);
            let numOverlay = document.createElement("div");
            numOverlay.className = "number-overlay";
            numOverlay.textContent = (i + 1).toString();
            previewBox.appendChild(numOverlay);
            let cropBtn = document.createElement("button");
            cropBtn.textContent = "Crop";
            cropBtn.style.position = "absolute";
            cropBtn.style.bottom = "2px";
            cropBtn.style.right = "2px";
            cropBtn.style.width = "20px";
            cropBtn.style.height = "20px";
            cropBtn.style.borderRadius = "50%";
            cropBtn.style.backgroundColor = "green";
            cropBtn.style.color = "white";
            cropBtn.style.fontSize = "10px";
            cropBtn.addEventListener("click", ev => {
              ev.stopPropagation();
              openCropModal(i);
            });
            previewBox.appendChild(cropBtn);
            if (window.photoMeta[i] && window.photoMeta[i].trim() !== "") {
              let checkmark = document.createElement("span");
              checkmark.innerHTML = "&#10003;";
              checkmark.style.fontSize = "18px";
              checkmark.style.color = "green";
              checkmark.style.position = "absolute";
              checkmark.style.bottom = "-15px";
              checkmark.style.left = "5px";
              previewBox.appendChild(checkmark);
            }
            previewBox.addEventListener("click", () => { showMetadata(i); });
            cell.appendChild(previewBox);
            let metadataStatus = document.createElement("div");
            metadataStatus.className = "metadata-status";
            metadataStatus.id = "metadataStatus" + i;
            cell.appendChild(metadataStatus);
          } else {
            cell.innerHTML = "Empty";
            let metadataStatus = document.createElement("div");
            metadataStatus.className = "metadata-status";
            metadataStatus.id = "metadataStatus" + i;
            cell.appendChild(metadataStatus);
          }
        } else {
          let rIndex = i - 7;
          if (rIndex < window.reservedPhotos.length && window.reservedPhotos[rIndex] && window.reservedPhotos[rIndex].src) {
            cell.innerHTML = "";
            let previewBox = document.createElement("div");
            previewBox.className = "preview-box";
            previewBox.setAttribute("data-id", window.reservedPhotos[rIndex].id || "");
            previewBox.setAttribute("draggable", "true");
            previewBox.addEventListener("dragstart", e => { window.draggedIndex = i; });
            let img = document.createElement("img");
            img.src = window.reservedPhotos[rIndex].src;
            previewBox.appendChild(img);
            let removeBtn = document.createElement("div");
            removeBtn.className = "remove-btn";
            removeBtn.textContent = "X";
            removeBtn.addEventListener("click", ev => {
              ev.stopPropagation();
              window.reservedPhotos.splice(rIndex, 1);
              saveReservedPhotos();
              updateStaticPreviewGrid();
            });
            previewBox.appendChild(removeBtn);
            let numOverlay = document.createElement("div");
            numOverlay.className = "number-overlay";
            numOverlay.textContent = (i + 1).toString();
            previewBox.appendChild(numOverlay);
            previewBox.addEventListener("click", () => { showMetadata(i); });
            cell.appendChild(previewBox);
            let metadataStatus = document.createElement("div");
            metadataStatus.className = "metadata-status";
            metadataStatus.id = "metadataStatus" + i;
            cell.appendChild(metadataStatus);
          } else {
            cell.innerHTML = "Empty";
            let metadataStatus = document.createElement("div");
            metadataStatus.className = "metadata-status";
            metadataStatus.id = "metadataStatus" + i;
            cell.appendChild(metadataStatus);
          }
        }
      }
    }

    function initializeCellDragAndDrop() {
      for (let i = 0; i < 10; i++) {
        let cell = document.getElementById("previewCell" + i);
        if (!cell.dataset.listenersAttached) {
          cell.addEventListener("dragover", function(e) {
            e.preventDefault();
            this.classList.add("drag-over");
          });
          cell.addEventListener("dragleave", function(e) {
            e.preventDefault();
            this.classList.remove("drag-over");
          });
          cell.addEventListener("drop", async function(e) {
            e.preventDefault();
            this.classList.remove("drag-over");
            let cellIndex = parseInt(this.id.replace("previewCell", ""));
            if (cellIndex < 7) {
              if (window.draggedIndex !== null && window.draggedIndex !== cellIndex) {
                if (window.previewImages[window.draggedIndex]) {
                  const [movedImage] = window.previewImages.splice(window.draggedIndex, 1);
                  window.previewImages.splice(cellIndex, 0, movedImage);
                  const [movedName] = window.photoNames.splice(window.draggedIndex, 1);
                  window.photoNames.splice(cellIndex, 0, movedName);
                  const [movedMeta] = window.photoMeta.splice(window.draggedIndex, 1);
                  window.photoMeta.splice(cellIndex, 0, movedMeta);
                  const [movedId] = window.photoIds.splice(window.draggedIndex, 1);
                  window.photoIds.splice(cellIndex, 0, movedId);
                  updateStaticPreviewGrid();
                  window.draggedIndex = null;
                }
              }
            } else {
              let rIndex = cellIndex - 7;
              if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                let file = e.dataTransfer.files[0];
                if (/image\/(jpeg|png)/.test(file.type)) {
                  const reader = new FileReader();
                  reader.onload = async ev => {
                    try {
                      const dataURL = ev.target.result;
                      const resizedDataURL = await resizeImage(dataURL, 3000, 3000);
                      let newReserved = {
                        src: resizedDataURL,
                        name: file.name,
                        meta: "",
                        id: 'img-' + Date.now()
                      };
                      window.reservedPhotos[rIndex] = newReserved;
                      saveReservedPhotos();
                      updateStaticPreviewGrid();
                    } catch (err) {
                      console.error(err);
                    }
                  };
                  reader.readAsDataURL(file);
                }
              } else if (window.draggedIndex !== null && window.draggedIndex !== cellIndex) {
                if (window.draggedIndex < 7) {
                  const [movedImage] = window.previewImages.splice(window.draggedIndex, 1);
                  const [movedName] = window.photoNames.splice(window.draggedIndex, 1);
                  const [movedMeta] = window.photoMeta.splice(window.draggedIndex, 1);
                  const [movedId] = window.photoIds.splice(window.draggedIndex, 1);
                  let newReserved = {
                    src: movedImage,
                    name: movedName,
                    meta: movedMeta || "",
                    id: movedId
                  };
                  window.reservedPhotos[rIndex] = newReserved;
                  saveReservedPhotos();
                } else {
                  let oldRIndex = window.draggedIndex - 7;
                  const [moved] = window.reservedPhotos.splice(oldRIndex, 1);
                  window.reservedPhotos[rIndex] = moved;
                  saveReservedPhotos();
                }
                updateStaticPreviewGrid();
                window.draggedIndex = null;
              }
            }
          });
          cell.dataset.listenersAttached = "true";
        }
      }
    }

    function generateRandomString(length) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let text = '';
      for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      }
      return text;
    }
    function base64urlEncode(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
    async function generateCodeChallenge(codeVerifier) {
      let encoder = new TextEncoder();
      let data = encoder.encode(codeVerifier);
      let digest = await crypto.subtle.digest("SHA-256", data);
      return base64urlEncode(digest);
    }

    document.getElementById("connectEtsyBtn").addEventListener("click", async () => {
      persistDataBeforeRedirect();
      let state = "randomState123";
      let scope = "listings_w listings_r";
      let codeVerifier = generateRandomString(64);
      localStorage.setItem("etsy_code_verifier", codeVerifier);
      let codeChallenge = await generateCodeChallenge(codeVerifier);
      let etsyAuthUrl = `https://www.etsy.com/oauth/connect?response_type=code&client_id=${window.CLIENT_ID}` +
        `&redirect_uri=${encodeURIComponent(window.REDIRECT_URI)}` +
        `&scope=${encodeURIComponent(scope)}` +
        `&state=${state}` +
        `&code_challenge=${encodeURIComponent(codeChallenge)}` +
        `&code_challenge_method=S256`;
      window.location.href = etsyAuthUrl;
    });

    document.addEventListener("DOMContentLoaded", async () => {
      loadPositions();
      loadReservedPhotos();
      restoreDataAfterRedirect();
      let urlParams = new URLSearchParams(window.location.search);
      let code = urlParams.get("code");
      if (code) {
        exchangeCodeForToken(code);
        window.history.replaceState({}, document.title, window.REDIRECT_URI);
      }
      updateStaticPreviewGrid();
      initializeCellDragAndDrop();
      // Attach paste and change events to process multiple comma-separated numbers
      document.getElementById("shopListings").addEventListener("paste", (e) => {
        e.preventDefault();
        let pasteData = (e.clipboardData || window.clipboardData).getData('text');
        window.listingQueue = parseListingNumbers(pasteData);
        loadNextListingInQueue();
      });
      document.getElementById("shopListings").addEventListener("change", () => {
        let rawInput = document.getElementById("shopListings").value;
        window.listingQueue = parseListingNumbers(rawInput);
        loadNextListingInQueue();
      });
      // Pressing Enter (without Shift) will update local storage and overwrite any saved listings.
      document.getElementById("shopListings").addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          let rawInput = document.getElementById("shopListings").value;
          window.listingQueue = parseListingNumbers(rawInput);
          localStorage.setItem("listingQueue", JSON.stringify(window.listingQueue));
          loadNextListingInQueue();
        }
      });
      await listVectorStoreFiles();
    });

    async function exchangeCodeForToken(code) {
      let codeVerifier = localStorage.getItem("etsy_code_verifier");
      if (!codeVerifier) {
        M.toast({ html: "No code verifier found. Please try connecting again." });
        return;
      }
      try {
        let response = await fetch(`/.netlify/functions/exchangeToken?code=${encodeURIComponent(code)}&code_verifier=${encodeURIComponent(codeVerifier)}`);
        let tokenData = await response.json();
        if (tokenData.access_token) {
          window.accessToken = tokenData.access_token;
          M.toast({ html: "Connected to Etsy!" });
        } else {
          M.toast({ html: "Error obtaining token: " + JSON.stringify(tokenData) });
        }
      } catch (error) {
        console.error(error);
        M.toast({ html: "Error exchanging code for token" });
      }
    }

    document.getElementById("uploadToEtsyBtn").addEventListener("click", async () => {
      let listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) {
        M.toast({ html: "Please provide a listing URL or ID in 'Etsy Shop Listings'." });
        return;
      }
      let listingId = /^\d+$/.test(listingInput)
        ? listingInput
        : (listingInput.match(/\/listing\/(\d+)/) || [])[1];
      if (!listingId) {
        M.toast({ html: "Invalid listing URL or ID." });
        return;
      }
      let userDescription = document.getElementById("listingDescription").value || "";
      let finalDescription = userDescription + window.appendedDescriptionText;
      let payload = {
        title: document.getElementById("listingTitle").value,
        description: finalDescription,
        tags: document.getElementById("searchKeyPhrases").value.split("\n").map(s => s.trim()).filter(s => s !== "")
      };
      M.toast({ html: "Updating Etsy listing info..." });
      let updateUrl = `/.netlify/functions/updateListing?listingId=${listingId}&token=${encodeURIComponent(window.accessToken)}`;
      try {
        let response = await fetch(updateUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          let errorText = await response.text();
          M.toast({ html: "Error updating listing: " + response.status + " - " + errorText });
        } else {
          M.toast({ html: "Listing info updated successfully!" });
          window.infoUpdateComplete = true;
          if (window.photoUpdateComplete && window.infoUpdateComplete) {
            window.listingQueue.shift();
            loadNextListingInQueue();
          }
        }
      } catch (e) {
        console.error(e);
        M.toast({ html: "Exception: " + e.message });
      }
    });

    document.getElementById("photoUploadNewBtn").addEventListener("click", async () => {
      let listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) {
        M.toast({ html: "Please provide a listing URL or ID in 'Etsy Shop Listings'." });
        return;
      }
      let btn = document.getElementById("photoUploadNewBtn");
      btn.disabled = true;
      try {
        M.toast({ html: "Uploading photos to Etsy..." });
        await uploadPhotos();
        M.toast({ html: "Uploading reserved photos to Etsy..." });
        await uploadReservedPhotos();
        M.toast({ html: "Photos updated successfully!" });
        window.photoUpdateComplete = true;
        if (window.photoUpdateComplete && window.infoUpdateComplete) {
          window.listingQueue.shift();
          loadNextListingInQueue();
        }
      } catch (err) {
        console.error(err);
        M.toast({ html: "Error uploading photos: " + err.message });
      } finally {
        btn.disabled = false;
      }
    });

    function dataURLtoBlob(dataurl) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }

    document.getElementById("listingDescInput").addEventListener("keydown", async (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        await generateTagPhrases();
      }
    });

    document.getElementById("generateBtn").addEventListener("click", async () => {
      await Promise.all([generateTitleOnly(), generateDescriptionOnly()]);
    });
    
    async function generateTitleOnly() {
  let etsyLink = window.ETSY_SHOP_URL;
  let keyPhrases = document.getElementById("searchKeyPhrases").value.trim();
  let rawDescription = document.getElementById("listingDescInput").value.trim();
  if (!keyPhrases) {
    M.toast({ html: "Please provide the search key phrases." });
    return;
  }
  let rulesText = document.getElementById("titleRulesTextarea").value;
  let promptText = `
You are ChatGPT using ${window.modelName}.
Based on the inputs below, generate an Etsy Listing TITLE only.
Input Context:
Etsy Link: "${etsyLink}"
Listing Description: "${rawDescription}"
Key Phrases: "${keyPhrases}"
--- Rules for TITLE ---
${rulesText}
Important: Return ONLY the title as plain text.`;
  document.getElementById("listingTitle").value = "Generating title...";
  let payload = {
    model: window.modelName,
    messages: [
      { role: "system", content: "Return ONLY the title as plain text." },
      { role: "user", content: promptText }
    ],
    temperature: 0.7
  };
  try {
    let data = await callOpenAI(payload);
    if (data.choices && data.choices.length > 0) {
      let output = data.choices[0].message.content;
      document.getElementById("listingTitle").value = output || "No title generated.";
      updateTitleCount(output);
    } else {
      document.getElementById("listingTitle").value = "No title generated.";
    }
  } catch (error) {
    document.getElementById("listingTitle").value = "Error: " + error;
  }
}

    async function generateDescriptionOnly() {
  let etsyLink = window.ETSY_SHOP_URL;
  let keyPhrases = document.getElementById("searchKeyPhrases").value.trim();
  let rawDescription = document.getElementById("listingDescInput").value.trim();
  if (!keyPhrases) {
    M.toast({ html: "Please provide the search key phrases." });
    return;
  }
  let rulesText = document.getElementById("descriptionRulesTextarea").value;
  let promptText = `
You are ChatGPT using ${window.modelName}.
Based on the inputs below, generate an Etsy Listing DESCRIPTION only.
Input Context:
Etsy Link: "${etsyLink}"
Listing Description: "${rawDescription}"
Key Phrases: "${keyPhrases}"
--- Rules for DESCRIPTION ---
${rulesText}
Important: Return ONLY the description as plain text.`;
  document.getElementById("listingDescription").value = "Generating description...";
  let payload = {
    model: window.modelName,
    messages: [
      { role: "system", content: "Return ONLY the description as plain text." },
      { role: "user", content: promptText }
    ],
    temperature: 0.7
  };
  try {
    let data = await callOpenAI(payload);
    if (data.choices && data.choices.length > 0) {
      let output = data.choices[0].message.content;
      document.getElementById("listingDescription").value = output || "No description generated.";
    } else {
      document.getElementById("listingDescription").value = "No description generated.";
    }
  } catch (error) {
    document.getElementById("listingDescription").value = "Error: " + error;
  }
}

    async function callOpenAI(payload) {
      let response = await fetch("/.netlify/functions/openaiProxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        let errorData = await response.json();
        throw new Error("API Error: " + (errorData.error ? errorData.error.message : response.statusText));
      }
      let jsonData = await response.json();
      return jsonData;
    }

    function updateTitleCount(text) {
      document.getElementById("titleCount").textContent = "Count: " + text.length;
    }

    document.getElementById("copyTitleBtn").addEventListener("click", () => {
      let text = document.getElementById("listingTitle").value;
      navigator.clipboard.writeText(text).catch(err => console.error("Copy error:", err));
    });
    document.getElementById("copyDescriptionBtn").addEventListener("click", () => {
      let text = document.getElementById("listingDescription").value;
      navigator.clipboard.writeText(text).catch(err => console.error("Copy error:", err));
    });
  </script>
</body>
</html>