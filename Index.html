// /netlify/functions/exchangeToken.js

const fetch = require("node-fetch");

exports.handler = async (event, context) => {
  try {
    const code = event.queryStringParameters.code;
    const codeVerifier = event.queryStringParameters.code_verifier;

    if (!code || !codeVerifier) {
      return {
        statusCode: 400,
        body: JSON.stringify({ error: "Missing code or code_verifier" })
      };
    }

    const clientId = process.env.CLIENT_ID;
    const clientSecret = process.env.CLIENT_SECRET;
    const redirectUri = process.env.REDIRECT_URI; // e.g., "https://delicate-tanuki-616ac0.netlify.app/"
    if (!clientId || !clientSecret || !redirectUri) {
      return {
        statusCode: 500,
        body: JSON.stringify({ error: "Missing Etsy OAuth env variables" })
      };
    }

    // Per Etsy docs:
    // POST https://openapi.etsy.com/v3/public/oauth/token
    //   grant_type=authorization_code
    //   client_id=YourAppId
    //   redirect_uri=YourRedirectUri
    //   code=CodeFromAuth
    //   code_verifier=YourCodeVerifier
    const url = "https://openapi.etsy.com/v3/public/oauth/token";
    const params = new URLSearchParams();
    params.set("grant_type", "authorization_code");
    params.set("client_id", clientId);
    params.set("redirect_uri", redirectUri);
    params.set("code", code);
    params.set("code_verifier", codeVerifier);

    const response = await fetch(url, {
      method: "POST",
      headers: {
        Authorization:
          "Basic " + Buffer.from(`${clientId}:${clientSecret}`).toString("base64"),
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: params.toString()
    });

    const tokenData = await response.json();
    if (!response.ok) {
      return {
        statusCode: response.status,
        body: JSON.stringify({ error: tokenData })
      };
    }

    return {
      statusCode: 200,
      body: JSON.stringify(tokenData)
    };
  } catch (err) {
    return {
      statusCode: 500,
      body: JSON.stringify({ error: err.message })
    };
  }
};