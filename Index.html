<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Etsy Listing Generator & Shop Listings</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <!-- Import Google Material Icons and Materialize CSS -->
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
    rel="stylesheet"
  >
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
  >
  <!-- Include piexifjs for EXIF manipulation (optional, if needed) -->
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.4/piexif.min.js"></script>
  <!-- ADDED LINE FOR SORTABLEJS: -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
  <style>
    /* Basic layout */
    html, body {
      margin: 0; padding: 0; width: 100vw;
      font-family: Arial, sans-serif;
    }
    .container {
      width: 100vw; padding: 10px; box-sizing: border-box;
      text-align: left;
    }
    h5, label, p {
      text-align: left;
    }
    input, textarea {
      width: 100%; box-sizing: border-box;
    }

    /* Wrap Listing Description and File Drop Zones */
    #descriptionAndFileUploadContainer {
      display: flex; align-items: center;
    }
    .listing-desc-container {
      position: relative; display: inline-block; width: 500px;
    }
    .listing-desc-container h5 {
      margin: 0 0 10px 0; font-size: 1.2rem; font-weight: 500;
    }
    .listing-desc-container label.section-heading {
      font-size: 1.2rem; font-weight: 500;
    }
    .listing-desc-container input {
      width: 500px; height: 30px; border: 1px solid #000; padding: 5px;
    }

    /* "User Provided Search Key Phrases" textarea */
    #searchKeyPhrases {
      resize: none; box-sizing: border-box; border: 1px solid grey;
    }
    #searchKeyPhrases[rows="14"] {
      height: auto;
    }
    .flex-container {
      display: flex; gap: 10px; align-items: stretch;
    }
    .textbox-container {
      flex: 1;
    }
    .textbox-container textarea {
      width: 100%; padding: 0.8rem; font-size: 1rem; line-height: 1.2;
      resize: none; overflow: visible; box-sizing: border-box;
    }
    .button-container {
      width: 200px; display: flex; flex-direction: column; gap: 10px;
      align-self: flex-start;
    }
    #listingTitle {
      min-height: 45px;
    }
    #listingDescInput {
      width: 500px; height: 30px; border: 1px solid #000; padding: 5px;
    }
    #listingDescription {
      min-height: 150px;
    }
    .section-heading {
      font-size: 1.2rem; font-weight: 500; margin-bottom: 5px;
      display: inline-block;
    }
    .count-text {
      font-style: italic; font-size: 0.9em; margin-top: 5px;
    }

    /* Drag and Drop Boxes */
    #dropZone, #ordersDropZone, #listingsDropZone {
      width: 138px; height: 138px; border: 2px dashed #ccc;
      border-radius: 3px; display: inline-block; vertical-align: middle;
      text-align: center; line-height: 138px; position: relative;
    }
    /* Orders container */
    #ordersContainer {
      display: flex; flex-direction: column;
    }
    /* CSV Progress Bar */
    #csvProgressBar {
      width: 100%; height: 20px; border: 1px solid blue;
      background-color: #e0f0ff; margin-top: 5px;
      -webkit-appearance: none; appearance: none;
    }
    #csvProgressBar::-webkit-progress-bar {
      background-color: #e0f0ff; border: 1px solid blue;
    }
    #csvProgressBar::-webkit-progress-value {
      background-color: blue;
    }
    #csvProgressContainer {
      margin-left: 85px;
    }
    /* File Drop Zones container */
    #fileDropZonesContainer {
      display: flex; gap: 10px; margin-left: 100px;
    }
    #uploadedFilesList {
      width: 300px; height: 125px; resize: none;
      box-sizing: border-box; border: 1px solid grey; margin-left: 85px;
    }

    /* Primary Preview â€“ clickable for cropping */
    #primaryPreview {
      width: 138px; height: 138px; border: 1px solid #ccc;
      border-radius: 3px; display: inline-block; vertical-align: middle;
      position: relative; top: -250px; left: 285px;
      text-align: center; overflow: hidden; cursor: pointer;
    }
    #primaryPreview:empty {
      background: #fff;
    }
    #primaryPreview img {
      width: 100%; height: 100%; object-fit: contain;
      border-radius: 3px;
    }

    /* Static 10-Photo Preview Grid */
    #previewGridContainer {
      position: relative; margin: 20px auto; width: auto;
      max-width: 600px; text-align: center;
    }
    #previewGridStatic {
      display: grid; grid-template-columns: repeat(5, 100px);
      grid-column-gap: 23px; grid-row-gap: 18px; margin: 0 auto;
    }
    .preview-cell {
      position: relative; width: 100px; height: 132px; border: 2px solid #ccc;
      border-radius: 3px; display: flex; flex-direction: column;
      align-items: center; justify-content: center; font-size: 12px; color: #666;
      /* We'll allow dropping onto the cells for reordering. */
    }
    .preview-box {
      position: relative; width: 100%; height: 100%;
      /* We'll mark this draggable for reorder. */
    }
    .preview-box img {
      width: 100px; height: 100px; object-fit: cover;
      border-radius: 3px; display: block;
    }
    .remove-btn {
      position: absolute; top: -5px; left: -5px; width: 15px; height: 15px;
      background-color: black; color: white; font-size: 10px;
      text-align: center; cursor: pointer; z-index: 999; border-radius: 50%;
    }
    .number-overlay {
      position: absolute; top: 0; right: 0; width: 16px; height: 16px;
      background-color: rgba(0,0,0,0.7); color: white; display: flex;
      align-items: center; justify-content: center; font-size: 10px;
      z-index: 999; border-radius: 3px;
    }
    /* Metadata status styles */
    .metadata-status {
      margin-top: 5px; text-align: center; font-size: 14px;
      min-height: 20px;
    }
    .metadata-progress {
      width: 90%;
    }

    /* Container #13 */
    #container13 {
      position: relative; width: 250px; top: -150px;
    }

    /* Components below search key phrases */
    #belowSearch {
      margin-top: -180px; margin-left: 10px;
    }
    .title-container {
      margin-top: -50px;
    }
    .description-container {
      margin-top: 0px;
    }
    #analyzeMetadataBtn {
      margin-left: 50px;
    }
    #showAnalyzeRulesBtn {
      margin-top: 25px;
    }
    .phrases-header {
      position: relative; top: 125px; left: 10px;
    }

    /* Update Listing and Upload Photo button containers */
    #uploadContainer {
      position: fixed; bottom: 20px; left: 50%;
      transform: translateX(-50%); display: inline-block;
    }
    #uploadPhotoContainer {
      position: fixed; bottom: 20px;
      left: calc(50% + 120px); display: inline-block;
    }
    /* ADDED NEW STYLE FOR DRAG-OVER VISUAL FEEDBACK: */
    .drag-over {
      background-color: rgba(0, 0, 255, 0.2);
    }
  </style>
</head>

<body>
  <!-- Configure Buttons control -->
  <button id="configureButtonsBtn"
          class="btn waves-effect waves-light configurable">
    Configure Buttons
  </button>

  <!-- Wrap Listing Description and File Drop Zones -->
  <div id="descriptionAndFileUploadContainer">
    <div class="listing-desc-container" id="listingDescContainer">
      <h5>Listing Description</h5>
      <input id="listingDescInput" type="text"
             placeholder="Enter your question here">
    </div>
    <div id="fileDropZonesContainer">
      <div id="ordersContainer">
        <div id="ordersDropZone">Etsy Sold Orders</div>
        <div id="csvProgressContainer">
          <progress id="csvProgressBar" max="100" value="0"></progress>
        </div>
      </div>
      <div id="listingsDropZone">Etsy Listings</div>
      <textarea id="uploadedFilesList"
                class="materialize-textarea" rows="2"
                placeholder="Uploaded .csv, .doc, .docx files will appear here">
      </textarea>
    </div>
  </div>

  <!-- Etsy OAuth and Shop Listings Section -->
  <button id="connectEtsyBtn"
          class="btn waves-effect waves-light configurable">
    Connect to Etsy
  </button>
  <div style="margin-top: -180px; margin-left: 10px;">
    <div class="section-heading configurable">My Etsy Shop Listings</div>
    <div class="textbox-container configurable">
      <textarea id="shopListings"
                class="materialize-textarea"
                placeholder="Enter your listing URL or ID"></textarea>
    </div>
  </div>

  <!-- Etsy Listing Generator UI -->
  <div class="phrases-header configurable"
       style="position: relative; top: 125px; left: 10px;">
    <span class="section-heading configurable">2. User Provided Search Key Phrases</span>
    <button id="clearKeyPhrasesBtn"
            class="btn-small waves-effect waves-light configurable">
      Clear
    </button>
    <button id="copyKeyPhrasesBtn"
            class="btn-small waves-effect waves-light configurable">
      Copy
    </button>
    <div id="dropZone" class="configurable">Drop Image Here</div>
    <div id="primaryPreview" class="configurable"></div>
    <button id="analyzeMetadataBtn"
            class="btn waves-effect waves-light configurable">
      Analyze Photos
    </button>
    <button id="showAnalyzeRulesBtn"
            class="btn waves-effect waves-light configurable"
            data-target="analyzeRulesModal"
            style="margin-top:25px;">
      Analyze Rules
    </button>
  </div>
  <div id="container13" class="flex-container configurable">
    <div class="textbox-container configurable">
      <textarea id="searchKeyPhrases"
                class="materialize-textarea"
                rows="14">
      </textarea>
    </div>
  </div>

  <!-- Components below Search Key Phrases -->
  <div id="belowSearch">
    <button id="generateBtn"
            class="btn waves-effect waves-light configurable">
      Generate
    </button>
    <div class="title-container" style="margin-top: -50px;">
      <div class="section-heading configurable">Etsy Listing TITLE</div>
      <div class="flex-container configurable">
        <div class="textbox-container configurable">
          <textarea id="listingTitle"
                    class="materialize-textarea"
                    rows="2"></textarea>
        </div>
        <div class="button-container configurable" style="margin-top: -60px;">
          <button id="regenTitleBtn"
                  class="btn-small waves-effect waves-light configurable">
            Re-Generate
          </button>
          <button id="copyTitleBtn"
                  class="btn-small waves-effect waves-light configurable">
            <i class="material-icons">content_copy</i>
          </button>
        </div>
        <button id="showTitleRulesBtn"
                class="btn waves-effect waves-light rules-button configurable"
                data-target="titleRulesModal">
          Title Rules
        </button>
      </div>
      <p id="titleCount" class="count-text configurable">Count: 0</p>
    </div>

    <div class="description-container" style="margin-top: 0px;">
      <div class="section-heading configurable">Etsy Listing DESCRIPTION</div>
      <div class="flex-container configurable">
        <div class="textbox-container configurable">
          <textarea id="listingDescription" class="materialize-textarea"></textarea>
        </div>
        <div class="button-container configurable">
          <button id="regenDescriptionBtn"
                  class="btn-small waves-effect waves-light configurable">
            Re-Generate
          </button>
          <button id="copyDescriptionBtn"
                  class="btn-small waves-effect waves-light configurable">
            <i class="material-icons">content_copy</i>
          </button>
        </div>
        <button id="showDescriptionRulesBtn"
                class="btn waves-effect waves-light rules-button configurable"
                data-target="descriptionRulesModal">
          Description Rules
        </button>
      </div>
    </div>
  </div>

  <!-- Static 10-Photo Preview Grid Container -->
  <div id="previewGridContainer">
    <div id="previewGridStatic">
      <div class="preview-cell" id="previewCell0">Empty</div>
      <div class="preview-cell" id="previewCell1">Empty</div>
      <div class="preview-cell" id="previewCell2">Empty</div>
      <div class="preview-cell" id="previewCell3">Empty</div>
      <div class="preview-cell" id="previewCell4">Empty</div>
      <div class="preview-cell" id="previewCell5">Empty</div>
      <div class="preview-cell" id="previewCell6">Empty</div>
      <div class="preview-cell" id="previewCell7">Empty</div>
      <div class="preview-cell" id="previewCell8">Empty</div>
      <div class="preview-cell" id="previewCell9">Empty</div>
    </div>
  </div>

  <!-- Update Listing button container -->
  <div id="uploadContainer">
    <button id="uploadToEtsyBtn"
            class="btn waves-effect waves-light configurable">
      Update Listing
    </button>
  </div>

  <!-- New Upload Photo button container -->
  <div id="uploadPhotoContainer">
    <button id="uploadPhotoBtn"
            class="btn waves-effect waves-light configurable">
      Upload Photo
    </button>
  </div>

  <!-- Metadata Modal (for viewing metadata on click) -->
  <div id="metadataModal" class="modal">
    <div class="modal-content">
      <h4>Photo Metadata</h4>
      <textarea id="metadataTextarea"
                readonly style="width:100%; height:300px;">
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="closeMetadataBtn"
         class="modal-close waves-effect waves-green btn">
        Close
      </a>
    </div>
  </div>

  <!-- Analyze Rules Modal -->
  <div id="analyzeRulesModal" class="modal">
    <div class="modal-content">
      <h4>Photo Analysis Rules</h4>
      <textarea id="analyzeRulesTextarea" style="width:100%; height:300px;">
Default Photo Analysis Rules:
1. Use SEO-friendly descriptive long-tail key phrases without special characters, focus on describing the jewelry and charm pendant, also focus and tailor Key Phrases and description to appropriate client based based on the type of jewelry.
2. Emphasize charm details, focus image description on the type of jewelry and pendant description(what it is, occasion, metal, size, style).
3. Focus solely on the jewelry details especially the charm description
4. Ignore environment, model, and clothing.
5. Organize into a short paragraph.
6. Limit the description to 300 characters.
7. Do not mention earrings unless explicitly identified.
8. Do not mix necklace and earring descriptions.
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateAnalyzeRulesBtn"
         class="modal-close waves-effect waves-green btn">
        Update
      </a>
    </div>
  </div>

  <!-- Title Rules Modal -->
  <div id="titleRulesModal" class="modal">
    <div class="modal-content">
      <h4>Title Rules</h4>
      <textarea id="titleRulesTextarea" style="width:100%; height:300px;">
Title Structure & Formatting:
- Create 5-7 SEO optimized long-tail key phrases (3-5 words each).
- The title must begin with the product type (e.g., "Angel Earrings", "Daisy Necklace").
- Ensure grammatical flow and no punctuation.
- If the product is a charm/pendant, the first word should describe that type.
- For necklaces, the second word must be "necklace"; for earrings, "Earring".

Word Usage & Frequency:
- No word may appear more than three times.
- "earrings" must be plural and follow a noun.
- "stud" may only appear in approved phrases and must precede "earrings".

Required Words:
- "Charm" must appear exactly once.

Use of "For":
- "for" must appear at least twice in a grammatically correct manner.

Title Length & Word Order:
- Titles must be between 125 and 140 characters.
- Adjectives must follow nouns.
- Avoid plurals for "stud" and "animal"; use plurals for "hoops" and "earrings" correctly.

SEO Optimization:
- The titleâ€™s word order should form at least eight natural SEO phrases.

Prohibited Words:
- Exclude: "accessories", "unique", "simple", "minimalist", "whimsical", "cute", "filled", "gold filled", "silver", "solid gold", "gold vermeil", "rosegold", "14k", "handmade", "quirky", "delicate", "accessory", "for", "dangle", "gold plated", "jewelry", "custom", "celestial", "design", "lightweight".
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateTitleRulesBtn"
         class="modal-close waves-effect waves-green btn">
        Update
      </a>
    </div>
  </div>

  <!-- Description Rules Modal -->
  <div id="descriptionRulesModal" class="modal">
    <div class="modal-content">
      <h4>Description Rules</h4>
      <textarea id="descriptionRulesTextarea" style="width:100%; height:300px;">
Rules for Description:
- Merge the key phrases with your output.
- Modify the description to match the jewelry type.
- Keep the output paragraph to 80 words.

Option 1:
"This stunning gold Playing Card Charm is the perfect gift for her, featuring an intricately designed Ace of Spades charm. Ideal for jewelry lovers, this pendant is perfect for personalized pieces."

Option 2:
"This playful Allosaurus charm is the perfect add-on for charm necklaces or huggie hoops. It adds a whimsical touch to any collection, making it a delightful gift."

Option 3:
"This charming gold Alligator Necklace is a delightful gift for animal lovers. Featuring a beautifully designed crocodile pendant, it adds a unique touch to any collection."
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateDescriptionRulesBtn"
         class="modal-close waves-effect waves-green btn">
        Update
      </a>
    </div>
  </div>

  <!-- Keyword Rules Modal -->
  <div id="keywordRulesModal" class="modal">
    <div class="modal-content">
      <h4>Keyword Rules</h4>
      <textarea id="keywordRulesTextarea" style="width:100%; height:300px;">
Using Sales Report and Product List Files:
- Extrapolate the best tag phrases based on performance.
- Focus on key terms like "Necklace", "Earrings", "Studs", "Hoops".
- Emphasize sales success; higher performing listings have more valuable keywords.
- Generate exactly 13 tag phrases, each â‰¤ 20 characters.
- Include "Gift for Her".
- "Charm" must appear at least once in a multi-word phrase (max 4 times total).
- "Necklace" appears no more than 3 times, "Gift" no more than 3 times, "Lover" no more than 2 times.
- Exclude: "Gift for Him", "Statement Piece", "Unique", "Spiritual Gift", "Outdoor Style", "accessories", "simple", "minimalist", "whimsical", "cute", "filled", "gold filled", "silver", "solid gold", "gold vermeil", "rosegold", "14k", "handmade", "quirky", "delicate", "accessory", "for", "dangle", "gold plated", "jewelry", "custom", "celestial", "design", "lightweight", "Fine Chain Necklace", "Small", "Large", "Nice", "Long", "Dark", "Short", "and", "but", "light", "heavy", "Wanderlust", "Theme", "Minimal Chain Gift", "Tiny Pendant Chain", "Charm Look", "Charm Wear", "Chain Necklace", "Small Pendant Chain", "Everyday"
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateKeywordRulesBtn"
         class="modal-close waves-effect waves-green btn">
        Update
      </a>
    </div>
  </div>

  <!-- Button Config Modal -->
  <div id="buttonConfigModal" class="modal">
    <div class="modal-content">
      <h4>Configure Button Positions</h4>
      <div id="buttonConfigContainer"></div>
      <textarea id="uploadedFilesListModal"
                class="materialize-textarea" rows="2"
                placeholder="Uploaded files will appear here">
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="saveButtonPositionsBtn"
         class="modal-close waves-effect waves-green btn">
        Save Positions
      </a>
    </div>
  </div>

  <!-- Crop Modal -->
  <div id="photoCropModal" class="modal">
    <div class="crop-container">
      <h4 style="text-align:center; margin: 0 0 10px 0;">Crop Photo</h4>
      <div class="img-container" style="overflow:hidden; position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
        <img id="cropImage" src="" alt="Crop Image" style="position:absolute; cursor:move; transform-origin:center center;">
      </div>
      <div class="controls">
        <label for="zoomSlider">Zoom:</label>
        <input type="range" id="zoomSlider" min="0.1" max="3" step="0.01" value="1">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <button id="saveCropBtn" class="btn waves-effect waves-light">Save</button>
        <button id="cancelCropBtn"
                class="btn waves-effect waves-light"
                style="background-color:#f44336; margin-left:10px;">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Include jQuery and Materialize JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js">
  </script>

  <script>
    // ----------------------------------------------------
    // GLOBALS & MAIN LOGIC
    // ----------------------------------------------------
    const ETSY_SHOP_URL = "https://www.etsy.com/shop/custombrites";
    const CLIENT_ID = "k75zdspz4r99txpqdji7i2em";
    const REDIRECT_URI = "https://delicate-tanuki-616ac0.netlify.app/";
    const modelName = "chatgpt-4o-latest";
    let accessToken;

    let soldOrdersCSV = [];
    let listingsCSV = [];

    let photoNames = [];
    let previewImages = []; // data URLs for display (3000Ã—3000 resized)
    let photoMeta = [];     // AI-generated metadata for alt_text
    // ADDED GLOBAL VARIABLE FOR DRAGGING:
    let draggedIndex = null;
    let photoIds = [];

    // -------------------------------------------
    // IMAGE RESIZE UTILITY (3000Ã—3000)
    // -------------------------------------------
    async function resizeImage(dataURL, width, height) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);
          // convert to a JPEG with ~85% quality
          const resizedDataURL = canvas.toDataURL("image/jpeg", 0.85);
          resolve(resizedDataURL);
        };
        img.onerror = reject;
        img.src = dataURL;
      });
    }

    // -------------------------------------------
    // DRAG & DROP FOR CSV / DOC (ORDERS, LISTINGS)
    // -------------------------------------------
    async function uploadCSVFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const dataURL = event.target.result;
            const base64Content = dataURL.split(",")[1];
            if (!base64Content) throw new Error("File content is empty.");
            const payload = {
              file: base64Content,
              fileName: file.name,
              purpose: "user_data"
            };
            const response = await fetch("/.netlify/functions/uploadFile", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error("Upload failed with status " + response.status);
            const responseData = await response.json();
            resolve({ id: responseData.id, name: file.name });
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function uploadDocFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const dataURL = event.target.result;
            const base64Content = dataURL.split(",")[1];
            if (!base64Content) throw new Error("File content is empty.");
            const payload = {
              file: base64Content,
              fileName: file.name,
              purpose: "user_data"
            };
            const response = await fetch("/.netlify/functions/uploadFile", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error("Upload failed with status " + response.status);
            const responseData = await response.json();
            resolve({ id: responseData.id, name: file.name });
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function updateVectorStore() {
      const allFileIds = [...soldOrdersCSV, ...listingsCSV].map(file => file.id);
      if (allFileIds.length === 0) {
        console.log("No supported files uploaded yet.");
        return;
      }
      try {
        const vectorStorePayload = { name: "CSV Vector Store", file_ids: allFileIds };
        const vectorStoreResponse = await fetch("/.netlify/functions/vectorStore", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(vectorStorePayload)
        });
        if (!vectorStoreResponse.ok) {
          const errorData = await vectorStoreResponse.json();
          throw new Error("Error creating vector store: " + JSON.stringify(errorData));
        }
        const vectorStoreData = await vectorStoreResponse.json();
        console.log("Vector store created:", vectorStoreData);
      } catch (err) {
        console.error("Error in updateVectorStore:", err);
      }
    }

    const ordersDropZone = document.getElementById("ordersDropZone");
    ordersDropZone.addEventListener("dragover", e => {
      e.preventDefault(); e.stopPropagation();
      ordersDropZone.style.borderColor = "#000";
    });
    ordersDropZone.addEventListener("dragleave", e => {
      e.preventDefault(); e.stopPropagation();
      ordersDropZone.style.borderColor = "#ccc";
    });
    ordersDropZone.addEventListener("drop", async e => {
      e.preventDefault(); e.stopPropagation();
      ordersDropZone.style.borderColor = "#ccc";
      const files = e.dataTransfer.files;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileName = file.name.toLowerCase();
        if (fileName.endsWith(".csv") || fileName.endsWith(".doc") || fileName.endsWith(".docx")) {
          try {
            let fileData;
            if (fileName.endsWith(".csv")) {
              fileData = await uploadCSVFile(file);
            } else {
              fileData = await uploadDocFile(file);
            }
            soldOrdersCSV.push(fileData);
            updateUploadedFilesList();
            await updateVectorStore();
          } catch (err) {
            console.error("Error uploading file:", err);
          }
        } else {
          alert("Only .csv, .doc, and .docx files are supported for Etsy Sold Orders.");
        }
      }
    });

    const listingsDropZone = document.getElementById("listingsDropZone");
    listingsDropZone.addEventListener("dragover", e => {
      e.preventDefault(); e.stopPropagation();
      listingsDropZone.style.borderColor = "#000";
    });
    listingsDropZone.addEventListener("dragleave", e => {
      e.preventDefault(); e.stopPropagation();
      listingsDropZone.style.borderColor = "#ccc";
    });
    listingsDropZone.addEventListener("drop", async e => {
      e.preventDefault(); e.stopPropagation();
      listingsDropZone.style.borderColor = "#ccc";
      const files = e.dataTransfer.files;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileName = file.name.toLowerCase();
        if (fileName.endsWith(".csv") || fileName.endsWith(".doc") || fileName.endsWith(".docx")) {
          try {
            let fileData;
            if (fileName.endsWith(".csv")) {
              fileData = await uploadCSVFile(file);
            } else {
              fileData = await uploadDocFile(file);
            }
            listingsCSV.push(fileData);
            updateUploadedFilesList();
            await updateVectorStore();
          } catch (err) {
            console.error("Error uploading file:", err);
          }
        } else {
          alert("Only .csv, .doc, and .docx files are supported for Etsy Listings.");
        }
      }
    });

    function updateUploadedFilesList() {
      let fileList = [];
      soldOrdersCSV.forEach(file => fileList.push(file.name));
      listingsCSV.forEach(file => fileList.push(file.name));
      document.getElementById("uploadedFilesList").value = fileList.join("\n");
    }

    // -------------------------------------------
    // DRAG & DROP IMAGES (Now Resizing to 3000Ã—3000)
    // -------------------------------------------
    const dropZone = document.getElementById("dropZone");
    dropZone.addEventListener("dragover", e => {
      e.preventDefault(); e.stopPropagation();
      dropZone.style.borderColor = "#000";
    });
    dropZone.addEventListener("dragleave", e => {
      e.preventDefault(); e.stopPropagation();
      dropZone.style.borderColor = "#ccc";
    });
    dropZone.addEventListener("drop", async e => {
      e.preventDefault(); e.stopPropagation();
      dropZone.style.borderColor = "#ccc";
      const files = e.dataTransfer.files;
      const maxRemaining = 10 - previewImages.length;
      for (let i = 0; i < Math.min(files.length, maxRemaining); i++) {
        const file = files[i];
        if (file.type === "image/jpeg" || file.type === "image/png") {
          try {
            const dataURL = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = event => resolve(event.target.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            // Now resize to 3000Ã—3000
            const resizedDataURL = await resizeImage(dataURL, 3000, 3000);
            previewImages.push(resizedDataURL);
            photoNames.push(file.name);
            // Create stable ID
            photoIds.push('img-' + Date.now() + '-' + i);
            updatePrimaryPreview();
            updateStaticPreviewGrid();
            updateUploadedFilesList();
          } catch (err) {
            console.error("Error processing image:", err);
          }
        } else {
          M.toast({ html: "Only JPEG/PNG images are supported." });
        }
      }
    });

    function updatePrimaryPreview() {
      const primaryPreview = document.getElementById("primaryPreview");
      if (previewImages.length > 0) {
        primaryPreview.innerHTML = `<img src="${previewImages[0]}" alt="Primary Preview">`;
      } else {
        primaryPreview.innerHTML = "";
      }
    }

    // ----------------------------------------------------------------------
    // REORDER LOGIC in updateStaticPreviewGrid() using custom native events
    // ----------------------------------------------------------------------
    function updateStaticPreviewGrid() {
      for (let i = 0; i < 10; i++) {
        const cell = document.getElementById("previewCell" + i);
        cell.innerHTML = "Empty";
        if (i < previewImages.length) {
          cell.innerHTML = "";
          const previewBox = document.createElement("div");
          previewBox.className = "preview-box";
          previewBox.setAttribute("data-id", photoIds[i]);
          // Modify dragstart to use custom variable:
          previewBox.addEventListener("dragstart", e => {
            draggedIndex = i;
          });
          const img = document.createElement("img");
          img.src = previewImages[i];
          previewBox.appendChild(img);
          const removeBtn = document.createElement("div");
          removeBtn.className = "remove-btn";
          removeBtn.textContent = "X";
          removeBtn.addEventListener("click", ev => {
            ev.stopPropagation();
            previewImages.splice(i, 1);
            photoNames.splice(i, 1);
            photoMeta.splice(i, 1);
            photoIds.splice(i, 1);
            updateStaticPreviewGrid();
            updatePrimaryPreview();
          });
          previewBox.appendChild(removeBtn);
          const numOverlay = document.createElement("div");
          numOverlay.className = "number-overlay";
          numOverlay.textContent = (i + 1).toString();
          previewBox.appendChild(numOverlay);
          previewBox.addEventListener("click", () => {
            showMetadata(i);
          });
          cell.appendChild(previewBox);
          // ADD NEW NATIVE DRAG EVENT LISTENERS ON THE CELL:
          cell.addEventListener("dragover", function(e) {
            e.preventDefault();
            if(cell.querySelector(".preview-box") != null) {
              cell.classList.add("drag-over");
            }
          });
          cell.addEventListener("dragleave", function(e) {
            cell.classList.remove("drag-over");
          });
          cell.addEventListener("drop", function(e) {
            e.preventDefault();
            cell.classList.remove("drag-over");
            let targetIndex = i;
            if(cell.querySelector(".preview-box") == null) {
              return;
            }
            if(draggedIndex === null) {
              return;
            }
            if(draggedIndex === targetIndex) {
              return;
            }
            const [movedImage] = previewImages.splice(draggedIndex, 1);
            previewImages.splice(targetIndex, 0, movedImage);
            const [movedName] = photoNames.splice(draggedIndex, 1);
            photoNames.splice(targetIndex, 0, movedName);
            const [movedMeta] = photoMeta.splice(draggedIndex, 1);
            photoMeta.splice(targetIndex, 0, movedMeta);
            const [movedId] = photoIds.splice(draggedIndex, 1);
            photoIds.splice(targetIndex, 0, movedId);
            updateStaticPreviewGrid();
            updatePrimaryPreview();
            draggedIndex = null;
          });
          const metadataStatus = document.createElement("div");
          metadataStatus.className = "metadata-status";
          metadataStatus.id = "metadataStatus" + i;
          cell.appendChild(metadataStatus);
        }
      }
    }

    function showMetadata(index) {
      const metadata = photoMeta[index] || "No metadata available for this photo.";
      document.getElementById("metadataTextarea").value = metadata;
      const modalElem = document.getElementById("metadataModal");
      let instance = M.Modal.getInstance(modalElem);
      if (!instance) {
        instance = M.Modal.init(modalElem, {});
      }
      instance.open();
    }

    // ----------------------------------------------------------------------
    // ANALYZE PHOTOS => calls /analyzeImage
    // ----------------------------------------------------------------------
    document.getElementById("analyzeMetadataBtn").addEventListener("click", async () => {
      for (let i = 0; i < previewImages.length; i++) {
        await analyzePhoto(i);
      }
    });

    async function analyzePhoto(index) {
      const statusElem = document.getElementById("metadataStatus" + index);
      if (!statusElem) return;
      statusElem.innerHTML = "";
      const progressBar = document.createElement("progress");
      progressBar.className = "metadata-progress";
      progressBar.max = 100;
      progressBar.value = 0;
      statusElem.appendChild(progressBar);
      let progress = 0;
      const interval = setInterval(() => {
        progress = Math.min(progress + 3, 60);
        progressBar.value = progress;
      }, 100);
      try {
        const rulesText = document.getElementById("analyzeRulesTextarea").value || "";
        const dataURL = previewImages[index];
        const blob = await (await fetch(dataURL)).blob();
        const formData = new FormData();
        formData.append("rules", rulesText);
        formData.append("imageFile", blob, photoNames[index] || `image_${index}.jpg`);
        const resp = await fetch("/.netlify/functions/analyzeImage", {
          method: "POST",
          body: formData
        });
        clearInterval(interval);
        progressBar.value = 80;
        if (!resp.ok) {
          const errData = await resp.text();
          throw new Error(`analyzeImage error: ${resp.status} - ${errData}`);
        }
        const json = await resp.json();
        photoMeta[index] = json.metadata || "No metadata returned.";
        progressBar.value = 100;
        statusElem.innerHTML = '<span style="color:green; font-size:16px;"><i class="material-icons">check_circle</i></span>';
      } catch (err) {
        clearInterval(interval);
        statusElem.innerHTML = `<span style="color:red;">Error: ${err.message}</span>`;
      }
    }

    // ----------------------------------------------------------------------
    // UPDATED CROP MODAL CODE START
    // ----------------------------------------------------------------------
    const cropImage = document.getElementById("cropImage");
    const zoomSlider = document.getElementById("zoomSlider");
    let currentCropIndex = null;

    // Function to center the crop image within the modal
    function centerCropImage() {
      const container = document.querySelector("#photoCropModal .crop-container");
      const containerRect = container.getBoundingClientRect();
      // Center the image by setting left and top so that the image's current width and height are centered
      const imgWidth = cropImage.offsetWidth * parseFloat(zoomSlider.value);
      const imgHeight = cropImage.offsetHeight * parseFloat(zoomSlider.value);
      cropImage.style.left = ((containerRect.width - imgWidth) / 2) + "px";
      cropImage.style.top = ((containerRect.height - imgHeight) / 2) + "px";
    }

    // When the crop modal opens, center the image and set transform-origin to center
    cropImage.onload = function() {
      cropImage.style.transformOrigin = "center center";
      centerCropImage();
    };

    zoomSlider.addEventListener("input", function() {
      const zoom = this.value;
      cropImage.style.transform = "scale(" + zoom + ")";
      centerCropImage();
    });

    document.getElementById("saveCropBtn").addEventListener("click", async function() {
      if (currentCropIndex === null) return;
      const container = document.querySelector("#photoCropModal .crop-container");
      const containerRect = container.getBoundingClientRect();
      // Get computed style of cropImage
      const style = window.getComputedStyle(cropImage);
      const left = parseFloat(style.left) || 0;
      const top = parseFloat(style.top) || 0;
      const zoom = parseFloat(zoomSlider.value);
      // Get natural dimensions of the image
      const naturalWidth = cropImage.naturalWidth;
      const naturalHeight = cropImage.naturalHeight;
      // Calculate displayed image dimensions
      const displayedWidth = cropImage.offsetWidth * zoom;
      const displayedHeight = cropImage.offsetHeight * zoom;
      // Calculate ratio between natural and displayed dimensions
      const ratioX = naturalWidth / displayedWidth;
      const ratioY = naturalHeight / displayedHeight;
      // Compute crop area relative to the natural dimensions
      const cropX = -left * ratioX;
      const cropY = -top * ratioY;
      const cropW = containerRect.width * ratioX;
      const cropH = containerRect.height * ratioY;
      const canvas = document.createElement("canvas");
      canvas.width = cropW;
      canvas.height = cropH;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(cropImage, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);
      const croppedDataURL = canvas.toDataURL("image/jpeg", 0.85);
      const finalDataURL = await resizeImage(croppedDataURL, 3000, 3000);
      previewImages[currentCropIndex] = finalDataURL;
      updateStaticPreviewGrid();
      updatePrimaryPreview();
      let cropModalInstance = M.Modal.getInstance(document.getElementById("photoCropModal"));
      if (cropModalInstance) {
        cropModalInstance.close();
      }
      currentCropIndex = null;
    });

    document.getElementById("cancelCropBtn").addEventListener("click", function() {
      let cropModalInstance = M.Modal.getInstance(document.getElementById("photoCropModal"));
      if (cropModalInstance) {
        cropModalInstance.close();
      }
      currentCropIndex = null;
    });
    // ----------------------------------------------------------------------
    // UPDATED CROP MODAL CODE END
    // ----------------------------------------------------------------------

    // ----------------------------------------------------------------------
    // OAUTH CONNECT (Etsy)
    // ----------------------------------------------------------------------
    function generateRandomString(length) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let text = '';
      for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      }
      return text;
    }

    function base64urlEncode(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function generateCodeChallenge(codeVerifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return base64urlEncode(digest);
    }

    document.getElementById("connectEtsyBtn").addEventListener("click", async () => {
      const state = "randomState123";
      const scope = "listings_w listings_r";
      const codeVerifier = generateRandomString(64);
      localStorage.setItem("etsy_code_verifier", codeVerifier);
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const etsyAuthUrl =
        `https://www.etsy.com/oauth/connect?response_type=code&client_id=${CLIENT_ID}` +
        `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
        `&scope=${encodeURIComponent(scope)}` +
        `&state=${state}` +
        `&code_challenge=${encodeURIComponent(codeChallenge)}` +
        `&code_challenge_method=S256`;
      window.location.href = etsyAuthUrl;
    });

    document.addEventListener("DOMContentLoaded", () => {
      loadButtonPositions();
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");
      if (code) {
        exchangeCodeForToken(code);
        window.history.replaceState({}, document.title, REDIRECT_URI);
      }
      updateStaticPreviewGrid();
      updateUploadedFilesList();
    });

    async function exchangeCodeForToken(code) {
      const codeVerifier = localStorage.getItem("etsy_code_verifier");
      if (!codeVerifier) {
        M.toast({ html: "No code verifier found. Please try connecting again." });
        return;
      }
      try {
        const response = await fetch(`/.netlify/functions/exchangeToken?code=${encodeURIComponent(code)}&code_verifier=${encodeURIComponent(codeVerifier)}`);
        const tokenData = await response.json();
        if (tokenData.access_token) {
          accessToken = tokenData.access_token;
          M.toast({ html: "Connected to Etsy!" });
        } else {
          M.toast({ html: "Error obtaining token: " + JSON.stringify(tokenData) });
        }
      } catch (error) {
        console.error("Error exchanging code:", error);
        M.toast({ html: "Error exchanging code for token" });
      }
    }

    // ----------------------------------------------------------------------
    // UPDATE LISTING
    // ----------------------------------------------------------------------
    document.getElementById("uploadToEtsyBtn").addEventListener("click", async () => {
      const listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) {
        M.toast({ html: "Please provide a listing URL or ID in 'My Etsy Shop Listings'." });
        return;
      }
      let listingId;
      if (/^\d+$/.test(listingInput)) {
        listingId = listingInput;
      } else {
        const match = listingInput.match(/\/listing\/(\d+)/);
        if (match) {
          listingId = match[1];
        } else {
          M.toast({ html: "Invalid listing URL or ID." });
          return;
        }
      }
      const payload = {
        title: document.getElementById("listingTitle").value,
        description: document.getElementById("listingDescription").value,
        tags: document.getElementById("searchKeyPhrases").value
          .split("\n").map(s => s.trim()).filter(s => s !== "")
      };
      const updateUrl =
        `/.netlify/functions/updateListing?listingId=${listingId}&token=${encodeURIComponent(accessToken)}`;
      try {
        const response = await fetch(updateUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          const errorText = await response.text();
          M.toast({ html: "Error updating listing: " + response.status + " - " + errorText });
        } else {
          M.toast({ html: "Listing updated successfully!" });
        }
      } catch (e) {
        console.error("Exception in updateExistingListing:", e);
        M.toast({ html: "Exception: " + e.message });
      }
    });

    // ----------------------------------------------------------------------
    // UPLOAD PHOTOS (includes alt_text from photoMeta)
    // ----------------------------------------------------------------------
    document.getElementById("uploadPhotoBtn").addEventListener("click", async () => {
      const listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) {
        M.toast({ html: "Please provide a listing URL or ID in 'My Etsy Shop Listings'." });
        return;
      }
      let listingId;
      if (/^\d+$/.test(listingInput)) {
        listingId = listingInput;
      } else {
        const match = listingInput.match(/\/listing\/(\d+)/);
        if (match) {
          listingId = match[1];
        } else {
          M.toast({ html: "Invalid listing URL or ID." });
          return;
        }
      }
      if (previewImages.length === 0) {
        M.toast({ html: "No images to upload. Please drag and drop images first." });
        return;
      }
      for (let i = 0; i < previewImages.length; i++) {
        const dataURL = previewImages[i];
        const altText = photoMeta[i] || "";
        const rankNumber = i + 1;
        try {
          const res = await fetch(dataURL);
          const blob = await res.blob();
          const formData = new FormData();
          formData.append("listingId", listingId);
          formData.append("token", accessToken);
          formData.append("fileName", photoNames[i] || `uploaded_photo_${i}.jpg`);
          formData.append("rank", rankNumber);
          formData.append("alt_text", altText);
          formData.append("file", blob, photoNames[i] || `uploaded_photo_${i}.jpg`);
          const uploadUrl = `/.netlify/functions/imageUpload`;
          const response = await fetch(uploadUrl, {
            method: "POST",
            body: formData
          });
          if (!response.ok) {
            M.toast({ html: `Error uploading photo #${rankNumber}: ` + response.status });
          } else {
            M.toast({ html: `Photo #${rankNumber} uploaded with alt_text!` });
          }
        } catch (e) {
          console.error(`Exception uploading photo #${rankNumber}:`, e);
          M.toast({ html: `Exception uploading photo #${rankNumber}: ${e.message}` });
        }
      }
    });

    // ----------------------------------------------------------------------
    // RULES & TITLE / DESCRIPTION GENERATION
    // ----------------------------------------------------------------------
    function stripMarkdownJSON(text) {
      return text.replace(/^```json\s*/, "").replace(/\s*```$/, "").trim();
    }

    async function generateTitleOnly() {
      const etsyLink = ETSY_SHOP_URL;
      const keyPhrases = document.getElementById("searchKeyPhrases").value.trim();
      if (!keyPhrases) {
        M.toast({ html: "Please provide the search key phrases." });
        return;
      }
      const rulesText = document.getElementById("titleRulesTextarea").value;
      const promptText = `
You are ChatGPT using ${modelName}.
Based on the inputs below, generate an Etsy Listing TITLE only.
Input Context:
Etsy Link: "${etsyLink}"
Search Key Phrases: "${keyPhrases}"
--- Rules for TITLE ---
${stripMarkdownJSON(rulesText)}
Important: Return ONLY the title as plain text.`;
      document.getElementById("listingTitle").value = "Generating title...";
      const payload = {
        model: modelName,
        messages: [
          { role: "system", content: "Return ONLY the title as plain text." },
          { role: "user", content: promptText }
        ],
        temperature: 0.7
      };
      try {
        const data = await callOpenAI(payload);
        if (data.choices && data.choices.length > 0) {
          const output = stripMarkdownJSON(data.choices[0].message.content);
          document.getElementById("listingTitle").value = output || "No title generated.";
          updateTitleCount(output);
        } else {
          document.getElementById("listingTitle").value = "No title generated.";
        }
      } catch (error) {
        document.getElementById("listingTitle").value = "Error: " + error;
      }
    }

    async function generateDescriptionOnly() {
      const etsyLink = ETSY_SHOP_URL;
      const keyPhrases = document.getElementById("searchKeyPhrases").value.trim();
      if (!keyPhrases) {
        M.toast({ html: "Please provide the search key phrases." });
        return;
      }
      const rulesText = document.getElementById("descriptionRulesTextarea").value;
      const promptText = `
You are ChatGPT using ${modelName}.
Based on the inputs below, generate an Etsy Listing DESCRIPTION only.
Input Context:
Etsy Link: "${etsyLink}"
Search Key Phrases: "${keyPhrases}"
--- Rules for DESCRIPTION ---
${stripMarkdownJSON(rulesText)}
Important: Return ONLY the description as plain text.`;
      document.getElementById("listingDescription").value = "Generating description...";
      const payload = {
        model: modelName,
        messages: [
          { role: "system", content: "Return ONLY the description as plain text." },
          { role: "user", content: promptText }
        ],
        temperature: 0.7
      };
      try {
        const data = await callOpenAI(payload);
        if (data.choices && data.choices.length > 0) {
          const output = stripMarkdownJSON(data.choices[0].message.content);
          document.getElementById("listingDescription").value = output || "No description generated.";
        } else {
          document.getElementById("listingDescription").value = "No description generated.";
        }
      } catch (error) {
        document.getElementById("listingDescription").value = "Error: " + error;
      }
    }

    async function callOpenAI(payload) {
      const response = await fetch("/.netlify/functions/openaiProxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error("API Error: " +
          (errorData.error ? errorData.error.message : response.statusText));
      }
      return await response.json();
    }

    document.getElementById("generateBtn").addEventListener("click", async () => {
      await Promise.all([generateTitleOnly(), generateDescriptionOnly()]);
    });
    document.getElementById("regenTitleBtn").addEventListener("click", generateTitleOnly);
    document.getElementById("regenDescriptionBtn").addEventListener("click", generateDescriptionOnly);

    function updateTitleCount(text) {
      document.getElementById("titleCount").textContent = "Count: " + text.length;
    }

    // Copy to clipboard
    document.getElementById("copyTitleBtn").addEventListener("click", () => {
      const text = document.getElementById("listingTitle").value;
      navigator.clipboard.writeText(text).catch(err => console.error("Copy error:", err));
    });
    document.getElementById("copyDescriptionBtn").addEventListener("click", () => {
      const text = document.getElementById("listingDescription").value;
      navigator.clipboard.writeText(text).catch(err => console.error("Copy error:", err));
    });
    document.getElementById("clearKeyPhrasesBtn").addEventListener("click", () => {
      document.getElementById("searchKeyPhrases").value = "";
    });
    document.getElementById("copyKeyPhrasesBtn").addEventListener("click", () => {
      const lines = document.getElementById("searchKeyPhrases").value
        .split(/\n+/).map(l => l.trim()).filter(l => l !== "");
      navigator.clipboard.writeText(lines.join(", "))
        .catch(err => console.error("Error copying key phrases:", err));
    });
    // Key phrase generation from "listingDescInput" if needed
    document.getElementById("listingDescInput").addEventListener("keydown", async (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        await generateTagPhrases();
      }
    });
    async function generateTagPhrases() {
      const question = document.getElementById("listingDescInput").value.trim();
      if (!question) {
        M.toast({ html: "Please enter a question in the Listing Description." });
        return;
      }
      const keywordRules = stripMarkdownJSON(document.getElementById("keywordRulesTextarea").value);
      const extraText = "Emphasis on SEO and generating effective Etsy tag phrases.";
      const prompt = `
Listing Description (for emphasis): "${question}"
${extraText}

Keyword Rules:
${keywordRules}

Generate exactly 13 tag phrases (each â‰¤ 20 characters). Return as plain text.
`;
      try {
        const payload = {
          model: modelName,
          messages: [
            { role: "system", content: "Generate tag phrases according to the provided rules." },
            { role: "user", content: prompt }
          ],
          temperature: 0.7,
          max_tokens: 500
        };
        const data = await callOpenAI(payload);
        let answer = data.choices[0].message.content;
        let phrases = answer.split(/[\n,]+/)
          .map(s => s.replace(/^\d+\.\s*/, "").trim())
          .filter(p => p)
          .join("\n");
        document.getElementById("searchKeyPhrases").value = phrases;
      } catch (err) {
        console.error("Error generating tag phrases:", err);
        M.toast({ html: "Error generating tag phrases: " + err.message });
      }
    }
    // ----------------------------------------------------------------------
    // BUTTON CONFIG
    // ----------------------------------------------------------------------
    document.getElementById("configureButtonsBtn").addEventListener("click", () => {
      const configContainer = document.getElementById("buttonConfigContainer");
      configContainer.innerHTML = "";
      const selectors = [
        "button:not(#configureButtonsBtn)",
        "#listingDescContainer",
        "#ordersDropZone",
        "#listingsDropZone",
        "#dropZone",
        "#csvProgressContainer",
        "#previewGridContainer",
        "#primaryPreview",
        "#container13",
        "#uploadedFilesList"
      ].join(", ");
      const elements = document.querySelectorAll(selectors);
      const table = document.createElement("table");
      table.className = "striped";
      const thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>Element ID</th><th>Top (px)</th><th>Left (px)</th></tr>";
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      elements.forEach(el => {
        const id = el.id;
        const computedStyle = window.getComputedStyle(el);
        const currentTop = el.style.top || computedStyle.top || "0";
        const currentLeft = el.style.left || computedStyle.left || "0";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td><input type="number" id="${id}_top" value="${parseInt(currentTop)||0}"></td>
          <td><input type="number" id="${id}_left" value="${parseInt(currentLeft)||0}"></td>
        `;
        const topInput = tr.querySelector(`#${id}_top`);
        const leftInput = tr.querySelector(`#${id}_left`);
        topInput.addEventListener("input", () => {
          el.style.top = topInput.value + "px";
        });
        leftInput.addEventListener("input", () => {
          el.style.left = leftInput.value + "px";
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      configContainer.appendChild(table);
      const modalElem = document.getElementById("buttonConfigModal");
      let modalInstance = M.Modal.getInstance(modalElem);
      if (!modalInstance) {
        modalInstance = M.Modal.init(modalElem, { preventScrolling: false });
      }
      modalInstance.open();
    });
    document.getElementById("saveButtonPositionsBtn").addEventListener("click", () => {
      const selectors = [
        "button:not(#configureButtonsBtn)",
        "#listingDescContainer",
        "#ordersDropZone",
        "#listingsDropZone",
        "#dropZone",
        "#csvProgressContainer",
        "#previewGridContainer",
        "#primaryPreview",
        "#container13",
        "#uploadedFilesList"
      ].join(", ");
      const elements = document.querySelectorAll(selectors);
      const positions = {};
      elements.forEach(el => {
        positions[el.id] = {
          top: el.style.top || "0px",
          left: el.style.left || "0px"
        };
      });
      localStorage.setItem("buttonPositions", JSON.stringify(positions));
      M.toast({ html: "Button positions saved." });
    });
    function loadButtonPositions() {
      const stored = localStorage.getItem("buttonPositions");
      if (stored) {
        const positions = JSON.parse(stored);
        for (const id in positions) {
          const el = document.getElementById(id);
          if (el) {
            el.style.top = positions[id].top;
            el.style.left = positions[id].left;
          }
        }
      }
    }
    window.addEventListener("load", () => {
      const container13 = document.getElementById("container13");
      container13.style.height = (container13.offsetHeight * 2.5) + "px";
    });

    // ----------------------------------------------------------------------
    // UPDATED CROP MODAL CODE START
    // ----------------------------------------------------------------------
    const cropImage = document.getElementById("cropImage");
    const zoomSlider = document.getElementById("zoomSlider");
    let currentCropIndex = null;

    // Function to center the crop image within the modal
    function centerCropImage() {
      const container = document.querySelector("#photoCropModal .crop-container");
      const containerRect = container.getBoundingClientRect();
      const imgWidth = cropImage.offsetWidth * parseFloat(zoomSlider.value);
      const imgHeight = cropImage.offsetHeight * parseFloat(zoomSlider.value);
      cropImage.style.left = ((containerRect.width - imgWidth) / 2) + "px";
      cropImage.style.top = ((containerRect.height - imgHeight) / 2) + "px";
    }

    // When the crop modal opens, center the image and set transform-origin to center
    cropImage.onload = function() {
      cropImage.style.transformOrigin = "center center";
      centerCropImage();
    };

    zoomSlider.addEventListener("input", function() {
      const zoom = this.value;
      cropImage.style.transform = "scale(" + zoom + ")";
      centerCropImage();
    });

    document.getElementById("saveCropBtn").addEventListener("click", async function() {
      if (currentCropIndex === null) return;
      const container = document.querySelector("#photoCropModal .crop-container");
      const containerRect = container.getBoundingClientRect();
      const style = window.getComputedStyle(cropImage);
      const left = parseFloat(style.left) || 0;
      const top = parseFloat(style.top) || 0;
      const zoom = parseFloat(zoomSlider.value);
      const naturalWidth = cropImage.naturalWidth;
      const naturalHeight = cropImage.naturalHeight;
      const displayedWidth = cropImage.offsetWidth * zoom;
      const displayedHeight = cropImage.offsetHeight * zoom;
      const ratioX = naturalWidth / displayedWidth;
      const ratioY = naturalHeight / displayedHeight;
      const cropX = -left * ratioX;
      const cropY = -top * ratioY;
      const cropW = containerRect.width * ratioX;
      const cropH = containerRect.height * ratioY;
      const canvas = document.createElement("canvas");
      canvas.width = cropW;
      canvas.height = cropH;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(cropImage, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);
      const croppedDataURL = canvas.toDataURL("image/jpeg", 0.85);
      const finalDataURL = await resizeImage(croppedDataURL, 3000, 3000);
      previewImages[currentCropIndex] = finalDataURL;
      updateStaticPreviewGrid();
      updatePrimaryPreview();
      let cropModalInstance = M.Modal.getInstance(document.getElementById("photoCropModal"));
      if (cropModalInstance) {
        cropModalInstance.close();
      }
      currentCropIndex = null;
    });

    document.getElementById("cancelCropBtn").addEventListener("click", function() {
      let cropModalInstance = M.Modal.getInstance(document.getElementById("photoCropModal"));
      if (cropModalInstance) {
        cropModalInstance.close();
      }
      currentCropIndex = null;
    });
    // ----------------------------------------------------------------------
    // UPDATED CROP MODAL CODE END
    // ----------------------------------------------------------------------

    // ----------------------------------------------------------------------
    // OAUTH CONNECT (Etsy)
    // ----------------------------------------------------------------------
    function generateRandomString(length) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let text = '';
      for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      }
      return text;
    }
    function base64urlEncode(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
    async function generateCodeChallenge(codeVerifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return base64urlEncode(digest);
    }
    document.getElementById("connectEtsyBtn").addEventListener("click", async () => {
      const state = "randomState123";
      const scope = "listings_w listings_r";
      const codeVerifier = generateRandomString(64);
      localStorage.setItem("etsy_code_verifier", codeVerifier);
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const etsyAuthUrl =
        `https://www.etsy.com/oauth/connect?response_type=code&client_id=${CLIENT_ID}` +
        `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
        `&scope=${encodeURIComponent(scope)}` +
        `&state=${state}` +
        `&code_challenge=${encodeURIComponent(codeChallenge)}` +
        `&code_challenge_method=S256`;
      window.location.href = etsyAuthUrl;
    });
    document.addEventListener("DOMContentLoaded", () => {
      loadButtonPositions();
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");
      if (code) {
        exchangeCodeForToken(code);
        window.history.replaceState({}, document.title, REDIRECT_URI);
      }
      updateStaticPreviewGrid();
      updateUploadedFilesList();
    });
    async function exchangeCodeForToken(code) {
      const codeVerifier = localStorage.getItem("etsy_code_verifier");
      if (!codeVerifier) {
        M.toast({ html: "No code verifier found. Please try connecting again." });
        return;
      }
      try {
        const response = await fetch(`/.netlify/functions/exchangeToken?code=${encodeURIComponent(code)}&code_verifier=${encodeURIComponent(codeVerifier)}`);
        const tokenData = await response.json();
        if (tokenData.access_token) {
          accessToken = tokenData.access_token;
          M.toast({ html: "Connected to Etsy!" });
        } else {
          M.toast({ html: "Error obtaining token: " + JSON.stringify(tokenData) });
        }
      } catch (error) {
        console.error("Error exchanging code:", error);
        M.toast({ html: "Error exchanging code for token" });
      }
    }
    // ----------------------------------------------------------------------
    // UPDATE LISTING
    // ----------------------------------------------------------------------
    document.getElementById("uploadToEtsyBtn").addEventListener("click", async () => {
      const listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) {
        M.toast({ html: "Please provide a listing URL or ID in 'My Etsy Shop Listings'." });
        return;
      }
      let listingId;
      if (/^\d+$/.test(listingInput)) {
        listingId = listingInput;
      } else {
        const match = listingInput.match(/\/listing\/(\d+)/);
        if (match) {
          listingId = match[1];
        } else {
          M.toast({ html: "Invalid listing URL or ID." });
          return;
        }
      }
      const payload = {
        title: document.getElementById("listingTitle").value,
        description: document.getElementById("listingDescription").value,
        tags: document.getElementById("searchKeyPhrases").value
          .split("\n").map(s => s.trim()).filter(s => s !== "")
      };
      const updateUrl =
        `/.netlify/functions/updateListing?listingId=${listingId}&token=${encodeURIComponent(accessToken)}`;
      try {
        const response = await fetch(updateUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          const errorText = await response.text();
          M.toast({ html: "Error updating listing: " + response.status + " - " + errorText });
        } else {
          M.toast({ html: "Listing updated successfully!" });
        }
      } catch (e) {
        console.error("Exception in updateExistingListing:", e);
        M.toast({ html: "Exception: " + e.message });
      }
    });
    // ----------------------------------------------------------------------
    // UPLOAD PHOTOS (includes alt_text from photoMeta)
    // ----------------------------------------------------------------------
    document.getElementById("uploadPhotoBtn").addEventListener("click", async () => {
      const listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) {
        M.toast({ html: "Please provide a listing URL or ID in 'My Etsy Shop Listings'." });
        return;
      }
      let listingId;
      if (/^\d+$/.test(listingInput)) {
        listingId = listingInput;
      } else {
        const match = listingInput.match(/\/listing\/(\d+)/);
        if (match) {
          listingId = match[1];
        } else {
          M.toast({ html: "Invalid listing URL or ID." });
          return;
        }
      }
      if (previewImages.length === 0) {
        M.toast({ html: "No images to upload. Please drag and drop images first." });
        return;
      }
      for (let i = 0; i < previewImages.length; i++) {
        const dataURL = previewImages[i];
        const altText = photoMeta[i] || "";
        const rankNumber = i + 1;
        try {
          const res = await fetch(dataURL);
          const blob = await res.blob();
          const formData = new FormData();
          formData.append("listingId", listingId);
          formData.append("token", accessToken);
          formData.append("fileName", photoNames[i] || `uploaded_photo_${i}.jpg`);
          formData.append("rank", rankNumber);
          formData.append("alt_text", altText);
          formData.append("file", blob, photoNames[i] || `uploaded_photo_${i}.jpg`);
          const uploadUrl = `/.netlify/functions/imageUpload`;
          const response = await fetch(uploadUrl, {
            method: "POST",
            body: formData
          });
          if (!response.ok) {
            M.toast({ html: `Error uploading photo #${rankNumber}: ` + response.status });
          } else {
            M.toast({ html: `Photo #${rankNumber} uploaded with alt_text!` });
          }
        } catch (e) {
          console.error(`Exception uploading photo #${rankNumber}:`, e);
          M.toast({ html: `Exception uploading photo #${rankNumber}: ${e.message}` });
        }
      }
    });
    // ----------------------------------------------------------------------
    // RULES & TITLE / DESCRIPTION GENERATION
    // ----------------------------------------------------------------------
    function stripMarkdownJSON(text) {
      return text.replace(/^```json\s*/, "").replace(/\s*```$/, "").trim();
    }
    async function generateTitleOnly() {
      const etsyLink = ETSY_SHOP_URL;
      const keyPhrases = document.getElementById("searchKeyPhrases").value.trim();
      if (!keyPhrases) {
        M.toast({ html: "Please provide the search key phrases." });
        return;
      }
      const rulesText = document.getElementById("titleRulesTextarea").value;
      const promptText = `
You are ChatGPT using ${modelName}.
Based on the inputs below, generate an Etsy Listing TITLE only.
Input Context:
Etsy Link: "${etsyLink}"
Search Key Phrases: "${keyPhrases}"
--- Rules for TITLE ---
${stripMarkdownJSON(rulesText)}
Important: Return ONLY the title as plain text.`;
      document.getElementById("listingTitle").value = "Generating title...";
      const payload = {
        model: modelName,
        messages: [
          { role: "system", content: "Return ONLY the title as plain text." },
          { role: "user", content: promptText }
        ],
        temperature: 0.7
      };
      try {
        const data = await callOpenAI(payload);
        if (data.choices && data.choices.length > 0) {
          const output = stripMarkdownJSON(data.choices[0].message.content);
          document.getElementById("listingTitle").value = output || "No title generated.";
          updateTitleCount(output);
        } else {
          document.getElementById("listingTitle").value = "No title generated.";
        }
      } catch (error) {
        document.getElementById("listingTitle").value = "Error: " + error;
      }
    }
    async function generateDescriptionOnly() {
      const etsyLink = ETSY_SHOP_URL;
      const keyPhrases = document.getElementById("searchKeyPhrases").value.trim();
      if (!keyPhrases) {
        M.toast({ html: "Please provide the search key phrases." });
        return;
      }
      const rulesText = document.getElementById("descriptionRulesTextarea").value;
      const promptText = `
You are ChatGPT using ${modelName}.
Based on the inputs below, generate an Etsy Listing DESCRIPTION only.
Input Context:
Etsy Link: "${etsyLink}"
Search Key Phrases: "${keyPhrases}"
--- Rules for DESCRIPTION ---
${stripMarkdownJSON(rulesText)}
Important: Return ONLY the description as plain text.`;
      document.getElementById("listingDescription").value = "Generating description...";
      const payload = {
        model: modelName,
        messages: [
          { role: "system", content: "Return ONLY the description as plain text." },
          { role: "user", content: promptText }
        ],
        temperature: 0.7
      };
      try {
        const data = await callOpenAI(payload);
        if (data.choices && data.choices.length > 0) {
          const output = stripMarkdownJSON(data.choices[0].message.content);
          document.getElementById("listingDescription").value = output || "No description generated.";
        } else {
          document.getElementById("listingDescription").value = "No description generated.";
        }
      } catch (error) {
        document.getElementById("listingDescription").value = "Error: " + error;
      }
    }
    async function callOpenAI(payload) {
      const response = await fetch("/.netlify/functions/openaiProxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error("API Error: " +
          (errorData.error ? errorData.error.message : response.statusText));
      }
      return await response.json();
    }
    document.getElementById("generateBtn").addEventListener("click", async () => {
      await Promise.all([generateTitleOnly(), generateDescriptionOnly()]);
    });
    document.getElementById("regenTitleBtn").addEventListener("click", generateTitleOnly);
    document.getElementById("regenDescriptionBtn").addEventListener("click", generateDescriptionOnly);
    function updateTitleCount(text) {
      document.getElementById("titleCount").textContent = "Count: " + text.length;
    }
    // Copy to clipboard
    document.getElementById("copyTitleBtn").addEventListener("click", () => {
      const text = document.getElementById("listingTitle").value;
      navigator.clipboard.writeText(text).catch(err => console.error("Copy error:", err));
    });
    document.getElementById("copyDescriptionBtn").addEventListener("click", () => {
      const text = document.getElementById("listingDescription").value;
      navigator.clipboard.writeText(text).catch(err => console.error("Copy error:", err));
    });
    document.getElementById("clearKeyPhrasesBtn").addEventListener("click", () => {
      document.getElementById("searchKeyPhrases").value = "";
    });
    document.getElementById("copyKeyPhrasesBtn").addEventListener("click", () => {
      const lines = document.getElementById("searchKeyPhrases").value
        .split(/\n+/).map(l => l.trim()).filter(l => l !== "");
      navigator.clipboard.writeText(lines.join(", "))
        .catch(err => console.error("Error copying key phrases:", err));
    });
    // Key phrase generation from "listingDescInput" if needed
    document.getElementById("listingDescInput").addEventListener("keydown", async (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        await generateTagPhrases();
      }
    });
    async function generateTagPhrases() {
      const question = document.getElementById("listingDescInput").value.trim();
      if (!question) {
        M.toast({ html: "Please enter a question in the Listing Description." });
        return;
      }
      const keywordRules = stripMarkdownJSON(document.getElementById("keywordRulesTextarea").value);
      const extraText = "Emphasis on SEO and generating effective Etsy tag phrases.";
      const prompt = `
Listing Description (for emphasis): "${question}"
${extraText}

Keyword Rules:
${keywordRules}

Generate exactly 13 tag phrases (each â‰¤ 20 characters). Return as plain text.
`;
      try {
        const payload = {
          model: modelName,
          messages: [
            { role: "system", content: "Generate tag phrases according to the provided rules." },
            { role: "user", content: prompt }
          ],
          temperature: 0.7,
          max_tokens: 500
        };
        const data = await callOpenAI(payload);
        let answer = data.choices[0].message.content;
        let phrases = answer.split(/[\n,]+/)
          .map(s => s.replace(/^\d+\.\s*/, "").trim())
          .filter(p => p)
          .join("\n");
        document.getElementById("searchKeyPhrases").value = phrases;
      } catch (err) {
        console.error("Error generating tag phrases:", err);
        M.toast({ html: "Error generating tag phrases: " + err.message });
      }
    }
    // ----------------------------------------------------------------------
    // BUTTON CONFIG
    // ----------------------------------------------------------------------
    document.getElementById("configureButtonsBtn").addEventListener("click", () => {
      const configContainer = document.getElementById("buttonConfigContainer");
      configContainer.innerHTML = "";
      const selectors = [
        "button:not(#configureButtonsBtn)",
        "#listingDescContainer",
        "#ordersDropZone",
        "#listingsDropZone",
        "#dropZone",
        "#csvProgressContainer",
        "#previewGridContainer",
        "#primaryPreview",
        "#container13",
        "#uploadedFilesList"
      ].join(", ");
      const elements = document.querySelectorAll(selectors);
      const table = document.createElement("table");
      table.className = "striped";
      const thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>Element ID</th><th>Top (px)</th><th>Left (px)</th></tr>";
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      elements.forEach(el => {
        const id = el.id;
        const computedStyle = window.getComputedStyle(el);
        const currentTop = el.style.top || computedStyle.top || "0";
        const currentLeft = el.style.left || computedStyle.left || "0";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td><input type="number" id="${id}_top" value="${parseInt(currentTop)||0}"></td>
          <td><input type="number" id="${id}_left" value="${parseInt(currentLeft)||0}"></td>
        `;
        const topInput = tr.querySelector(`#${id}_top`);
        const leftInput = tr.querySelector(`#${id}_left`);
        topInput.addEventListener("input", () => {
          el.style.top = topInput.value + "px";
        });
        leftInput.addEventListener("input", () => {
          el.style.left = leftInput.value + "px";
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      configContainer.appendChild(table);
      const modalElem = document.getElementById("buttonConfigModal");
      let modalInstance = M.Modal.getInstance(modalElem);
      if (!modalInstance) {
        modalInstance = M.Modal.init(modalElem, { preventScrolling: false });
      }
      modalInstance.open();
    });
    document.getElementById("saveButtonPositionsBtn").addEventListener("click", () => {
      const selectors = [
        "button:not(#configureButtonsBtn)",
        "#listingDescContainer",
        "#ordersDropZone",
        "#listingsDropZone",
        "#dropZone",
        "#csvProgressContainer",
        "#previewGridContainer",
        "#primaryPreview",
        "#container13",
        "#uploadedFilesList"
      ].join(", ");
      const elements = document.querySelectorAll(selectors);
      const positions = {};
      elements.forEach(el => {
        positions[el.id] = {
          top: el.style.top || "0px",
          left: el.style.left || "0px"
        };
      });
      localStorage.setItem("buttonPositions", JSON.stringify(positions));
      M.toast({ html: "Button positions saved." });
    });
    function loadButtonPositions() {
      const stored = localStorage.getItem("buttonPositions");
      if (stored) {
        const positions = JSON.parse(stored);
        for (const id in positions) {
          const el = document.getElementById(id);
          if (el) {
            el.style.top = positions[id].top;
            el.style.left = positions[id].left;
          }
        }
      }
    }
    window.addEventListener("load", () => {
      const container13 = document.getElementById("container13");
      container13.style.height = (container13.offsetHeight * 2.5) + "px";
    });
  </script>
</body>
</html>