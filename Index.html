<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Etsy Listing Generator & Shop Listings</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <!-- Import Google Material Icons and Materialize CSS -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Include piexifjs for EXIF manipulation -->
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.4/piexif.min.js"></script>
  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
  <!-- CropperJS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <style>
    /* Basic layout */
    html, body {
      margin: 0; padding: 0; width: 100vw;
      font-family: Arial, sans-serif;
    }
    .container {
      width: 100vw; padding: 10px; box-sizing: border-box;
      text-align: left;
    }
    h5, label, p { text-align: left; }
    input, textarea { width: 100%; box-sizing: border-box; }
    
    /* Listing description & file drop */
    #descriptionAndFileUploadContainer { display: flex; align-items: center; }
    .listing-desc-container { position: relative; display: inline-block; width: 500px; }
    .listing-desc-container h5 { margin: 0 0 10px 0; font-size: 1.2rem; font-weight: 500; }
    .listing-desc-container input { width: 500px; height: 30px; border: 1px solid #000; padding: 5px; }
    
    /* Search key phrases textarea */
    #searchKeyPhrases { resize: none; box-sizing: border-box; border: 1px solid grey; }
    #searchKeyPhrases[rows="14"] { height: auto; }
    
    .flex-container { display: flex; gap: 10px; align-items: stretch; }
    .textbox-container { flex: 1; }
    .textbox-container textarea { width: 100%; padding: 0.8rem; font-size: 1rem; line-height: 1.2; resize: none; overflow: visible; box-sizing: border-box; }
    .button-container { width: 200px; display: flex; flex-direction: column; gap: 10px; align-self: flex-start; }
    #listingTitle { min-height: 45px; }
    #listingDescInput { width: 500px; height: 30px; border: 1px solid #000; padding: 5px; }
    #listingDescription { min-height: 150px; width: 500px; }
    .section-heading { font-size: 1.2rem; font-weight: 500; margin-bottom: 5px; display: inline-block; }
    .count-text { font-style: italic; font-size: 0.9em; margin-top: 5px; }
    
    /* Image Drop */
    #dropZone {
      width: 712px; height: 120px; border: 2px dashed #ccc;
      border-radius: 3px; display: inline-block; vertical-align: middle;
      text-align: center; line-height: 120px; position: relative;
    }
    #uploadedFilesList {
      width: 225px; height: 125px; resize: none; box-sizing: border-box;
      border: 1px solid grey; margin-left: 85px; position: relative;
      font-size: 0.875rem; z-index: 10;
    }
    .modal { z-index: 9999 !important; }
    .modal-overlay { z-index: 9998 !important; }
    
    /* Photo Preview Grid */
    #previewGridContainer {
      position: relative; margin: 20px auto; width: auto;
      max-width: 720px; text-align: center; z-index: 2000;
    }
    #previewGridStatic {
      display: grid; grid-template-columns: repeat(5, 120px);
      grid-column-gap: 28px; grid-row-gap: 22px; margin: 0 auto;
    }
    .preview-cell {
      position: relative; width: 120px; height: 158px;
      border: 2px solid #ccc; border-radius: 3px;
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; font-size: 12px; color: #666; overflow: hidden;
    }
    .preview-cell.reserved { z-index: 2500; }
    .preview-box { position: relative; width: 100%; height: 100%; }
    .preview-box img {
      width: 120px; height: 120px; object-fit: cover;
      border-radius: 3px; display: block;
    }
    .remove-btn {
      position: absolute; top: -5px; left: -5px; width: 15px; height: 15px;
      background-color: black; color: white; font-size: 10px;
      text-align: center; cursor: pointer; z-index: 999; border-radius: 50%;
    }
    .number-overlay {
      position: absolute; top: 0; right: 0; width: 16px; height: 16px;
      background-color: rgba(0,0,0,0.7); color: white; display: flex;
      align-items: center; justify-content: center; font-size: 10px;
      z-index: 999; border-radius: 3px;
    }
    /* Metadata-status is now used solely for the green checkmark */
    .metadata-status { margin-top: 4px; text-align: center; }
    .metadata-check { color: green; font-size: 14px; }
    
    /* Other containers */
    #container13 { position: relative; width: 250px; top: -150px; }
    #belowSearch { margin-top: -180px; margin-left: 10px; }
    .title-container { margin-top: -50px; }
    #etsyListingTitleContainer { position: relative; width: 1000px; }
    #etsyListingTitleContainer textarea { width: 1000px; }
    .description-container { margin-top: 0px; }
    #etsyListingDescriptionContainer { position: relative; width: 1000px; }
    #etsyListingDescriptionContainer textarea { width: 1000px; }
    #userProvidedKeyPhrasesContainer { position: relative; top: 125px; left: 10px; }
    #topButtons { margin: 10px 0; }
    #etsyShopListingsContainer { position: relative; margin-top: 10px; margin-left: 10px; }
    #listingQueueCount {
      width: 25px; height: 25px; border: 1px solid #000;
      display: inline-flex; align-items: center; justify-content: center;
      font-weight: bold; margin-left: 5px;
    }
    .regen-btn, .copy-btn { width: 125px; }
    .update-btn { background-color: #FFA500 !important; color: white !important; }
    .drag-over { border: 2px dashed #2196f3 !important; }
  </style>
</head>
<body>
  <!-- Configure Buttons control -->
  <button id="configureButtonsBtn" class="btn waves-effect waves-light configurable">Configure Buttons</button>
  
  <!-- Listing Description and File Drop -->
  <div id="descriptionAndFileUploadContainer">
    <div class="listing-desc-container" id="listingDescContainer">
      <h5>Listing Description</h5>
      <input id="listingDescInput" type="text" placeholder="Enter your question here">
    </div>
    <textarea id="uploadedFilesList" class="materialize-textarea" rows="2" placeholder="Uploaded .csv, .doc, .docx files will appear here"></textarea>
  </div>
  
  <!-- Etsy OAuth and Shop Listings Section -->
  <div id="topButtons">
    <button id="connectEtsyBtn" class="btn waves-effect waves-light configurable">Connect to Etsy</button>
    <button id="photoUploadNewBtn" class="btn waves-effect waves-light configurable update-btn" style="margin-left: 10px;">Update Photos</button>
    <button id="uploadToEtsyBtn" class="btn waves-effect waves-light configurable update-btn" style="margin-left: 10px;">Update Info</button>
    <div id="etsyShopListingsContainer">
      <div class="section-heading configurable">Etsy Shop Listings <span id="listingQueueCount">0</span></div>
      <div class="textbox-container configurable">
        <textarea id="shopListings" class="materialize-textarea" rows="2" placeholder="Enter up to 250 comma-separated 10-digit listing IDs" style="width:500px;"></textarea>
      </div>
    </div>
  </div>
  
  <!-- Etsy Listing Generator UI -->
  <div id="userProvidedKeyPhrasesContainer" class="phrases-header configurable">
    <span class="section-heading configurable">Search Key Phrases</span>
    <button id="clearKeyPhrasesBtn" class="btn-small waves-effect waves-light configurable">Clear</button>
    <button id="copyKeyPhrasesBtn" class="btn-small waves-effect waves-light configurable copy-btn">Copy</button>
    <div id="dropZone" class="configurable">Image Drop</div>
    <!-- Analyze Photos button (now only triggers embedding alt-text) -->
    <button id="analyzeMetadataBtn" class="btn waves-effect waves-light configurable">Analyze Photos</button>
    <button id="showAnalyzeRulesBtn" class="btn waves-effect waves-light configurable" data-target="analyzeRulesModal" style="margin-top:25px;">Analyze Rules</button>
  </div>
  <div id="container13" class="flex-container configurable">
    <div class="textbox-container configurable">
      <textarea id="searchKeyPhrases" class="materialize-textarea" rows="14"></textarea>
    </div>
  </div>
  
  <!-- Components below Search Key Phrases -->
  <div id="belowSearch">
    <button id="generateBtn" class="btn waves-effect waves-light configurable">Generate</button>
    <!-- Etsy Listing TITLE container -->
    <div id="etsyListingTitleContainer" class="title-container" style="margin-top: -50px;">
      <div class="section-heading configurable">Etsy Listing TITLE</div>
      <div class="flex-container configurable">
        <div class="textbox-container configurable">
          <textarea id="listingTitle" class="materialize-textarea" rows="2" style="width:1000px;"></textarea>
        </div>
        <div class="button-container configurable" style="margin-top: -60px;">
          <button id="regenTitleBtn" class="btn-small waves-effect waves-light configurable regen-btn">Re-Gen</button>
          <button id="copyTitleBtn" class="btn-small waves-effect waves-light configurable copy-btn"><i class="material-icons">content_copy</i></button>
        </div>
        <button id="showTitleRulesBtn" class="btn waves-effect waves-light rules-button configurable" data-target="titleRulesModal" style="display:none;">Title Rules</button>
      </div>
      <p id="titleCount" class="count-text configurable">Count: 0</p>
    </div>
    
    <!-- Etsy Listing DESCRIPTION container -->
    <div id="etsyListingDescriptionContainer" class="description-container" style="margin-top: 0px;">
      <div class="section-heading configurable">Etsy Listing DESCRIPTION</div>
      <div class="flex-container configurable">
        <div class="textbox-container configurable">
          <textarea id="listingDescription" class="materialize-textarea" style="width:1000px;"></textarea>
        </div>
        <div class="button-container configurable">
          <button id="regenDescriptionBtn" class="btn-small waves-effect waves-light configurable regen-btn">Re-Gen</button>
          <button id="copyDescriptionBtn" class="btn-small waves-effect waves-light configurable copy-btn"><i class="material-icons">content_copy</i></button>
        </div>
        <button id="showDescriptionRulesBtn" class="btn waves-effect waves-light rules-button configurable" data-target="descriptionRulesModal" style="display:none;">Description Rules</button>
      </div>
    </div>
  </div>
  
  <!-- Static 10-Photo Preview Grid -->
  <div id="previewGridContainer">
    <div id="previewGridStatic">
      <div class="preview-cell" id="previewCell0">Empty</div>
      <div class="preview-cell" id="previewCell1">Empty</div>
      <div class="preview-cell" id="previewCell2">Empty</div>
      <div class="preview-cell" id="previewCell3">Empty</div>
      <div class="preview-cell" id="previewCell4">Empty</div>
      <div class="preview-cell" id="previewCell5">Empty</div>
      <div class="preview-cell" id="previewCell6">Empty</div>
      <div class="preview-cell reserved" id="previewCell7">Empty</div>
      <div class="preview-cell reserved" id="previewCell8">Empty</div>
      <div class="preview-cell reserved" id="previewCell9">Empty</div>
    </div>
  </div>
  
  <!-- Analyze Rules Modal -->
  <div id="analyzeRulesModal" class="modal">
    <div class="modal-content">
      <h4>Photo Analysis Rules</h4>
      <textarea id="analyzeRulesTextarea" style="width:100%; height:300px;">
Default Photo Analysis Rules:
1. Use SEO-friendly descriptive long-tail key phrases without special characters.
2. Emphasize jewelry details (e.g., charm description) only.
3. Organize into a short paragraph.
4. Limit the description to 300 characters.
5. Do not mention earrings unless specified.
6. Do not mix necklace and earring descriptions.
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateAnalyzeRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Title Rules Modal -->
  <div id="titleRulesModal" class="modal">
    <div class="modal-content">
      <h4>Title Rules</h4>
      <textarea id="titleRulesTextarea" style="width:100%; height:300px;">
Title Structure & Formatting:
- Create 5-7 SEO optimized long-tail key phrases (3-5 words each).
- Title must begin with product type.
- Return only the title as plain text.
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateTitleRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Description Rules Modal -->
  <div id="descriptionRulesModal" class="modal">
    <div class="modal-content">
      <h4>Description Rules</h4>
      <textarea id="descriptionRulesTextarea" style="width:100%; height:300px;">
Rules for Description:
- Merge key phrases with your output.
- Keep output paragraph under 200 characters.
Example:
"Discover the beauty of our delicate gold key pendant necklace, perfect for adding a touch of elegance to any outfit. Ideal for everyday wear or special occasions."
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateDescriptionRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Keyword Rules Modal -->
  <div id="keywordRulesModal" class="modal">
    <div class="modal-content">
      <h4>Keyword Rules</h4>
      <textarea id="keywordRulesTextarea" style="width:100%; height:300px;">
Using Sales Report Files:
- Generate exactly 13 SEO key phrases, each ≤ 20 characters.
- Include "Gift for Her" and ensure "Charm" appears at least once.
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateKeywordRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Button Config Modal -->
  <div id="buttonConfigModal" class="modal">
    <div class="modal-content">
      <h4>Configure Button Positions</h4>
      <div id="buttonConfigContainer"></div>
      <textarea id="uploadedFilesListModal" class="materialize-textarea" rows="2" placeholder="Uploaded files will appear here"></textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="saveButtonPositionsBtn" class="modal-close waves-effect waves-green btn">Save Positions</a>
    </div>
  </div>
  
  <!-- Crop Modal -->
  <div id="photoCropModal" class="modal" style="width:650px; height:650px;">
    <div class="crop-container" style="position: relative; width: 100%; height: 100%;">
      <h4 style="text-align:center; margin: 0 0 10px 0;">Crop Photo</h4>
      <div class="img-preview-container" style="width:400px; height:400px; margin: 0 auto; overflow: hidden;">
        <img id="cropImage" src="" alt="Crop Image" style="display:block; margin:auto; max-width: none;">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <button id="saveCropBtn" class="btn waves-effect waves-light" style="margin-right:10px;">Save</button>
        <button id="cancelCropBtn" class="btn waves-effect waves-light" style="background-color:#f44336;">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Include jQuery and Materialize JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  
  <script>
    // Helper function (pass-through)
    function stripMarkdownJSON(text) { return text; }
    
    // GLOBALS
    const ETSY_SHOP_URL = "https://www.etsy.com/shop/custombrites";
    const CLIENT_ID = "k75zdspz4r99txpqdji7i2em";
    const REDIRECT_URI = "https://delicate-tanuki-616ac0.netlify.app/";
    const modelName = "chatgpt-4o-latest";
    let accessToken;
    let soldOrdersCSV = [];
    let listingsCSV = [];
    let photoNames = [];
    let previewImages = []; // Data URLs for display
    // Store metadata per photo { title, description, keywords }
    let photoMeta = [];
    let draggedIndex = null;
    let photoIds = [];
    let currentCropIndex = null;
    let cropper = null;
    let reservedPhotos = [];
    let listingQueue = [];
    let photoUpdateComplete = false;
    let infoUpdateComplete = false;
    
    const appendedDescriptionText = `...`; // (Your appended text remains unchanged)
    
    // Persist and restore functions...
    function persistDataBeforeRedirect() {
      try {
        localStorage.setItem("soldOrdersCSV", JSON.stringify(soldOrdersCSV));
        localStorage.setItem("listingsCSV", JSON.stringify(listingsCSV));
        localStorage.setItem("shopListingsText", document.getElementById("shopListings").value || "");
        localStorage.setItem("listingQueue", JSON.stringify(listingQueue));
      } catch (err) { console.error("Error persisting data:", err); }
    }
    function restoreDataAfterRedirect() {
      try {
        let soCSV = localStorage.getItem("soldOrdersCSV");
        if (soCSV) soldOrdersCSV = JSON.parse(soCSV);
        let liCSV = localStorage.getItem("listingsCSV");
        if (liCSV) listingsCSV = JSON.parse(liCSV);
        let shopText = localStorage.getItem("shopListingsText");
        if (shopText) document.getElementById("shopListings").value = shopText;
        let storedQueue = localStorage.getItem("listingQueue");
        if (storedQueue) listingQueue = JSON.parse(storedQueue);
        loadNextListingInQueue();
      } catch (err) { console.error("Restore error:", err); }
    }
    
    // Utility & Queue Helpers
    function parseListingNumbers(rawInput) {
      let parts = rawInput.split(",");
      let cleaned = parts.map(p => p.trim()).filter(p => /^\d{10}$/.test(p));
      return Array.from(new Set(cleaned)).slice(0,250);
    }
    function updateListingQueueCount() {
      document.getElementById("listingQueueCount").textContent = listingQueue.length;
    }
    function loadNextListingInQueue() {
      photoUpdateComplete = false; infoUpdateComplete = false;
      document.getElementById("shopListings").value = listingQueue.length ? listingQueue[0] : "";
      updateListingQueueCount();
    }
    function afterBothUpdates() { listingQueue.shift(); loadNextListingInQueue(); }
    function checkIfBothUpdatesComplete() { if (photoUpdateComplete && infoUpdateComplete) afterBothUpdates(); }
    
    // Page Initialization & File Handling functions (unchanged)
    function updateUploadedFilesList() { /* ... */ }
    function loadReservedPhotos() { const stored = localStorage.getItem("reservedPhotos"); reservedPhotos = stored ? JSON.parse(stored) : []; }
    function saveReservedPhotos() { localStorage.setItem("reservedPhotos", JSON.stringify(reservedPhotos)); }
    async function resizeImage(dataURL, width, height) { /* ... */ }
    async function uploadCSVFile(file) { /* ... */ }
    async function uploadDocFile(file) { /* ... */ }
    async function updateVectorStore() { /* ... */ }
    
    const uploadedFilesList = document.getElementById("uploadedFilesList");
    uploadedFilesList.addEventListener("dragover", e => { e.preventDefault(); e.stopPropagation(); uploadedFilesList.style.borderColor = "#000"; });
    uploadedFilesList.addEventListener("dragleave", e => { e.preventDefault(); e.stopPropagation(); uploadedFilesList.style.borderColor = "#ccc"; });
    uploadedFilesList.addEventListener("drop", async e => { 
      e.preventDefault(); e.stopPropagation(); uploadedFilesList.style.borderColor = "#ccc";
      const files = e.dataTransfer.files;
      for (let file of files) {
        if (/\.(csv|doc|docx)$/i.test(file.name)) {
          try { 
            const fileData = file.name.endsWith(".csv") ? await uploadCSVFile(file) : await uploadDocFile(file);
            soldOrdersCSV.push(fileData);
            updateUploadedFilesList(); await updateVectorStore();
          } catch (err) { console.error(err); }
        } else { alert("Only .csv, .doc, and .docx files supported."); }
      }
    });
    
    const dropZone = document.getElementById("dropZone");
    dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.style.borderColor = "#000"; });
    dropZone.addEventListener("dragleave", e => { e.preventDefault(); dropZone.style.borderColor = "#ccc"; });
    dropZone.addEventListener("drop", async e => {
      e.preventDefault(); dropZone.style.borderColor = "#ccc";
      const files = e.dataTransfer.files;
      const maxRemaining = 10 - previewImages.length;
      for (let i = 0; i < Math.min(files.length, maxRemaining); i++) {
        let file = files[i];
        if (/image\/(jpeg|png)/.test(file.type)) {
          try {
            const dataURL = await new Promise((resolve, reject) => { 
              const reader = new FileReader(); reader.onload = event => resolve(event.target.result); reader.onerror = reject; reader.readAsDataURL(file); 
            });
            const resizedDataURL = await resizeImage(dataURL, 3000, 3000);
            previewImages.push(resizedDataURL); photoNames.push(file.name); photoIds.push('img-' + Date.now() + '-' + i);
            updateStaticPreviewGrid(); updateUploadedFilesList();
          } catch (err) { console.error(err); }
        } else { M.toast({ html: "Only JPEG/PNG images supported." }); }
      }
    });
    
    // Photo Preview Logic
    function updateStaticPreviewGrid() {
      for (let i = 0; i < 10; i++) {
        let cell = document.getElementById("previewCell" + i);
        if (!cell) continue;
        cell.innerHTML = "Empty";
        if (i < 7) {  // non-reserved
          if (i < previewImages.length && previewImages[i]) {
            cell.innerHTML = "";
            let previewBox = document.createElement("div");
            previewBox.className = "preview-box";
            previewBox.setAttribute("data-id", photoIds[i] || "");
            previewBox.setAttribute("draggable", "true");
            previewBox.addEventListener("dragstart", e => { draggedIndex = i; });
            let img = document.createElement("img");
            img.src = previewImages[i];
            previewBox.appendChild(img);
            let removeBtn = document.createElement("div");
            removeBtn.className = "remove-btn"; removeBtn.textContent = "X";
            removeBtn.addEventListener("click", ev => { ev.stopPropagation(); previewImages.splice(i, 1); photoNames.splice(i, 1); photoMeta.splice(i, 1); photoIds.splice(i, 1); updateStaticPreviewGrid(); });
            previewBox.appendChild(removeBtn);
            let numOverlay = document.createElement("div");
            numOverlay.className = "number-overlay"; numOverlay.textContent = (i + 1).toString();
            previewBox.appendChild(numOverlay);
            let cropBtn = document.createElement("button");
            cropBtn.textContent = "Crop"; cropBtn.style.position = "absolute"; cropBtn.style.bottom = "2px"; cropBtn.style.right = "2px"; cropBtn.style.width = "20px"; cropBtn.style.height = "20px"; cropBtn.style.borderRadius = "50%"; cropBtn.style.backgroundColor = "green"; cropBtn.style.color = "white"; cropBtn.style.fontSize = "10px";
            cropBtn.addEventListener("click", ev => { ev.stopPropagation(); openCropModal(i); });
            previewBox.appendChild(cropBtn);
            // Instead of adding metadata text, we only show a checkmark if metadata is saved
            let statusDiv = document.createElement("div");
            statusDiv.className = "metadata-status"; statusDiv.id = "metadataStatus" + i;
            previewBox.appendChild(statusDiv);
            cell.appendChild(previewBox);
          } else {
            cell.innerHTML = "Empty";
            let statusDiv = document.createElement("div");
            statusDiv.className = "metadata-status"; statusDiv.id = "metadataStatus" + i;
            cell.appendChild(statusDiv);
          }
        } else {  // reserved cells (similar handling)
          let rIndex = i - 7;
          if (rIndex < reservedPhotos.length && reservedPhotos[rIndex] && reservedPhotos[rIndex].src) {
            cell.innerHTML = "";
            let previewBox = document.createElement("div");
            previewBox.className = "preview-box";
            previewBox.setAttribute("data-id", reservedPhotos[rIndex].id || "");
            previewBox.setAttribute("draggable", "true");
            previewBox.addEventListener("dragstart", e => { draggedIndex = i; });
            let img = document.createElement("img");
            img.src = reservedPhotos[rIndex].src;
            previewBox.appendChild(img);
            let removeBtn = document.createElement("div");
            removeBtn.className = "remove-btn"; removeBtn.textContent = "X";
            removeBtn.addEventListener("click", ev => { ev.stopPropagation(); reservedPhotos.splice(rIndex, 1); saveReservedPhotos(); updateStaticPreviewGrid(); });
            previewBox.appendChild(removeBtn);
            let numOverlay = document.createElement("div");
            numOverlay.className = "number-overlay"; numOverlay.textContent = (i + 1).toString();
            previewBox.appendChild(numOverlay);
            let statusDiv = document.createElement("div");
            statusDiv.className = "metadata-status"; statusDiv.id = "metadataStatus" + i;
            previewBox.appendChild(statusDiv);
            cell.appendChild(previewBox);
          } else {
            cell.innerHTML = "Empty";
            let statusDiv = document.createElement("div");
            statusDiv.className = "metadata-status"; statusDiv.id = "metadataStatus" + i;
            cell.appendChild(statusDiv);
          }
        }
      }
    }
    
    function initializeCellDragAndDrop() {
      for (let i = 0; i < 10; i++) {
        let cell = document.getElementById("previewCell" + i);
        if (!cell.dataset.listenersAttached) {
          cell.addEventListener("dragover", function(e) { e.preventDefault(); this.classList.add("drag-over"); });
          cell.addEventListener("dragleave", function(e) { e.preventDefault(); this.classList.remove("drag-over"); });
          cell.addEventListener("drop", async function(e) {
            e.preventDefault(); this.classList.remove("drag-over");
            let cellIndex = parseInt(this.id.replace("previewCell", ""));
            if (cellIndex < 7) {
              if (draggedIndex !== null && draggedIndex !== cellIndex && previewImages[draggedIndex]) {
                const [movedImage] = previewImages.splice(draggedIndex, 1);
                previewImages.splice(cellIndex, 0, movedImage);
                const [movedName] = photoNames.splice(draggedIndex, 1);
                photoNames.splice(cellIndex, 0, movedName);
                const [movedMeta] = photoMeta.splice(draggedIndex, 1);
                photoMeta.splice(cellIndex, 0, movedMeta);
                const [movedId] = photoIds.splice(draggedIndex, 1);
                photoIds.splice(cellIndex, 0, movedId);
                updateStaticPreviewGrid();
                draggedIndex = null;
              }
            } else {
              let rIndex = cellIndex - 7;
              if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                let file = e.dataTransfer.files[0];
                if (/image\/(jpeg|png)/.test(file.type)) {
                  const reader = new FileReader();
                  reader.onload = async ev => {
                    try {
                      const dataURL = ev.target.result;
                      const resizedDataURL = await resizeImage(dataURL, 3000, 3000);
                      let newReserved = { src: resizedDataURL, name: file.name, meta: "", id: 'img-' + Date.now() };
                      reservedPhotos[rIndex] = newReserved;
                      saveReservedPhotos();
                      updateStaticPreviewGrid();
                    } catch (err) { console.error(err); }
                  };
                  reader.readAsDataURL(file);
                }
              } else if (draggedIndex !== null && draggedIndex !== cellIndex) {
                if (draggedIndex < 7) {
                  const [movedImage] = previewImages.splice(draggedIndex, 1);
                  const [movedName] = photoNames.splice(draggedIndex, 1);
                  const [movedMeta] = photoMeta.splice(draggedIndex, 1);
                  const [movedId] = photoIds.splice(draggedIndex, 1);
                  let newReserved = { src: movedImage, name: movedName, meta: movedMeta || "", id: movedId };
                  reservedPhotos[rIndex] = newReserved;
                  saveReservedPhotos();
                } else {
                  let oldRIndex = draggedIndex - 7;
                  const [moved] = reservedPhotos.splice(oldRIndex, 1);
                  reservedPhotos[rIndex] = moved;
                  saveReservedPhotos();
                }
                updateStaticPreviewGrid();
                draggedIndex = null;
              }
            }
          });
          cell.dataset.listenersAttached = "true";
        }
      }
    }
    
    // --- New: Analyze a photo, embed description as alt-text (EXIF) and show green checkmark ---
    function dataURLtoBlob(dataurl) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length, u8arr = new Uint8Array(n);
      while (n--) { u8arr[n] = bstr.charCodeAt(n); }
      return new Blob([u8arr], { type: mime });
    }
    
    // We no longer display the full metadata text. Instead, we insert the description (trimmed to 200 chars)
    // into the EXIF field "ImageDescription" using piexifjs.
    async function analyzePhoto(index) {
      const dataUrl = previewImages[index];
      const blob = dataURLtoBlob(dataUrl);
      const formData = new FormData();
      formData.append("imageFile", blob, "analyzed_photo_" + index + ".jpg");
      formData.append("rules", "Analyze the image and extract SEO-friendly metadata including Title, Description, and Keywords.");
      try {
        const response = await fetch("/.netlify/functions/analyzeImage", { method: "POST", body: formData });
        if (!response.ok) {
          const errorText = await response.text();
          updateMetadataStatus(index, { error: "Error: " + errorText });
          return;
        }
        const result = await response.json();
        const metadataText = result.metadata || "";
        // Parse metadata (we only need the description)
        const parsed = (function parseMetadata(text) {
          const metadata = { description: "" };
          const descriptionMatch = text.match(/(?:\*\*Description\*\*:\s*)(.*)/i);
          if (descriptionMatch) { metadata.description = descriptionMatch[1].trim(); }
          return metadata;
        })(metadataText);
        // Embed the description (first 200 chars) into the JPEG's EXIF "ImageDescription" field
        let altText = parsed.description.substring(0,200);
        let exifObj = piexif.load(previewImages[index]);
        if (!exifObj["0th"]) exifObj["0th"] = {};
        exifObj["0th"][piexif.ImageIFD.ImageDescription] = altText;
        let exifBytes = piexif.dump(exifObj);
        previewImages[index] = piexif.insert(exifBytes, previewImages[index]);
        // Save the metadata for later use (if needed)
        photoMeta[index] = parsed;
        // Update UI to show a green checkmark
        updateMetadataStatus(index, { success: true });
      } catch (error) {
        updateMetadataStatus(index, { error: "Exception: " + error.message });
      }
    }
    
    // Analyze all non-reserved photos (indexes 0-6)
    document.getElementById("analyzeMetadataBtn").addEventListener("click", async () => {
      const maxPhotos = Math.min(previewImages.length, 7);
      for (let i = 0; i < maxPhotos; i++) {
        if (!photoMeta[i]) {
          await analyzePhoto(i);
        }
      }
    });
    
    // Update metadata-status div: only show green checkmark on success or error message.
    function updateMetadataStatus(index, data) {
      const statusDiv = document.getElementById("metadataStatus" + index);
      if (data.success) {
        statusDiv.innerHTML = `<div class="metadata-check"><i class="material-icons">check_circle</i></div>`;
      } else if (data.error) {
        statusDiv.innerHTML = `<span style="color:red;">${data.error}</span>`;
      }
    }
    
    // OAuth & Startup functions (unchanged)
    function generateRandomString(length) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let text = '';
      for (let i = 0; i < length; i++) { text += possible.charAt(Math.floor(Math.random() * possible.length)); }
      return text;
    }
    function base64urlEncode(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
    async function generateCodeChallenge(codeVerifier) {
      let encoder = new TextEncoder();
      let data = encoder.encode(codeVerifier);
      let digest = await crypto.subtle.digest("SHA-256", data);
      return base64urlEncode(digest);
    }
    document.getElementById("connectEtsyBtn").addEventListener("click", async () => {
      persistDataBeforeRedirect();
      let state = "randomState123";
      let scope = "listings_w listings_r";
      let codeVerifier = generateRandomString(64);
      localStorage.setItem("etsy_code_verifier", codeVerifier);
      let codeChallenge = await generateCodeChallenge(codeVerifier);
      let etsyAuthUrl = `https://www.etsy.com/oauth/connect?response_type=code&client_id=${CLIENT_ID}` +
        `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
        `&scope=${encodeURIComponent(scope)}` +
        `&state=${state}` +
        `&code_challenge=${encodeURIComponent(codeChallenge)}` +
        `&code_challenge_method=S256`;
      window.location.href = etsyAuthUrl;
    });
    document.addEventListener("DOMContentLoaded", () => {
      loadButtonPositions();
      loadReservedPhotos();
      restoreDataAfterRedirect();
      let urlParams = new URLSearchParams(window.location.search);
      let code = urlParams.get("code");
      if (code) {
        exchangeCodeForToken(code);
        window.history.replaceState({}, document.title, REDIRECT_URI);
      }
      updateStaticPreviewGrid();
      initializeCellDragAndDrop();
      document.getElementById("shopListings").addEventListener("change", () => {
        let rawInput = document.getElementById("shopListings").value;
        listingQueue = parseListingNumbers(rawInput);
        loadNextListingInQueue();
      });
    });
    async function exchangeCodeForToken(code) {
      let codeVerifier = localStorage.getItem("etsy_code_verifier");
      if (!codeVerifier) {
        M.toast({ html: "No code verifier found. Please try connecting again." });
        return;
      }
      try {
        let response = await fetch(`/.netlify/functions/exchangeToken?code=${encodeURIComponent(code)}&code_verifier=${encodeURIComponent(codeVerifier)}`);
        let tokenData = await response.json();
        if (tokenData.access_token) {
          accessToken = tokenData.access_token;
          M.toast({ html: "Connected to Etsy!" });
        } else {
          M.toast({ html: "Error obtaining token: " + JSON.stringify(tokenData) });
        }
      } catch (error) {
        console.error(error);
        M.toast({ html: "Error exchanging code for token" });
      }
    }
    document.getElementById("uploadToEtsyBtn").addEventListener("click", async () => {
      let listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) {
        M.toast({ html: "Please provide a listing URL or ID in 'Etsy Shop Listings'." });
        return;
      }
      let listingId = /^\d+$/.test(listingInput) ? listingInput : (listingInput.match(/\/listing\/(\d+)/) || [])[1];
      if (!listingId) { M.toast({ html: "Invalid listing URL or ID." }); return; }
      let userDescription = document.getElementById("listingDescription").value || "";
      let finalDescription = userDescription + appendedDescriptionText; 
      let payload = {
        title: document.getElementById("listingTitle").value,
        description: finalDescription,
        tags: document.getElementById("searchKeyPhrases").value.split("\n").map(s => s.trim()).filter(s => s !== "")
      };
      let updateUrl = `/.netlify/functions/updateListing?listingId=${listingId}&token=${encodeURIComponent(accessToken)}`;
      try {
        let response = await fetch(updateUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          let errorText = await response.text();
          M.toast({ html: "Error updating listing: " + response.status + " - " + errorText });
        } else {
          M.toast({ html: "Listing info updated successfully!" });
          infoUpdateComplete = true;
          checkIfBothUpdatesComplete();
        }
      } catch (e) {
        console.error(e);
        M.toast({ html: "Exception: " + e.message });
      }
    });
    document.getElementById("photoUploadNewBtn").addEventListener("click", async () => {
      let listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) { M.toast({ html: "Please provide a listing URL or ID in 'Etsy Shop Listings'." }); return; }
      let btn = document.getElementById("photoUploadNewBtn"); btn.disabled = true;
      try {
        await uploadPhotos();
        await uploadReservedPhotos();
        M.toast({ html: "Photos updated successfully!" });
        photoUpdateComplete = true;
        checkIfBothUpdatesComplete();
      } catch (err) {
        console.error(err);
      } finally { btn.disabled = false; }
    });
    
    // Upload photos (with alt-text now coming from embedded EXIF)
    async function uploadPhotos() {
      let listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) { M.toast({ html: "Please provide a listing URL or ID in 'Etsy Shop Listings'." }); return; }
      if (!previewImages.length) { M.toast({ html: "No images to upload. Please drag and drop images first." }); return; }
      let listingId = /^\d+$/.test(listingInput) ? listingInput : (listingInput.match(/\/listing\/(\d+)/) || [])[1];
      if (!listingId) { M.toast({ html: "Invalid listing URL or ID." }); return; }
      for (let i = 0; i < previewImages.length; i++) {
        let dataURL = previewImages[i];
        // altText is now already embedded into the JPEG via EXIF
        let rankNumber = i + 1;
        try {
          let res = await fetch(dataURL);
          let blob = await res.blob();
          let formData = new FormData();
          formData.append("listingId", listingId);
          formData.append("token", accessToken);
          formData.append("fileName", photoNames[i] || `uploaded_photo_${i}.jpg`);
          formData.append("rank", rankNumber);
          // No need to add alt_text separately; it’s embedded in the JPEG EXIF.
          formData.append("file", blob, photoNames[i] || `uploaded_photo_${i}.jpg`);
          let uploadUrl = `/.netlify/functions/imageUpload`;
          let response = await fetch(uploadUrl, { method: "POST", body: formData });
          if (!response.ok) { M.toast({ html: `Error uploading photo #${rankNumber}: ` + response.status }); }
          else { M.toast({ html: `Photo #${rankNumber} uploaded successfully!` }); }
        } catch (e) {
          console.error(e);
          M.toast({ html: `Exception uploading photo #${rankNumber}: ${e.message}` });
        }
      }
    }
    window.uploadPhotos = uploadPhotos;
    async function uploadReservedPhotos() {
      let listingInput = document.getElementById("shopListings").value.trim();
      if (!listingInput) { M.toast({ html: "Please provide a listing URL or ID in 'Etsy Shop Listings'." }); return; }
      if (!reservedPhotos.length) { M.toast({ html: "No reserved photos to upload." }); return; }
      let listingId = /^\d+$/.test(listingInput) ? listingInput : (listingInput.match(/\/listing\/(\d+)/) || [])[1];
      if (!listingId) { M.toast({ html: "Invalid listing URL or ID." }); return; }
      for (let i = 0; i < reservedPhotos.length; i++) {
        let dataURL = reservedPhotos[i].src;
        let rankNumber = i + 8;
        try {
          let res = await fetch(dataURL);
          let blob = await res.blob();
          let formData = new FormData();
          formData.append("listingId", listingId);
          formData.append("token", accessToken);
          formData.append("fileName", reservedPhotos[i].name || `reserved_photo_${i}.jpg`);
          formData.append("rank", rankNumber);
          formData.append("file", blob, reservedPhotos[i].name || `reserved_photo_${i}.jpg`);
          let uploadUrl = `/.netlify/functions/imageUpload`;
          let response = await fetch(uploadUrl, { method: "POST", body: formData });
          if (!response.ok) { M.toast({ html: `Error uploading reserved photo #${rankNumber}: ` + response.status }); }
          else { M.toast({ html: `Reserved photo #${rankNumber} uploaded successfully!` }); }
        } catch (e) {
          console.error(e);
          M.toast({ html: `Exception uploading reserved photo #${rankNumber}: ${e.message}` });
        }
      }
    }
    
    // Title & Description Generation (unchanged)
    document.getElementById("listingDescInput").addEventListener("keydown", async (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); await generateTagPhrases(); } });
    document.getElementById("generateBtn").addEventListener("click", async () => { await Promise.all([generateTitleOnly(), generateDescriptionOnly()]); });
    async function generateTitleOnly() { /* ... (same as before) ... */ }
    async function generateDescriptionOnly() { /* ... (same as before) ... */ }
    async function callOpenAI(payload) {
      let response = await fetch("/.netlify/functions/openaiProxy", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      if (!response.ok) { let errorData = await response.json(); throw new Error("API Error: " + (errorData.error ? errorData.error.message : response.statusText)); }
      return await response.json();
    }
    function updateTitleCount(text) { document.getElementById("titleCount").textContent = "Count: " + text.length; }
    document.getElementById("copyTitleBtn").addEventListener("click", () => { navigator.clipboard.writeText(document.getElementById("listingTitle").value).catch(err => console.error("Copy error:", err)); });
    document.getElementById("copyDescriptionBtn").addEventListener("click", () => { navigator.clipboard.writeText(document.getElementById("listingDescription").value).catch(err => console.error("Copy error:", err)); });
    document.getElementById("clearKeyPhrasesBtn").addEventListener("click", () => { document.getElementById("searchKeyPhrases").value = ""; });
    document.getElementById("copyKeyPhrasesBtn").addEventListener("click", () => { let lines = document.getElementById("searchKeyPhrases").value.split(/\n+/).map(l => l.trim()).filter(l => l !== ""); navigator.clipboard.writeText(lines.join(", ")).catch(err => console.error("Error copying key phrases:", err)); });
    document.getElementById("configureButtonsBtn").addEventListener("click", () => {
      let configContainer = document.getElementById("buttonConfigContainer"); configContainer.innerHTML = "";
      const selectors = ["#configureButtonsBtn","#listingDescContainer","#uploadedFilesList","#dropZone","#previewGridContainer","#container13","#uploadToEtsyBtn","#etsyShopListingsContainer","#userProvidedKeyPhrasesContainer","#etsyListingTitleContainer","#etsyListingDescriptionContainer","#regenTitleBtn","#copyTitleBtn","#regenDescriptionBtn","#copyDescriptionBtn","#photoUploadNewBtn","#generateBtn","#connectEtsyBtn","#analyzeMetadataBtn","#showAnalyzeRulesBtn"].join(", ");
      let elements = document.querySelectorAll(selectors);
      let table = document.createElement("table"); table.className = "striped";
      let thead = document.createElement("thead"); thead.innerHTML = "<tr><th>Element ID</th><th>Top (px)</th><th>Left (px)</th></tr>";
      table.appendChild(thead);
      let tbody = document.createElement("tbody");
      elements.forEach(el => {
        let id = el.id;
        let computedStyle = window.getComputedStyle(el);
        let currentTop = el.style.top || computedStyle.top || "0";
        let currentLeft = el.style.left || computedStyle.left || "0";
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${id}</td><td><input type="number" id="${id}_top" value="${parseInt(currentTop)||0}"></td><td><input type="number" id="${id}_left" value="${parseInt(currentLeft)||0}"></td>`;
        tr.querySelector(`#${id}_top`).addEventListener("input", () => { el.style.top = el.style.top = document.getElementById(id+"_top").value + "px"; });
        tr.querySelector(`#${id}_left`).addEventListener("input", () => { el.style.left = document.getElementById(id+"_left").value + "px"; });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      configContainer.appendChild(table);
      let modalElem = document.getElementById("buttonConfigModal");
      let modalInstance = M.Modal.getInstance(modalElem) || M.Modal.init(modalElem, { preventScrolling: false });
      modalInstance.open();
    });
    document.getElementById("saveButtonPositionsBtn").addEventListener("click", () => {
      const selectors = ["#configureButtonsBtn","#listingDescContainer","#uploadedFilesList","#dropZone","#previewGridContainer","#container13","#uploadToEtsyBtn","#etsyShopListingsContainer","#userProvidedKeyPhrasesContainer","#etsyListingTitleContainer","#etsyListingDescriptionContainer","#regenTitleBtn","#copyTitleBtn","#regenDescriptionBtn","#copyDescriptionBtn","#photoUploadNewBtn","#generateBtn","#connectEtsyBtn","#analyzeMetadataBtn","#showAnalyzeRulesBtn"].join(", ");
      let elements = document.querySelectorAll(selectors);
      let positions = {};
      elements.forEach(el => { positions[el.id] = { top: el.style.top || "0px", left: el.style.left || "0px" }; });
      localStorage.setItem("buttonPositions", JSON.stringify(positions));
      M.toast({ html: "Button positions saved." });
    });
    function loadButtonPositions() {
      let stored = localStorage.getItem("buttonPositions");
      if (stored) { let positions = JSON.parse(stored); for (let id in positions) { let el = document.getElementById(id); if (el) { el.style.top = positions[id].top; el.style.left = positions[id].left; } } }
    }
    window.addEventListener("load", () => {
      let container13 = document.getElementById("container13");
      container13.style.height = (container13.offsetHeight * 2.5) + "px";
    });
    function openCropModal(index) {
      currentCropIndex = index;
      let cropModal = document.getElementById("photoCropModal");
      let cropImage = document.getElementById("cropImage");
      cropImage.src = previewImages[index];
      cropImage.onload = function() {
        cropper = new Cropper(cropImage, {
          viewMode: 1, autoCropArea: 1, movable: true, zoomable: true, scalable: false, rotatable: false,
          responsive: true, background: false, modal: true, guides: true, center: true, highlight: true,
          cropBoxMovable: true, cropBoxResizable: true, dragMode: 'move',
          ready: function() {
            let containerData = cropper.getContainerData();
            let cropBoxData = cropper.getCropBoxData();
            cropper.setCropBoxData({ left: (containerData.width - cropBoxData.width) / 2, top: (containerData.height - cropBoxData.height) / 2 });
          }
        });
      };
      let instance = M.Modal.getInstance(cropModal) || M.Modal.init(cropModal, {});
      instance.open();
    }
    document.getElementById("saveCropBtn").addEventListener("click", () => {
      if (cropper && currentCropIndex !== null) {
        let croppedCanvas = cropper.getCroppedCanvas({ width: 3000, height: 3000 });
        previewImages[currentCropIndex] = croppedCanvas.toDataURL("image/jpeg", 0.85);
        updateStaticPreviewGrid();
        cropper.destroy();
        cropper = null;
        currentCropIndex = null;
        M.Modal.getInstance(document.getElementById("photoCropModal")).close();
      }
    });
    document.getElementById("cancelCropBtn").addEventListener("click", () => {
      if (cropper) { cropper.destroy(); cropper = null; }
      currentCropIndex = null;
      M.Modal.getInstance(document.getElementById("photoCropModal")).close();
    });
    
    // Title & Description Generation functions remain unchanged...
    // (generateTitleOnly, generateDescriptionOnly, callOpenAI, updateTitleCount, etc.)
    
  </script>
</body>
</html>