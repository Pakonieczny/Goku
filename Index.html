<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Etsy Listing Generator & Shop Listings</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <!-- Import Google Material Icons and Materialize CSS -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Include piexifjs for EXIF manipulation -->
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.4/piexif.min.js"></script>
  <style>
    /* Basic layout */
    html, body { margin: 0; padding: 0; width: 100vw; font-family: Arial, sans-serif; }
    .container { width: 100vw; padding: 10px; box-sizing: border-box; text-align: left; }
    h5, label, p { text-align: left; }
    input, textarea { width: 100%; box-sizing: border-box; }
    
    /* --- Wrap Listing Description and File Drop Zones --- */
    #descriptionAndFileUploadContainer { display: flex; align-items: center; }
    .listing-desc-container {
      position: relative;
      display: inline-block;
      width: 500px;
    }
    .listing-desc-container h5 {
      margin: 0 0 10px 0;
      font-size: 1.2rem;
      font-weight: 500;
    }
    .listing-desc-container label.section-heading { 
      font-size: 1.2rem; 
      font-weight: 500; 
    }
    .listing-desc-container input {
      width: 500px;
      height: 30px;
      border: 1px solid #000;
      padding: 5px;
    }
    /* "User Provided Search Key Phrases" textarea */
    #searchKeyPhrases {
      resize: none;
      box-sizing: border-box;
      border: 1px solid grey;
    }
    #searchKeyPhrases[rows="14"] { height: auto; }
    .flex-container { display: flex; gap: 10px; align-items: stretch; }
    .textbox-container { flex: 1; }
    .textbox-container textarea { width: 100%; padding: 0.8rem; font-size: 1rem; line-height: 1.2; resize: none; overflow: visible; box-sizing: border-box; }
    .button-container { width: 200px; display: flex; flex-direction: column; gap: 10px; align-self: flex-start; }
    #listingTitle { min-height: 45px; }
    #listingDescInput { width: 500px; height: 30px; border: 1px solid #000; padding: 5px; }
    #listingDescription { min-height: 150px; }
    .section-heading { font-size: 1.2rem; font-weight: 500; margin-bottom: 5px; display: inline-block; }
    .count-text { font-style: italic; font-size: 0.9em; margin-top: 5px; }
    
    /* Drag and Drop Boxes */
    #dropZone, #ordersDropZone, #listingsDropZone {
      width: 138px; 
      height: 138px; 
      border: 2px dashed #ccc; 
      border-radius: 3px; 
      display: inline-block; 
      vertical-align: middle; 
      text-align: center; 
      line-height: 138px;
      position: relative;
    }
    /* Orders container */
    #ordersContainer { display: flex; flex-direction: column; }
    /* CSV Progress Bar */
    #csvProgressBar {
      width: 100%; height: 20px; border: 1px solid blue; background-color: #e0f0ff; margin-top: 5px;
      -webkit-appearance: none; appearance: none;
    }
    #csvProgressBar::-webkit-progress-bar { background-color: #e0f0ff; border: 1px solid blue; }
    #csvProgressBar::-webkit-progress-value { background-color: blue; }
    #csvProgressContainer { margin-left: 85px; }
    /* File Drop Zones container */
    #fileDropZonesContainer { display: flex; gap: 10px; margin-left: 100px; }
    #uploadedFilesList {
      width: 300px;
      height: 125px;
      resize: none;
      box-sizing: border-box;
      border: 1px solid grey;
      margin-left: 85px;
    }
    
    /* Primary Preview – clickable for cropping */
    #primaryPreview { 
      width: 138px; 
      height: 138px; 
      border: 1px solid #ccc; 
      border-radius: 3px;
      display: inline-block; 
      vertical-align: middle; 
      position: relative;
      top: -250px;
      left: 285px;
      text-align: center; 
      overflow: hidden; 
      cursor: pointer;
    }
    #primaryPreview:empty { background: #fff; }
    #primaryPreview img { width: 100%; height: 100%; object-fit: contain; border-radius: 3px; }
    
    /* Preview Grid */
    #previewGridContainer {
      position: relative;
      margin: 20px auto;
      width: auto;
      max-width: 600px;
      text-align: center;
    }
    #previewGrid {
      display: grid;
      grid-template-columns: repeat(5, 100px);
      grid-column-gap: 23px;
      grid-row-gap: 18px;
      margin: 0 auto;
    }
    .preview-cell { position: relative; display: flex; flex-direction: column; align-items: center; }
    .resolution-text { position: absolute; top: -12px; left: 0; right: 0; font-size: 8px; text-align: center; color: #333; pointer-events: none; }
    .preview-box {
      width: 100px; 
      height: 132px; 
      background-color: #fff; 
      border: 2px solid #ccc; 
      border-radius: 3px;
      box-sizing: border-box; 
      position: relative; 
      overflow: visible;
    }
    .preview-box img { 
      width: 100px; 
      height: 100px; 
      object-fit: cover; 
      border-radius: 3px; 
      display: block; 
    }
    .overlay { 
      position: absolute; 
      top: 0; left: 0; 
      width: 100px; height: 100px; 
      background-color: rgba(0,0,255,0.3);
      opacity: 0; transition: opacity 0.2s ease; 
      pointer-events: none; 
      z-index: 1; 
    }
    .preview-box.dragover .overlay { opacity: 1; }
    .preview-box progress { width: 100%; height: 13px; margin-top: 2px; }
    .status-icon { position: absolute; bottom: 2px; left: 2px; font-size: 14px; font-weight: bold; z-index: 3; }
    .status-icon.success { color: green; }
    .status-icon.error { color: red; }
    .remove-btn { 
      position: absolute; top: -5px; left: -5px; 
      width: 10px; height: 10px; 
      background-color: black;
      color: white; font-size: 8px; line-height: 10px; 
      text-align: center; cursor: pointer; 
      z-index: 999; border-radius: 3px; 
    }
    .number-overlay { 
      position: absolute; top: 0; right: 0; 
      width: 16px; height: 16px; 
      background-color: rgba(0,0,0,0.7);
      color: white; display: flex; align-items: center; 
      justify-content: center; font-size: 10px; 
      z-index: 999; border-radius: 3px; 
    }
    .file-name { text-align: center; font-size: 12px; margin-top: 4px; white-space: pre-line; }
    
    /* Container #13 */
    #container13 { position: relative; width: 250px; top: -150px; }
    
    /* Components below search key phrases */
    #belowSearch { margin-top: -180px; margin-left: 10px; }
    .title-container { margin-top: -50px; }
    .description-container { margin-top: 0px; }
    #analyzeMetadataBtn { margin-left: 50px; }
    #showAnalyzeRulesBtn { margin-top: 25px; }
    .phrases-header { position: relative; top: 125px; left: 10px; }
    
    /* Modal styles */
    .modal { display: none; }
    .modal-content { padding: 20px; }
    .modal textarea { width: 100%; height: 300px; resize: none; }
    
    /* Additional widths for Etsy Link and Shop Listings */
    #etsyLink, #shopListings { width: 500px !important; }
    
    /* Styles for the Upload to Etsy button container at the bottom center */
    #uploadContainer {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: inline-block;
    }
  </style>
</head>
<body>
  <!-- Configure Buttons control -->
  <button id="configureButtonsBtn" class="btn waves-effect waves-light configurable">Configure Buttons</button>
  
  <!-- Wrap Listing Description and File Drop Zones -->
  <div id="descriptionAndFileUploadContainer">
    <div class="listing-desc-container" id="listingDescContainer">
      <h5>Listing Description</h5>
      <input id="listingDescInput" type="text" placeholder="Enter your question here">
    </div>
    <div id="fileDropZonesContainer">
      <div id="ordersContainer">
        <div id="ordersDropZone">Etsy Sold Orders</div>
        <div id="csvProgressContainer">
          <progress id="csvProgressBar" max="100" value="0"></progress>
        </div>
      </div>
      <div id="listingsDropZone">Etsy Listings</div>
      <textarea id="uploadedFilesList" class="materialize-textarea" rows="2" placeholder="Uploaded .csv, .doc, .docx files will appear here"></textarea>
    </div>
  </div>
  
  <!-- Etsy OAuth and Shop Listings Section -->
  <button id="connectEtsyBtn" class="btn waves-effect waves-light configurable">Connect to Etsy</button>
  <div style="margin-top: -180px; margin-left: 10px;">
    <div class="section-heading configurable">My Etsy Shop Listings</div>
    <div class="textbox-container configurable">
      <textarea id="shopListings" class="materialize-textarea"></textarea>
    </div>
  </div>
  
  <!-- Etsy Listing Generator UI -->
  <div class="phrases-header configurable" style="position: relative; top: 125px; left: 10px;">
    <span class="section-heading configurable">2. User Provided Search Key Phrases</span>
    <button id="clearKeyPhrasesBtn" class="btn-small waves-effect waves-light configurable">Clear</button>
    <button id="copyKeyPhrasesBtn" class="btn-small waves-effect waves-light configurable">Copy</button>
    <div id="dropZone" class="configurable">Drop Image Here</div>
    <div id="primaryPreview" class="configurable"></div>
    <button id="analyzeMetadataBtn" class="btn waves-effect waves-light configurable">Analyze Photos</button>
    <button id="showAnalyzeRulesBtn" class="btn waves-effect waves-light configurable" data-target="analyzeRulesModal" style="margin-top:25px;">Analyze Rules</button>
  </div>
  <div id="container13" class="flex-container configurable">
    <div class="textbox-container configurable">
      <textarea id="searchKeyPhrases" class="materialize-textarea" rows="14"></textarea>
    </div>
  </div>
  
  <!-- Components below Search Key Phrases -->
  <div id="belowSearch">
    <button id="generateBtn" class="btn waves-effect waves-light configurable">Generate</button>
    <div class="title-container" style="margin-top: -50px;">
      <div class="section-heading configurable">Etsy Listing TITLE</div>
      <div class="flex-container configurable">
        <div class="textbox-container configurable">
          <textarea id="listingTitle" class="materialize-textarea" rows="2"></textarea>
        </div>
        <div class="button-container configurable" style="margin-top: -60px;">
          <button id="regenTitleBtn" class="btn-small waves-effect waves-light configurable">Re-Generate</button>
          <button id="copyTitleBtn" class="btn-small waves-effect waves-light configurable">
            <i class="material-icons">content_copy</i>
          </button>
        </div>
        <button id="showTitleRulesBtn" class="btn waves-effect waves-light rules-button configurable" data-target="titleRulesModal">Title Rules</button>
      </div>
      <p id="titleCount" class="count-text configurable">Count: 0</p>
    </div>
    <div class="description-container" style="margin-top: 0px;">
      <div class="section-heading configurable">Etsy Listing DESCRIPTION</div>
      <div class="flex-container configurable">
        <div class="textbox-container configurable">
          <textarea id="listingDescription" class="materialize-textarea"></textarea>
        </div>
        <div class="button-container configurable">
          <button id="regenDescriptionBtn" class="btn-small waves-effect waves-light configurable">Re-Generate</button>
          <button id="copyDescriptionBtn" class="btn-small waves-effect waves-light configurable">
            <i class="material-icons">content_copy</i>
          </button>
        </div>
        <button id="showDescriptionRulesBtn" class="btn waves-effect waves-light rules-button configurable" data-target="descriptionRulesModal">Description Rules</button>
      </div>
    </div>
  </div>
  
  <!-- Preview Grid Container -->
  <div id="previewGridContainer">
    <div id="previewGrid"></div>
  </div>
  
  <!-- Upload to Etsy button container -->
  <div id="uploadContainer">
    <button id="uploadToEtsyBtn" class="btn waves-effect waves-light configurable">Upload to Etsy</button>
  </div>
  
  <!-- Modals -->
  <!-- Title Rules Modal -->
  <div id="titleRulesModal" class="modal">
    <div class="modal-content">
      <h4>Title Rules</h4>
      <textarea id="titleRulesTextarea">
Title Structure & Formatting:
- Create 5-7 SEO optimized long-tail key phrases (3-5 words each).
- The title must begin with the product type (e.g., "Angel Earrings", "Daisy Necklace").
- Ensure grammatical flow and no punctuation.
- If the product is a charm/pendant, the first word should describe that type.
- For necklaces, the second word must be "necklace"; for earrings, "Earring".

Word Usage & Frequency:
- No word may appear more than three times.
- "earrings" must be plural and follow a noun.
- "stud" may only appear in approved phrases and must precede "earrings".

Required Words:
- "Charm" must appear exactly once.

Use of "For":
- "for" must appear at least twice in a grammatically correct manner.

Title Length & Word Order:
- Titles must be between 125 and 140 characters.
- Adjectives must follow nouns.
- Avoid plurals for "stud" and "animal"; use plurals for "hoops" and "earrings" correctly.

SEO Optimization:
- The title’s word order should form at least eight natural SEO phrases.

Prohibited Words:
- Exclude: "accessories", "unique", "simple", "minimalist", "whimsical", "cute", "filled", "gold filled", "silver", "solid gold", "gold vermeil", "rosegold", "14k", "handmade", "quirky", "delicate", "accessory", "for", "dangle", "gold plated", "jewelry", "custom", "celestial", "design", "lightweight".
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateTitleRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Description Rules Modal -->
  <div id="descriptionRulesModal" class="modal">
    <div class="modal-content">
      <h4>Description Rules</h4>
      <textarea id="descriptionRulesTextarea">
Rules for Description:
- Merge the key phrases with your output.
- Modify the description to match the jewelry type.
- Keep the output paragraph to 80 words.

Option 1:
"This stunning gold Playing Card Charm is the perfect gift for her, featuring an intricately designed Ace of Spades charm. Ideal for jewelry lovers, this pendant is perfect for personalized pieces."

Option 2:
"This playful Allosaurus charm is the perfect add-on for charm necklaces or huggie hoops. It adds a whimsical touch to any collection, making it a delightful gift."

Option 3:
"This charming gold Alligator Necklace is a delightful gift for animal lovers. Featuring a beautifully designed crocodile pendant, it adds a unique touch to any collection."
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateDescriptionRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Analyze Rules Modal -->
  <div id="analyzeRulesModal" class="modal">
    <div class="modal-content">
      <h4>Photo Analysis Rules</h4>
      <textarea id="analyzeRulesTextarea">
Default Photo Analysis Rules:
1. Use SEO-friendly descriptive long-tail key phrases without special characters.
2. Emphasize charm details (what it is, occasion, metal, size, style).
3. Focus solely on the jewelry details in the image.
4. Ignore environment, model, and clothing.
5. Organize into a short paragraph.
6. Limit the description to 300 characters.
7. Do not mention earrings unless explicitly identified.
8. Do not mix necklace and earring descriptions.
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateAnalyzeRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Keyword Rules Modal -->
  <div id="keywordRulesModal" class="modal">
    <div class="modal-content">
      <h4>Keyword Rules</h4>
      <textarea id="keywordRulesTextarea">
Using Sales Report and Product List Files:
- Extrapolate the best tag phrases based on performance.
- Focus on key terms like "Necklace", "Earrings", "Studs", "Hoops".
- Emphasize sales success; higher performing listings have more valuable keywords.
- Generate exactly 13 tag phrases, each ≤ 20 characters.
- Include "Gift for Her".
- "Charm" must appear at least once in a multi-word phrase (max 4 times total).
- "Necklace" appears no more than 3 times, "Gift" no more than 3 times, "Lover" no more than 2 times.
- Exclude: "Gift for Him", "Statement Piece", "Unique", "Spiritual Gift", "Outdoor Style", "accessories", "simple", "minimalist", "whimsical", "cute", "filled", "gold filled", "silver", "solid gold", "gold vermeil", "rosegold", "14k", "handmade", "quirky", "delicate", "accessory", "for", "dangle", "gold plated", "jewelry", "custom", "celestial", "design", "lightweight", "Fine Chain Necklace", "Small", "Large", "Nice", "Long", "Dark", "Short", "and", "but", "light", "heavy", "Wanderlust", "Theme", "Minimal Chain Gift", "Tiny Pendant Chain", "Charm Look", "Charm Wear", "Chain Necklace", "Small Pendant Chain", "Everyday"
      </textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="updateKeywordRulesBtn" class="modal-close waves-effect waves-green btn">Update</a>
    </div>
  </div>
  
  <!-- Button Config Modal -->
  <div id="buttonConfigModal" class="modal">
    <div class="modal-content">
      <h4>Configure Button Positions</h4>
      <div id="buttonConfigContainer"></div>
      <textarea id="uploadedFilesListModal" class="materialize-textarea" rows="2" placeholder="Uploaded files will appear here"></textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="saveButtonPositionsBtn" class="modal-close waves-effect waves-green btn">Save Positions</a>
    </div>
  </div>
  
  <!-- Metadata Modal -->
  <div id="metadataModal" class="modal">
    <div class="modal-content">
      <h4>Photo Metadata</h4>
      <textarea id="metadataTextarea" readonly></textarea>
    </div>
    <div class="modal-footer">
      <a href="#!" id="closeMetadataBtn" class="modal-close waves-effect waves-green btn">Close</a>
    </div>
  </div>
  
  <!-- Crop Modal -->
  <div id="photoCropModal" class="modal">
    <div class="crop-container">
      <h4 style="text-align:center; margin: 0 0 10px 0;">Crop Photo</h4>
      <div class="img-container">
        <img id="cropImage" src="" alt="Crop Image">
      </div>
      <div class="controls">
        <label for="zoomSlider">Zoom:</label>
        <input type="range" id="zoomSlider" min="0.1" max="3" step="0.01" value="1">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <button id="saveCropBtn" class="btn waves-effect waves-light">Save</button>
        <button id="cancelCropBtn" class="btn waves-effect waves-light" style="background-color:#f44336; margin-left:10px;">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Include jQuery and Materialize JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  
  <script>
    // Global variable declarations
    const ETSY_SHOP_URL = "https://www.etsy.com/shop/custombrites";
    const CLIENT_ID = "k75zdspz4r99txpqdji7i2em";
    const REDIRECT_URI = "https://delicate-tanuki-616ac0.netlify.app/";
    const SHOP_ID = "YOUR_ASSISTANT_ID"; // Not used; kept for legacy reference.
    const modelName = "chatgpt-4o-latest";
    let accessToken;
    
    // Global variables for file uploads and previews
    let soldOrdersCSV = [];
    let listingsCSV = [];
    let photoNames = [];
    let previewImages = [];
    let photoStatuses = [];
    let photoMeta = [];
    let photoObjects = [];
    
    // Proxy OpenAI calls through our Netlify function
    async function callOpenAI(payload) {
      const response = await fetch("/.netlify/functions/openaiProxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error("API Error: " + (errorData.error ? errorData.error.message : response.statusText));
      }
      return await response.json();
    }
    
    // File upload functions using our Netlify function "uploadFile"
    async function uploadCSVFile(file, progressCallback) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const dataURL = event.target.result;
            const base64Content = dataURL.split(',')[1];
            if (!base64Content) throw new Error("File content is empty.");
            const payload = {
              file: base64Content,
              fileName: file.name,
              purpose: "user_data"
            };
            const response = await fetch("/.netlify/functions/uploadFile", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error("Upload failed with status " + response.status);
            const responseData = await response.json();
            resolve({ id: responseData.id, name: file.name });
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    async function uploadDocFile(file, progressCallback) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const dataURL = event.target.result;
            const base64Content = dataURL.split(',')[1];
            if (!base64Content) throw new Error("File content is empty.");
            const payload = {
              file: base64Content,
              fileName: file.name,
              purpose: "user_data"
            };
            const response = await fetch("/.netlify/functions/uploadFile", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error("Upload failed with status " + response.status);
            const responseData = await response.json();
            resolve({ id: responseData.id, name: file.name });
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    // PKCE Utility Functions
    function generateRandomString(length) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      let text = '';
      for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      }
      return text;
    }
    function base64urlEncode(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }
    async function generateCodeChallenge(codeVerifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return base64urlEncode(digest);
    }
    
    // OAuth Flow for Etsy
    document.getElementById("connectEtsyBtn").addEventListener("click", async () => {
      const state = "randomState123";
      const scope = "listings_w listings_r";
      const codeVerifier = generateRandomString(64);
      localStorage.setItem("etsy_code_verifier", codeVerifier);
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const etsyAuthUrl = `https://www.etsy.com/oauth/connect?response_type=code&client_id=${CLIENT_ID}` +
        `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
        `&scope=${encodeURIComponent(scope)}` +
        `&state=${state}` +
        `&code_challenge=${encodeURIComponent(codeChallenge)}` +
        `&code_challenge_method=S256`;
      window.location.href = etsyAuthUrl;
    });
    
    document.addEventListener("DOMContentLoaded", () => {
      loadButtonPositions();
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");
      if (code) {
        exchangeCodeForToken(code);
        window.history.replaceState({}, document.title, REDIRECT_URI);
      }
      renderPreviewGrid();
      updateUploadedFilesList();
    });
    
    async function exchangeCodeForToken(code) {
      const codeVerifier = localStorage.getItem("etsy_code_verifier");
      if (!codeVerifier) {
        M.toast({ html: "No code verifier found. Please try connecting again." });
        return;
      }
      try {
        const response = await fetch(`/.netlify/functions/exchangeToken?code=${encodeURIComponent(code)}&code_verifier=${encodeURIComponent(codeVerifier)}`);
        const tokenData = await response.json();
        if (tokenData.access_token) {
          accessToken = tokenData.access_token;
          M.toast({ html: "Connected to Etsy!" });
        } else {
          M.toast({ html: "Error obtaining token: " + JSON.stringify(tokenData) });
        }
      } catch (error) {
        console.error("Error exchanging code:", error);
        M.toast({ html: "Error exchanging code for token" });
      }
    }
    
    async function duplicateListing() {
      let listingLink = document.getElementById("shopListings").value.trim();
      if (!listingLink) {
        M.toast({ html: "Please provide a listing link in 'My Etsy Shop Listings'" });
        return;
      }
      let listingIdMatch = listingLink.match(/\/listing\/(\d+)/);
      if (!listingIdMatch) {
        M.toast({ html: "Invalid listing link. Please provide a valid Etsy listing URL." });
        return;
      }
      let listingId = listingIdMatch[1];
      if (!accessToken) {
        M.toast({ html: "No access token. Please connect to Etsy first." });
        return;
      }
      try {
        // Proxy the duplicate listing call through our Netlify function
        const duplicateUrl = `/.netlify/functions/etsyDuplicateListing?listingId=${listingId}&token=${encodeURIComponent(accessToken)}`;
        console.log("Calling duplicate listing URL:", duplicateUrl);
        let response = await fetch(duplicateUrl);
        console.log("Response status:", response.status, response.statusText);
        if (!response.ok) {
          let errorText = await response.text();
          console.error("Error duplicating listing. Status:", response.status, "Text:", errorText);
          throw new Error(`Error duplicating listing: ${response.status} - ${response.statusText}`);
        }
        let data = await response.json();
        console.log("Duplicate listing response data:", data);
        M.toast({ html: "Listing duplicated as Draft successfully!" });
      } catch (e) {
        console.error("Error in duplicateListing function:", e);
        M.toast({ html: "Error duplicating listing: " + e.message });
      }
    }
    
    document.getElementById("uploadToEtsyBtn").addEventListener("click", duplicateListing);
    
    document.getElementById("clearKeyPhrasesBtn").addEventListener("click", () => {
      document.getElementById("searchKeyPhrases").value = "";
    });
    
    // File Drop and Upload Handlers
    const dropZone = document.getElementById("dropZone");
    const previewGrid = document.getElementById("previewGrid");
    const primaryPreview = document.getElementById("primaryPreview");
    
    function updatePrimaryPreview() {
      if (previewImages.length > 0) {
        primaryPreview.innerHTML = `<img src="${previewImages[0]}" alt="Primary Preview">`;
      } else {
        primaryPreview.innerHTML = "";
      }
    }
    
    primaryPreview.addEventListener("click", function() {
      if (previewImages.length > 0) {
        document.getElementById("cropImage").src = previewImages[0];
        let cropModalElem = document.getElementById("photoCropModal");
        let cropModalInstance = M.Modal.getInstance(cropModalElem) || M.Modal.init(cropModalElem, { preventScrolling: false });
        cropModalInstance.open();
      }
    });
    
    dropZone.addEventListener("dragover", e => { 
      e.preventDefault(); 
      e.stopPropagation(); 
      dropZone.style.borderColor = "#000"; 
    });
    dropZone.addEventListener("dragleave", e => { 
      e.preventDefault(); 
      e.stopPropagation(); 
      dropZone.style.borderColor = "#ccc"; 
    });
    dropZone.addEventListener("drop", async e => {
      e.preventDefault(); 
      e.stopPropagation(); 
      dropZone.style.borderColor = "#ccc";
      const files = e.dataTransfer.files;
      if (files.length > 10) alert("Maximum 10 images allowed.");
      for (let i = 0; i < Math.min(files.length, 10); i++) {
        const file = files[i];
        if (file.type === "image/jpeg" || file.type === "image/png") {
          try {
            const dataURL = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = event => resolve(event.target.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            previewImages.push(dataURL);
            photoStatuses.push(null);
            photoMeta.push(null);
            photoNames.push(file.name);
            updatePrimaryPreview();
            renderPreviewGrid();
            updateUploadedFilesList();
          } catch (err) {
            console.error("Error processing image:", err);
          }
        } else {
          M.toast({ html: "Only JPEG images are supported for metadata embedding." });
        }
      }
    });
    
    const ordersDropZone = document.getElementById("ordersDropZone");
    ordersDropZone.addEventListener("dragover", e => { 
      e.preventDefault(); 
      e.stopPropagation(); 
      ordersDropZone.style.borderColor = "#000"; 
    });
    ordersDropZone.addEventListener("dragleave", e => { 
      e.preventDefault(); 
      e.stopPropagation(); 
      ordersDropZone.style.borderColor = "#ccc"; 
    });
    ordersDropZone.addEventListener("drop", async e => {
      e.preventDefault(); 
      e.stopPropagation(); 
      ordersDropZone.style.borderColor = "#ccc";
      const files = e.dataTransfer.files;
      const progressBar = document.getElementById("csvProgressBar");
      for (let i = 0; i < files.length; i++) {
         let file = files[i];
         const fileName = file.name.toLowerCase();
         if (fileName.endsWith(".csv") || fileName.endsWith(".doc") || fileName.endsWith(".docx")) {
            try {
              let fileData;
              if (fileName.endsWith(".csv")) {
                 fileData = await uploadCSVFile(file, percent => { progressBar.value = percent; });
              } else {
                 fileData = await uploadDocFile(file, percent => { progressBar.value = percent; });
              }
              progressBar.value = 0;
              soldOrdersCSV.push(fileData);
              updateUploadedFilesList();
              await updateVectorStore();
            } catch(err) {
              console.error("Error uploading file:", err);
            }
         } else {
            alert("Only .csv, .doc, and .docx files are supported for Etsy Sold Orders.");
         }
      }
    });
    
    const listingsDropZone = document.getElementById("listingsDropZone");
    listingsDropZone.addEventListener("dragover", e => { 
      e.preventDefault(); 
      e.stopPropagation(); 
      listingsDropZone.style.borderColor = "#000"; 
    });
    listingsDropZone.addEventListener("dragleave", e => { 
      e.preventDefault(); 
      e.stopPropagation(); 
      listingsDropZone.style.borderColor = "#ccc"; 
    });
    listingsDropZone.addEventListener("drop", async e => {
      e.preventDefault(); 
      e.stopPropagation(); 
      listingsDropZone.style.borderColor = "#ccc";
      const files = e.dataTransfer.files;
      const progressBar = document.getElementById("csvProgressBar");
      for (let i = 0; i < files.length; i++) {
         let file = files[i];
         const fileName = file.name.toLowerCase();
         if (fileName.endsWith(".csv") || fileName.endsWith(".doc") || fileName.endsWith(".docx")) {
            try {
              let fileData;
              if (fileName.endsWith(".csv")) {
                 fileData = await uploadCSVFile(file, percent => { progressBar.value = percent; });
              } else {
                 fileData = await uploadDocFile(file, percent => { progressBar.value = percent; });
              }
              progressBar.value = 0;
              listingsCSV.push(fileData);
              updateUploadedFilesList();
              await updateVectorStore();
            } catch(err) {
              console.error("Error uploading file:", err);
            }
         } else {
            alert("Only .csv, .doc, and .docx files are supported for Etsy Listings.");
         }
      }
    });
    
    async function updateVectorStore() {
      const allFileIds = [...soldOrdersCSV, ...listingsCSV].map(file => file.id);
      if (allFileIds.length === 0) {
        console.log("No supported files uploaded yet.");
        return;
      }
      try {
        const vectorStorePayload = { name: "CSV Vector Store", file_ids: allFileIds };
        const vectorStoreResponse = await fetch("/.netlify/functions/vectorStore", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(vectorStorePayload)
        });
        if (!vectorStoreResponse.ok) {
          const errorData = await vectorStoreResponse.json();
          throw new Error("Error creating vector store: " + JSON.stringify(errorData));
        }
        const vectorStoreData = await vectorStoreResponse.json();
        console.log("Vector store created:", vectorStoreData);
      } catch (err) {
        console.error("Error in updateVectorStore:", err);
      }
    }
    
    function updateUploadedFilesList() {
      let fileList = [];
      soldOrdersCSV.forEach(file => fileList.push(file.name));
      listingsCSV.forEach(file => fileList.push(file.name));
      document.getElementById("uploadedFilesList").value = fileList.join("\n");
    }
    
    // ----- UI Position Persistence & Live Preview for Configure Buttons -----
    document.getElementById("configureButtonsBtn").addEventListener("click", function() {
      var configContainer = document.getElementById("buttonConfigContainer");
      configContainer.innerHTML = "";
      var selectors = "button:not(#configureButtonsBtn), #listingDescContainer, #ordersDropZone, #listingsDropZone, #dropZone, #csvProgressContainer, #previewGridContainer, #primaryPreview, #container13, #uploadedFilesList";
      var elements = document.querySelectorAll(selectors);
      var table = document.createElement("table");
      table.className = "striped";
      var thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>Element ID</th><th>Top (px)</th><th>Left (px)</th></tr>";
      table.appendChild(thead);
      var tbody = document.createElement("tbody");
      elements.forEach(function(el) {
        var id = el.id;
        var computedStyle = window.getComputedStyle(el);
        var currentTop = el.style.top || computedStyle.top || "0";
        var currentLeft = el.style.left || computedStyle.left || "0";
        var tr = document.createElement("tr");
        tr.innerHTML = `<td>${id}</td>
                        <td><input type="number" id="${id}_top" value="${parseInt(currentTop)||0}"></td>
                        <td><input type="number" id="${id}_left" value="${parseInt(currentLeft)||0}"></td>`;
        var topInput = tr.querySelector(`#${id}_top`);
        var leftInput = tr.querySelector(`#${id}_left`);
        topInput.addEventListener("input", function() { el.style.top = topInput.value + "px"; });
        leftInput.addEventListener("input", function() { el.style.left = leftInput.value + "px"; });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      configContainer.appendChild(table);
      var modalElem = document.getElementById("buttonConfigModal");
      var modalInstance = M.Modal.getInstance(modalElem) || M.Modal.init(modalElem, { preventScrolling: false });
      modalInstance.open();
    });
    
    document.getElementById("saveButtonPositionsBtn").addEventListener("click", function() {
      var selectors = "button:not(#configureButtonsBtn), #listingDescContainer, #ordersDropZone, #listingsDropZone, #dropZone, #csvProgressContainer, #previewGridContainer, #primaryPreview, #container13, #uploadedFilesList";
      var elements = document.querySelectorAll(selectors);
      var positions = {};
      elements.forEach(function(el) {
        positions[el.id] = { top: el.style.top || "0px", left: el.style.left || "0px" };
      });
      localStorage.setItem("buttonPositions", JSON.stringify(positions));
      M.toast({ html: "Button positions saved." });
    });
    
    function loadButtonPositions() {
      var stored = localStorage.getItem("buttonPositions");
      if (stored) {
        var positions = JSON.parse(stored);
        for (var id in positions) {
          var el = document.getElementById(id);
          if (el) {
            el.style.top = positions[id].top;
            el.style.left = positions[id].left;
          }
        }
      }
    }
    // -------------------------------------------------------------------------
    
    // Utility: Strip Markdown formatting from JSON responses.
    function stripMarkdownJSON(text) {
      return text.replace(/^```json\s*/, "").replace(/\s*```$/, "").trim();
    }
    
    function updateTitleCount(text) {
      document.getElementById("titleCount").textContent = "Count: " + text.length;
    }
    
    async function generateBoth() {
      await Promise.all([generateTitleOnly(), generateDescriptionOnly()]);
      const titleEl = document.getElementById("listingTitle");
      const descEl = document.getElementById("listingDescription");
      console.log("Generate Output:", { title: titleEl.value, description: descEl.value });
    }
    
    async function generateTitleOnly() {
      const etsyLink = ETSY_SHOP_URL;
      const keyPhrases = document.getElementById("searchKeyPhrases").value.trim();
      if (!keyPhrases) {
        M.toast({ html: "Please provide the search key phrases." });
        return;
      }
      const promptText = `
You are ChatGPT using ${modelName}.
Based on the inputs below, generate an Etsy Listing TITLE only.
Input Context:
Etsy Link: "${etsyLink}"
Search Key Phrases: "${keyPhrases}"
--- Rules for TITLE ---
${stripMarkdownJSON(document.getElementById("titleRulesTextarea").value)}
Important: Return ONLY the title as plain text.`;
      document.getElementById("listingTitle").value = "Generating title...";
      const payload = {
        model: modelName,
        messages: [
          { role: "system", content: "Return ONLY the title as plain text." },
          { role: "user", content: promptText }
        ],
        temperature: 0.7
      };
      try {
        const data = await callOpenAI(payload);
        if (data.choices && data.choices.length > 0) {
          let output = stripMarkdownJSON(data.choices[0].message.content);
          document.getElementById("listingTitle").value = output || "No title generated.";
          updateTitleCount(output);
        } else {
          document.getElementById("listingTitle").value = "No title generated.";
        }
      } catch (error) {
        document.getElementById("listingTitle").value = "Error: " + error;
      }
    }
    
    async function generateDescriptionOnly() {
      const etsyLink = ETSY_SHOP_URL;
      const keyPhrases = document.getElementById("searchKeyPhrases").value.trim();
      if (!keyPhrases) {
        M.toast({ html: "Please provide the search key phrases." });
        return;
      }
      const promptText = `
You are ChatGPT using ${modelName}.
Based on the inputs below, generate an Etsy Listing DESCRIPTION only.
Input Context:
Etsy Link: "${etsyLink}"
Search Key Phrases: "${keyPhrases}"
--- Rules for DESCRIPTION ---
${stripMarkdownJSON(document.getElementById("descriptionRulesTextarea").value)}
Important: Return ONLY the description as plain text.`;
      document.getElementById("listingDescription").value = "Generating description...";
      const payload = {
        model: modelName,
        messages: [
          { role: "system", content: "Return ONLY the description as plain text." },
          { role: "user", content: promptText }
        ],
        temperature: 0.7
      };
      try {
        const data = await callOpenAI(payload);
        if (data.choices && data.choices.length > 0) {
          let output = stripMarkdownJSON(data.choices[0].message.content);
          document.getElementById("listingDescription").value = output || "No description generated.";
        } else {
          document.getElementById("listingDescription").value = "No description generated.";
        }
      } catch (error) {
        document.getElementById("listingDescription").value = "Error: " + error;
      }
    }
    
    async function generateTagPhrases() {
      let question = document.getElementById("listingDescInput").value;
      if (!question.trim()) {
        M.toast({ html: "Please enter a question in the Listing Description." });
        return;
      }
      let extraText = "Emphasis on SEO friendliness with a focus on generating effective long tail tag phrases for Etsy.";
      const keywordRules = stripMarkdownJSON(document.getElementById("keywordRulesTextarea").value);
      let prompt = `
Listing Description (for emphasis): "${question}"
${extraText}

Keyword Rules:
${keywordRules}

Using Sales Report and Product List Files, generate exactly 13 tag phrases (each ≤ 20 characters).
Include "Gift for Her", ensure "Charm" appears at least once in a multi-word phrase (max 4 times total),
"Necklace" appears no more than 3 times, "Gift" no more than 3 times, "Lover" no more than 2 times,
and exclude prohibited words.
Return your answer as plain text.`;
      try {
        const payload = {
          model: modelName,
          messages: [
            { role: "system", content: "Generate tag phrases according to the provided rules." },
            { role: "user", content: prompt }
          ],
          temperature: 0.7,
          max_tokens: 500
        };
        const data = await callOpenAI(payload);
        let answer = data.choices[0].message.content;
        let phrases = answer.split(/[\n,]+/)
          .map(s => s.replace(/^\d+\.\s*/, "").trim())
          .join("\n");
        document.getElementById("searchKeyPhrases").value = phrases;
      } catch (err) {
        console.error("Error generating tag phrases:", err);
        M.toast({ html: "Error generating tag phrases: " + err.message });
      }
    }
    
    document.getElementById("listingDescInput").addEventListener("keydown", async function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        await generateTagPhrases();
        await delay(100);
        await processKeyPhrases();
      }
    });
    
    async function processKeyPhrases() {
      let keyText = document.getElementById("searchKeyPhrases").value;
      let phrases = keyText.split(/\n+/).map(phrase => phrase.trim()).filter(phrase => phrase !== "");
      let processedPhrases = [];
      for (let phrase of phrases) {
        while (phrase.length > 20) {
          try {
            const altPayload = {
              model: modelName,
              messages: [
                { role: "system", content: "Generate an alternate key phrase that is ≤ 20 characters." },
                { role: "user", content: phrase }
              ],
              temperature: 0.7,
              max_tokens: 20
            };
            const altData = await callOpenAI(altPayload);
            phrase = stripMarkdownJSON(altData.choices[0].message.content).trim();
          } catch (error) {
            break;
          }
          await delay(50);
        }
        while (processedPhrases.includes(phrase)) {
          try {
            const dupPayload = {
              model: modelName,
              messages: [
                { role: "system", content: "Generate a unique key phrase that is ≤ 20 characters." },
                { role: "user", content: phrase }
              ],
              temperature: 0.7,
              max_tokens: 20
            };
            const dupData = await callOpenAI(dupPayload);
            phrase = stripMarkdownJSON(dupData.choices[0].message.content).trim();
          } catch (error) {
            break;
          }
          await delay(50);
        }
        processedPhrases.push(phrase);
      }
      document.getElementById("searchKeyPhrases").value = processedPhrases.join("\n");
    }
    
    document.getElementById("copyKeyPhrasesBtn").addEventListener("click", () => {
      const lines = document.getElementById("searchKeyPhrases").value.split(/\n+/).map(l => l.trim()).filter(l => l !== "");
      navigator.clipboard.writeText(lines.join(", ")).catch(err => console.error("Error copying key phrases: " + err));
    });
    
    document.getElementById("generateBtn").addEventListener("click", generateBoth);
    document.getElementById("regenTitleBtn").addEventListener("click", generateTitleOnly);
    document.getElementById("regenDescriptionBtn").addEventListener("click", generateDescriptionOnly);
    document.getElementById("copyTitleBtn").addEventListener("click", () => {
      navigator.clipboard.writeText(document.getElementById("listingTitle").value).catch(err => console.error("Error copying title: " + err));
    });
    document.getElementById("copyDescriptionBtn").addEventListener("click", () => {
      navigator.clipboard.writeText(document.getElementById("listingDescription").value).catch(err => console.error("Error copying description: " + err));
    });
    
    // ----- UI Position Persistence & Live Preview for Configure Buttons -----
    document.getElementById("configureButtonsBtn").addEventListener("click", function() {
      var configContainer = document.getElementById("buttonConfigContainer");
      configContainer.innerHTML = "";
      var selectors = "button:not(#configureButtonsBtn), #listingDescContainer, #ordersDropZone, #listingsDropZone, #dropZone, #csvProgressContainer, #previewGridContainer, #primaryPreview, #container13, #uploadedFilesList";
      var elements = document.querySelectorAll(selectors);
      var table = document.createElement("table");
      table.className = "striped";
      var thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>Element ID</th><th>Top (px)</th><th>Left (px)</th></tr>";
      table.appendChild(thead);
      var tbody = document.createElement("tbody");
      elements.forEach(function(el) {
        var id = el.id;
        var computedStyle = window.getComputedStyle(el);
        var currentTop = el.style.top || computedStyle.top || "0";
        var currentLeft = el.style.left || computedStyle.left || "0";
        var tr = document.createElement("tr");
        tr.innerHTML = `<td>${id}</td>
                        <td><input type="number" id="${id}_top" value="${parseInt(currentTop)||0}"></td>
                        <td><input type="number" id="${id}_left" value="${parseInt(currentLeft)||0}"></td>`;
        var topInput = tr.querySelector(`#${id}_top`);
        var leftInput = tr.querySelector(`#${id}_left`);
        topInput.addEventListener("input", function() { el.style.top = topInput.value + "px"; });
        leftInput.addEventListener("input", function() { el.style.left = leftInput.value + "px"; });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      configContainer.appendChild(table);
      var modalElem = document.getElementById("buttonConfigModal");
      var modalInstance = M.Modal.getInstance(modalElem) || M.Modal.init(modalElem, { preventScrolling: false });
      modalInstance.open();
    });
    
    document.getElementById("saveButtonPositionsBtn").addEventListener("click", function() {
      var selectors = "button:not(#configureButtonsBtn), #listingDescContainer, #ordersDropZone, #listingsDropZone, #dropZone, #csvProgressContainer, #previewGridContainer, #primaryPreview, #container13, #uploadedFilesList";
      var elements = document.querySelectorAll(selectors);
      var positions = {};
      elements.forEach(function(el) {
        positions[el.id] = { top: el.style.top || "0px", left: el.style.left || "0px" };
      });
      localStorage.setItem("buttonPositions", JSON.stringify(positions));
      M.toast({ html: "Button positions saved." });
    });
    
    function loadButtonPositions() {
      var stored = localStorage.getItem("buttonPositions");
      if (stored) {
        var positions = JSON.parse(stored);
        for (var id in positions) {
          var el = document.getElementById(id);
          if (el) {
            el.style.top = positions[id].top;
            el.style.left = positions[id].left;
          }
        }
      }
    }
    // -------------------------------------------------------------------------
    
    window.addEventListener("load", function() {
      var container13 = document.getElementById("container13");
      container13.style.height = (container13.offsetHeight * 2.5) + "px";
    });
    
    document.getElementById("listingDescInput").addEventListener("input", function() {
      document.getElementById("searchKeyPhrases").value = "";
    });
    
    // End of file
    // Utility delay function
    function delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
  </script>
</body>
</html>